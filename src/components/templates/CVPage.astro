---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import Sidebar from '@components/cv/Sidebar.astro';
import CertificationList from '@components/cv/CertificationList.astro';
import DiscoveryGrid from '@components/common/DiscoveryGrid.astro';
import CareerTimeline from '@components/cv/CareerTimeline.astro';
import SkillRadar from '@components/cv/SkillRadar';

import { getEntry } from 'astro:content';
import '@styles/cv.css';
import '@styles/print.css';

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;

// 1. UI Content
const pageEntry = await getEntry('pages', `${lang}/cv`);
if (!pageEntry) {
  throw new Error(`Could not find content for ${lang}/cv`);
}
const content = pageEntry.data;

// 2. CV Data
const cvEntry = await getEntry('cv', lang);
if (!cvEntry) throw new Error(`Missing cv entry for ${lang}`);
const cvData: any = cvEntry.data; 

// 3. Skills Data
const skillsEntry = await getEntry('skills', lang);
if (!skillsEntry) throw new Error(`Missing skills entry for ${lang}`);
const skillsData = skillsEntry.data;

// Prepare Radar Data (Professional Skills)
// We assign high values to these core competencies for the visual
const radarLabels = (skillsData.professional || []).map((s: any) => s.name.split(' ')[0]); // Shorten labels
const radarValues = (skillsData.professional || []).map(() => 9); // Default high proficiency
---

<Layout 
  title={content.title}
  description={content.description}
  bodyClass={content.bodyClass}
>
  <div class="cv-wrap">
    <!-- Filter bar (Hidden in Print) -->
    <div class="sticky top-[80px] z-[90] mb-8 flex justify-center px-4 pointer-events-none print:hidden">
      <div class="inline-flex items-center gap-2 p-1.5 bg-[#0a0a0c]/80 backdrop-blur-xl border border-glass-border rounded-2xl shadow-2xl pointer-events-auto">
        <button class="cv-filter-btn active px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-all" data-filter="all">{content.ui.filter?.all || 'All'}</button>
        <button class="cv-filter-btn px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-all text-dim hover:text-white" data-filter="tech">{content.ui.filter?.tech || 'Tech'}</button>
        
        <div class="w-px h-4 bg-white/10 mx-1"></div>
        
        <button onclick="window.print()" class="px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-all text-accent hover:text-white bg-accent/10 hover:bg-accent/20 border border-accent/20">
            <i class="fa-solid fa-print mr-2"></i> PDF
        </button>
      </div>
    </div>

    <!-- CV grid -->
    <section class="cv-grid" aria-label="CV content">

      <!-- Sidebar -->
      <Sidebar data={skillsData} ui={content.ui.sidebar} />

      <div class="cv-main">
        <!-- PROFILE ROW: Overview + Radar -->
        <Section id="profile">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <Card variant="glass" class="p-6 reveal reveal-fade md:col-span-2">
                <SectionHeading>{content.ui.headings.profile}</SectionHeading>
                {content.profile.text.map((p: string, i: number) => (
                    <p class={`text-[15px] leading-relaxed opacity-90 ${i < content.profile.text.length - 1 ? 'mb-4' : ''}`}>
                        {p}
                    </p>
                ))}
                <div class="mt-6 pt-6 border-t border-glass-border print:hidden">
                    <Button href={lang === 'da' ? '/about' : '/en/about'} variant="ghost" size="sm">
                      <i class="fa-solid fa-arrow-right mr-2 text-xs"></i>
                      {content.ui.viewAll}
                    </Button>
                </div>
              </Card>

              <!-- SKILL RADAR (New) -->
              <Card variant="glass" class="p-4 reveal reveal-fade flex flex-col items-center justify-center min-h-[300px]">
                  <h3 class="text-xs font-bold uppercase tracking-widest text-dim mb-4">Core Competencies</h3>
                  <SkillRadar client:visible labels={radarLabels} data={radarValues} label="Proficiency" />
              </Card>
          </div>
        </Section>

        <!-- EXPERIENCE (New Timeline View) -->
        <Section id="experience">
          <Card variant="glass" class="p-8 reveal reveal-slide-up">
            <SectionHeading>{content.ui.headings.experience}</SectionHeading>
            
            <div class="mt-6">
                <CareerTimeline items={cvData.experience} />
            </div>

            <div class="mt-6 pt-6 border-t border-glass-border print:hidden">
                <Button href={lang === 'da' ? '/experience' : '/en/experience'} variant="ghost" size="sm">
                  <i class="fa-solid fa-arrow-right mr-2 text-xs"></i>
                  {content.ui.viewAll}
                </Button>
            </div>
          </Card>
        </Section>

        <Section id="education">
          <Card variant="glass" class="p-8 reveal reveal-slide-up">
            <SectionHeading>{content.ui.headings.education}</SectionHeading>
            
            <div class="mt-6">
                <CareerTimeline items={cvData.education} />
            </div>

            <div class="mt-6 pt-6 border-t border-glass-border print:hidden">
                <Button href={lang === 'da' ? '/education' : '/en/education'} variant="ghost" size="sm">
                  <i class="fa-solid fa-arrow-right mr-2 text-xs"></i>
                  {content.ui.viewAll}
                </Button>
            </div>
          </Card>
        </Section>

        <Section id="projects">
          <Card variant="glass" class="p-6 reveal reveal-slide-up">
            <SectionHeading>{content.ui.headings.projects}</SectionHeading>
            <div class="space-y-0 project-list">
              {cvData.projects?.map((project: any) => (
                <article class="item cv-item transition-all duration-300" data-categories={JSON.stringify(project.categories || [])}>
                  <div class="item-head">
                    <h3 class="text-[18px] font-bold m-0 mb-1">{project.title}</h3>
                    {project.meta && <span class="text-[13px] text-dim">{project.meta}</span>}
                  </div>
                  <p class="text-[14px] text-dim mt-2 opacity-80">
                    {project.description}
                  </p>
                </article>
              ))}
            </div>
            <div class="mt-6 pt-6 border-t border-glass-border print:hidden">
                <Button href={lang === 'da' ? '/portfolio' : '/en/portfolio'} variant="ghost" size="sm">
                  <i class="fa-solid fa-arrow-right mr-2 text-xs"></i>
                  {content.ui.viewAll}
                </Button>
            </div>
          </Card>
        </Section>

        <Section id="volunteer">
          <Card variant="glass" class="p-6 reveal reveal-fade">
            <SectionHeading>{content.ui.headings.volunteer}</SectionHeading>
            {content.volunteer.items.map((item: any) => (
                <article class="item border-none pt-0">
                <div class="item-head">
                    <h3 class="text-[18px] font-bold m-0 mb-1">{item.title}</h3>
                    <span class="text-[13px] text-dim">{item.meta}</span>
                </div>
                <p class="text-[14px] text-dim mt-2 opacity-80">{item.description}</p>
                </article>
            ))}
          </Card>
        </Section>

        <Section id="certifications">
          <Card variant="glass" class="p-6 reveal reveal-fade">
            <SectionHeading>{content.ui.headings.certifications}</SectionHeading>
            
            <CertificationList certifications={cvData.certifications as any} />
            <div class="mt-6 pt-6 border-t border-glass-border print:hidden">
                <Button href={lang === 'da' ? '/certifications' : '/en/certifications'} variant="ghost" size="sm">
                  <i class="fa-solid fa-arrow-right mr-2 text-xs"></i>
                  {content.ui.viewAll}
                </Button>
            </div>
          </Card>
        </Section>

        <Section id="organizations">
          <Card variant="glass" class="p-6 reveal reveal-fade">
            <SectionHeading>{content.ui.headings.organizations}</SectionHeading>
            <div class="space-y-0 organizations-list">
              {cvData.organizations?.map((org: any) => (
                <article class="item border-none pt-0 pb-4">
                  <div class="item-head">
                    <h3 class="text-[18px] font-bold m-0 mb-1">{org.role} · {org.name}</h3>
                    <span class="text-[13px] text-dim">{org.period}</span>
                  </div>
                  <p class="text-[14px] text-dim mt-2 opacity-80">{org.description}</p>
                </article>
              ))}
            </div>
            <div class="mt-4 pt-6 border-t border-glass-border print:hidden">
                <Button href={lang === 'da' ? '/organizations' : '/en/organizations'} variant="ghost" size="sm">
                  <i class="fa-solid fa-arrow-right mr-2 text-xs"></i>
                  {content.ui.viewAll}
                </Button>
            </div>
          </Card>
        </Section>

        <Section id="discovery" class="print:hidden">
          <DiscoveryGrid 
            title={lang === 'da' ? 'Videre udforskning' : 'Further Discovery'}
            items={[
              { 
                  label: lang === 'da' ? 'Anti-CV' : 'Anti-Resume', 
                  url: lang === 'da' ? '/anti-resume' : '/en/anti-resume', 
                  icon: 'fa-user-slash', 
                  description: lang === 'da' ? 'Ting jeg ikke gør' : "Things I don't do"
              },
              { 
                  label: lang === 'da' ? 'Værdier & Etik' : 'Values & Ethics', 
                  url: lang === 'da' ? '/values' : '/en/values', 
                  icon: 'fa-heart', 
                  description: lang === 'da' ? 'Mit moralske kompas' : "My moral compass"
              },
              { 
                  label: lang === 'da' ? 'SWOT Analyse' : 'SWOT Analysis', 
                  url: lang === 'da' ? '/swot' : '/en/swot', 
                  icon: 'fa-chart-pie', 
                  description: lang === 'da' ? 'Styrker og svagheder' : "Strengths and weaknesses"
              },
              { 
                  label: lang === 'da' ? 'Personlighed' : 'Personality', 
                  url: lang === 'da' ? '/personality' : '/en/personality', 
                  icon: 'fa-id-card', 
                  description: lang === 'da' ? 'Personlighedsprofil' : "Personality profile"
              },
              { 
                  label: lang === 'da' ? 'Modgang' : 'Adversity', 
                  url: lang === 'da' ? '/modgang-og-maalrettethed' : '/en/modgang-og-maalrettethed', 
                  icon: 'fa-mountain', 
                  description: lang === 'da' ? 'Resiliens og målrettethed' : "Resilience and goals"
              },
              { 
                  label: lang === 'da' ? 'Video-CV' : 'Video CV', 
                  url: lang === 'da' ? '/video-cv' : '/en/video-cv', 
                  icon: 'fa-video', 
                  description: lang === 'da' ? 'Et ansigt på papiret' : "A face on the paper"
              }
            ]}
          />
        </Section>

      </div>
    </section>
  </div>

  <style>
    .cv-filter-btn.active {
      background: var(--accent);
      color: #000;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
    }

    .cv-item.is-dimmed {
      opacity: 0.15;
      filter: grayscale(1) blur(1px);
      pointer-events: none;
    }

    /* Short version logic: hide non-core items completely */
    .filter-mode-core .cv-item:not(.is-core) {
      display: none;
    }
  </style>

  <script>
    import { unlockAchievement } from '../../lib/gamification';

    const buttons = document.querySelectorAll('.cv-filter-btn');
    const items = document.querySelectorAll('.cv-item');
    const wrap = document.querySelector('.cv-wrap');

    // Gamification Hook for Print
    window.matchMedia('print').addEventListener('change', (mql) => {
        if (mql.matches) {
            unlockAchievement('economist'); // "Headhunter" / Economist badge logic
        }
    });

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter');
        
        // Update buttons
        buttons.forEach(b => b.classList.remove('active', 'text-dim'));
        buttons.forEach(b => {
          if (b !== btn) b.classList.add('text-dim');
        });
        btn.classList.add('active');
        btn.classList.remove('text-dim');

        // Apply filtering classes
        if (filter === 'all') {
          wrap?.classList.remove('filter-mode-core');
          items.forEach(item => item.classList.remove('is-dimmed', 'is-core'));
        } else {
          if (filter === 'core') {
            wrap?.classList.add('filter-mode-core');
          } else {
            wrap?.classList.remove('filter-mode-core');
          }

          items.forEach(item => {
            const categories = JSON.parse(item.getAttribute('data-categories') || '[]');
            const isMatch = categories.includes(filter);
            
            if (isMatch) {
              item.classList.remove('is-dimmed');
              item.classList.add('is-core');
            } else {
              item.classList.add('is-dimmed');
              item.classList.remove('is-core');
            }
          });
        }
      });
    });
  </script>
</Layout>

---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import { getEntry } from 'astro:content';

interface Props {
  lang: 'da' | 'en';
}

const { lang } = Astro.props;
const entry = await getEntry('pages', `${lang}/gallery`);

if (!entry) {
  throw new Error(`Could not find content for ${lang}/gallery`);
}

const content = entry.data;
---

<Layout 
  title={content.title} 
  description={content.description}
  bodyClass={content.bodyClass}
>
  <style>
    .gallery-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px;
      align-items: start;
    }

    /* Filters - Custom styling needed for pill-like behavior */
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }

    .chip {
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid var(--glass-border);
        background: rgba(255,255,255,0.02);
        color: var(--text-dim);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .chip:hover, .chip.is-active {
        background: var(--accent);
        color: #000;
        border-color: var(--accent);
    }

    .search-wrap {
        position: relative;
    }
    .search-wrap i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-dim);
        font-size: 14px;
    }
    .search-input {
        width: 100%;
        padding: 10px 10px 10px 36px;
        border-radius: 8px;
        border: 1px solid var(--glass-border);
        background: rgba(0,0,0,0.2);
        color: var(--text);
        font-family: inherit;
        font-size: 14px;
    }
    .search-input:focus {
        outline: none;
        border-color: var(--accent);
    }

    /* Grid */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    /* Gallery Card */
    .g-card {
        background: var(--glass);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s ease;
        margin: 0;
    }
    .g-card:hover {
        transform: translateY(-2px);
        border-color: var(--glass-border-hover);
    }

    .g-btn {
        width: 100%;
        aspect-ratio: 4/3;
        border: none;
        padding: 0;
        cursor: zoom-in;
        display: block;
        overflow: hidden;
    }
    .g-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    .g-btn:hover img {
        transform: scale(1.05);
    }

    .g-caption {
        padding: 12px 16px 16px;
    }
    .cap-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    .tag {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(255,255,255,0.05);
        color: var(--text-dim);
    }

    /* Lightbox */
    .lightbox {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
    }
    .lightbox.is-open {
        opacity: 1;
        pointer-events: auto;
    }
    .lb-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(8px);
    }
    .lb-panel {
        position: relative;
        max-width: 900px;
        width: 100%;
        background: #111;
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .lb-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.5);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .lb-close:hover { background: var(--accent); color: black; }
    
    #lbImg {
        width: 100%;
        max-height: 70vh;
        object-fit: contain;
        background: #000;
        display: block;
    }
    .lb-meta {
        padding: 16px 24px;
        background: #161616;
        border-top: 1px solid #333;
    }
    #lbTitle { margin: 0 0 4px; font-size: 18px; color: white; }
    #lbText { margin: 0; font-size: 14px; color: #aaa; }

    @media (max-width: 980px) {
      .hero-grid { 
        grid-template-columns: 1fr; 
      }
    }
  </style>

  <main class="gallery-wrap">

    <!-- HERO -->
    <Section>
      <div class="hero-grid">
        <Card variant="glass" class="p-8">
          <p class="text-xs font-bold uppercase tracking-widest text-dim mb-3">{content.hero.eyebrow}</p>
          <h1 class="text-4xl font-bold leading-tight mb-4">{content.hero.title}</h1>
          <p class="text-lg text-dim mb-6">
            {content.hero.lead}
          </p>

          <div class="flex flex-wrap gap-3">
            <Button href="#grid">{content.hero.btnView}</Button>
            <Button href={lang === 'en' ? "/en/contact" : "/contact"} variant="ghost">{content.hero.btnPropose}</Button>
          </div>
          
          <p class="text-xs text-dim mt-4 opacity-50" set:html={content.hero.tip} />
        </Card>

        <div class="hidden md:block">
          <Card variant="glass" class="p-6">
            <SectionHeading>{content.hero.categoriesTitle}</SectionHeading>
            <p class="text-sm text-dim">
              {content.hero.categoriesText}
            </p>
          </Card>
        </div>
      </div>
    </Section>

    <!-- FILTERS -->
    <Section>
        <Card variant="glass" class="p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="filters" role="tablist" aria-label="Filters">
                    <button class="chip is-active" data-filter="all" role="tab" aria-selected="true">{content.filters.all}</button>
                    <button class="chip" data-filter="training" role="tab" aria-selected="false">{content.filters.training}</button>
                    <button class="chip" data-filter="travel" role="tab" aria-selected="false">{content.filters.travel}</button>
                    <button class="chip" data-filter="events" role="tab" aria-selected="false">{content.filters.events}</button>
                    <button class="chip" data-filter="teaching" role="tab" aria-selected="false">{content.filters.teaching}</button>
                </div>
        
                <div class="search-wrap w-full md:w-auto">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                    <input id="gallerySearch" class="search-input" type="search" placeholder={content.ui.searchPlaceholder} aria-label="Search gallery" />
                </div>
            </div>
        </Card>
    </Section>

    <!-- GRID -->
    <div id="grid" class="gallery-grid" aria-label="Gallery">
      {content.items.map((item: any) => (
          <figure class="g-card" data-tags={item.tags ? item.tags.join(' ') : ''} data-caption={item.caption}>
            <button class="g-btn" type="button"
              data-src={item.src}
              data-alt={item.title}
              data-title={item.title}
              data-text={item.text}>
              <img src={item.src} alt={item.title} loading="lazy">
            </button>
            <figcaption class="g-caption">
              <div class="cap-top">
                <strong class="text-sm">{item.title}</strong>
                <span class="tag">{item.tagLabel}</span>
              </div>
              <p class="text-xs text-dim opacity-80 m-0">{item.text}</p>
            </figcaption>
          </figure>
      ))}
    </div>

    <!-- LIGHTBOX -->
    <div class="lightbox" id="lightbox" aria-hidden="true" role="dialog" aria-label="Lightbox">
      <div class="lb-backdrop" data-close></div>

      <div class="lb-panel" role="document" aria-label="Image">
        <button class="lb-close" type="button" data-close aria-label="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>

        <img id="lbImg" alt="" />
        <div class="lb-meta">
          <h2 id="lbTitle"></h2>
          <p id="lbText" class="muted"></p>
        </div>
      </div>
    </div>

    <div class="mt-8">
        <Card variant="glass" class="p-6 text-center">
            <SectionHeading centered>{content.ui.moreTitle}</SectionHeading>
            <p class="text-sm text-dim">
                {content.ui.moreText}
                <a href="https://github.com/AntonEbsen" target="_blank" rel="noopener" class="text-accent underline">{content.ui.github}</a>
                {lang === 'da' ? ' og ' : ' and '}
                <a href="https://www.linkedin.com/in/antonebsen/" target="_blank" rel="noopener" class="text-accent underline">{content.ui.linkedin}</a>.
            </p>
        </Card>
    </div>

  </main>

  <script>
    // Filter + search
    const chips = document.querySelectorAll(".chip");
    const cards = Array.from(document.querySelectorAll(".g-card"));
    const search = document.getElementById("gallerySearch");

    let activeFilter = "all";

    function applyFilters(){
      const q = (search && search instanceof HTMLInputElement ? search.value : "").toLowerCase().trim();

      cards.forEach(card => {
        if (!(card instanceof HTMLElement)) return;

        const tags = (card.getAttribute("data-tags") || "").toLowerCase();
        const cap  = (card.getAttribute("data-caption") || "").toLowerCase();

        // Note: I changed the original hardcoded tags (traening -> training) etc.
        // So I must ensure the filter buttons use the same keys as the JSON tags.
        // Checked: JSON uses 'training', 'travel', etc.
        // And template uses {content.filters.training} for label, but data-filter="training".
        // Wait, I need to check the data-filter values in the HTML vs the JSON tags.
        // In template: data-filter="training"
        // In JSON items: tags: ["training"]
        // So this matches perfectly given I standardized to English keys in JSON.

        const matchesFilter = activeFilter === "all" || tags.includes(activeFilter);
        const matchesSearch = !q || cap.includes(q);

        card.style.display = (matchesFilter && matchesSearch) ? "" : "none";
      });
    }

    chips.forEach(btn => {
      btn.addEventListener("click", () => {
        chips.forEach(c => c.classList.remove("is-active"));
        btn.classList.add("is-active");

        activeFilter = btn.getAttribute("data-filter") || "all";
        applyFilters();
      });
    });

    if(search) {
      search.addEventListener("input", applyFilters);
    }

    // Lightbox
    const lb = document.getElementById("lightbox");
    const lbImg = document.getElementById("lbImg");
    const lbTitle = document.getElementById("lbTitle");
    const lbText = document.getElementById("lbText");

    function openLB(data){
      if(!lb || !lbImg || !lbTitle || !lbText) return;
      if (lbImg instanceof HTMLImageElement) {
          lbImg.src = data.src || "";
          lbImg.alt = data.alt || "";
      }
      lbTitle.textContent = data.title || "";
      lbText.textContent = data.text || "";

      lb.classList.add("is-open");
      lb.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeLB(){
      if(!lb) return;
      lb.classList.remove("is-open");
      lb.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      if (lbImg instanceof HTMLImageElement) lbImg.src = "";
    }

    document.querySelectorAll(".g-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        openLB({
          src: btn.getAttribute("data-src"),
          alt: btn.getAttribute("data-alt"),
          title: btn.getAttribute("data-title"),
          text: btn.getAttribute("data-text")
        });
      });
    });

    if(lb) {
        lb.addEventListener("click", (e) => {
        if (e.target instanceof Element && e.target.closest("[data-close]")) closeLB();
        });

        document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && lb.classList.contains("is-open")) closeLB();
        });
    }
  </script>
</Layout>



---
import StudyGroupLayout from '../../layouts/study-group/StudyGroupBaseLayout.astro';
import { createClient } from '@supabase/supabase-js';

export const prerender = false;

// Supabase Init
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseKey = import.meta.env.SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

// Fetch Leaderboard for Stats
let { data: stats } = await supabase
    .from('study_leaderboard')
    .select('*')
    .order('pomodoros', { ascending: false });

const leaderboardEntries = stats || [];
---

<StudyGroupLayout title="Statistik-Kommissariatet" activePage="analytics">
    <div class="space-y-20">
        <div class="space-y-4">
            <h2 class="text-6xl font-black italic tracking-tighter text-white uppercase leading-none">Statistik- <br/> <span class="text-red-600">Kommissariatet</span></h2>
            <p class="text-white/40 text-lg max-w-lg leading-relaxed italic">
                Videnskabelig analyse af kollektivets produktivitet. Her transformeres r√• data til strategiske overblik.
            </p>
        </div>

        {/* Analytics Grid */}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            
            {/* Pomodoro Produktion (Bar Chart) */}
            <div class="p-12 bg-white/[0.02] border border-white/5 rounded-[48px] space-y-8">
                <div class="space-y-1">
                    <h3 class="text-xl font-black uppercase tracking-tight text-white">Produktions-Output</h3>
                    <p class="text-[10px] font-black uppercase tracking-widest text-white/20">Samlede Pomodoro-sessions pr. Kamerat</p>
                </div>
                <div class="h-80 relative">
                    <canvas id="pomodoroChart"></canvas>
                </div>
            </div>

            {/* Sider Skrevet (Pie Chart) */}
            <div class="p-12 bg-white/[0.02] border border-white/5 rounded-[48px] space-y-8">
                <div class="space-y-1">
                    <h3 class="text-xl font-black uppercase tracking-tight text-white">Bidrags-Fordeling</h3>
                    <p class="text-[10px] font-black uppercase tracking-widest text-white/20">Procentvis andel af sider skrevet</p>
                </div>
                <div class="h-80 relative">
                    <canvas id="pagesChart"></canvas>
                </div>
            </div>

            {/* Burndown Chart (Mocked for now, needs timeline data) */}
            <div class="p-12 bg-white/[0.02] border border-white/5 rounded-[48px] col-span-full space-y-8">
                <div class="space-y-1">
                    <h3 class="text-xl font-black uppercase tracking-tight text-white">Vejen Mod Sejren</h3>
                    <p class="text-[10px] font-black uppercase tracking-widest text-white/20">Burndown: Sider tilbage vs. Tid til aflevering</p>
                </div>
                <div class="h-96 relative">
                    <canvas id="burndownChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script shadow:true>
        import Chart from 'chart.js/auto';

        // Get data from server-side (passed via dataset or just hardcoded for now)
        // In a real app, you'd fetch this via an API route or pass it in a data attribute
        const entries = JSON.parse(document.getElementById('stats-data').dataset.entries);

        const labels = entries.map(e => e.member_id.charAt(0).toUpperCase() + e.member_id.slice(1));
        const pomodoros = entries.map(e => e.pomodoros);
        const pages = entries.map(e => e.pages);

        // Chart.js Defaults
        Chart.defaults.color = 'rgba(255, 255, 255, 0.2)';
        Chart.defaults.font.family = 'Inter, sans-serif';

        // 1. Pomodoro Bar Chart
        new Chart(document.getElementById('pomodoroChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sessions',
                    data: pomodoros,
                    backgroundColor: 'rgba(220, 38, 38, 0.8)',
                    borderColor: 'rgb(220, 38, 38)',
                    borderWidth: 1,
                    borderRadius: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 2. Pages Pie Chart
        new Chart(document.getElementById('pagesChart'), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: pages,
                    backgroundColor: [
                        'rgba(220, 38, 38, 0.8)',
                        'rgba(239, 68, 68, 0.6)',
                        'rgba(153, 27, 27, 0.8)'
                    ],
                    borderWidth: 0,
                    hoverOffset: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 20, usePointStyle: true }
                    }
                }
            }
        });

        // 3. Burndown Chart (Simulated)
        const daysToDeadline = 40; // Approx till May 15
        const totalPagesNeeded = 60;
        const idealPath = Array.from({length: daysToDeadline}, (_, i) => totalPagesNeeded - (i * (totalPagesNeeded/daysToDeadline)));
        const actualPath = [60, 59, 58.5, 57, 56.2, 55, 54.8, 53.5, 52]; // Simulated actual progress

        new Chart(document.getElementById('burndownChart'), {
            type: 'line',
            data: {
                labels: Array.from({length: daysToDeadline}, (_, i) => `Dag ${i+1}`),
                datasets: [
                    {
                        label: 'Ideel Kurs',
                        data: idealPath,
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: 'Aktuel Produktion',
                        data: actualPath,
                        borderColor: 'rgb(220, 38, 38)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgb(220, 38, 38)',
                        pointRadius: 4,
                        fill: true,
                        backgroundColor: 'rgba(220, 38, 38, 0.05)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { usePointStyle: true } }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        title: { display: true, text: 'Sider Tilbage' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    </script>

    {/* Hidden Data Store */}
    <div id="stats-data" data-entries={JSON.stringify(leaderboardEntries)}></div>
</StudyGroupLayout>



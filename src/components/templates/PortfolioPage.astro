---
import Layout from '@layouts/BaseLayout.astro';
import Pill from '@components/ui/Pill.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import ProjectCard from '@components/portfolio/ProjectCard.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';
import DiscoveryGrid from '@components/common/DiscoveryGrid.astro';
import { supabase } from '@lib/supabase';
import { getEntry } from 'astro:content';

export const prerender = true;

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const entry = await getEntry('pages', `${lang}/portfolio`);

if (!entry) {
  throw new Error(`Could not find content for ${lang}/portfolio`);
}

const content: any = entry.data;

// Supabase Data Fetching
// Client imported from @lib/supabase
let projects = [];
if (supabase) {
  const { data, error } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
  if (!error && data) projects = data;
}

// Helper to determine link URL (English vs Danish)
const cvLink = lang === 'en' ? '/en/cv' : '/cv';
---

<Layout 
  title={content.title}
  description={content.description}
  bodyClass={content.bodyClass}
>

  <style>
    .portfolio-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px;
      align-items: start;
    }

    .projects-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 14px;
    }

    @media (max-width: 980px) {
      .hero-grid, .projects-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <main class="portfolio-wrap">
    <!-- HERO -->
      <Section>
        <div class="hero-grid">
          <Card variant="glass" class="p-8">
            <p class="text-xs font-extrabold uppercase tracking-widest text-dim mb-3">{content.hero.eyebrow}</p>
            <h1 class="text-4xl leading-[1.15] mb-5 font-bold">{content.hero.title}</h1>
            <p class="text-[17px] leading-relaxed text-dim mb-6 opacity-90">
              {content.hero.text}
            </p>
    
            <div class="flex flex-wrap gap-3 mb-6">
              <Button href={cvLink}>{content.hero.cta.cv}</Button>
              <Button href="https://github.com/AntonEbsen" target="_blank" rel="noopener" variant="ghost"><i class="fa-brands fa-github mr-2"></i> {content.hero.cta.github}</Button>
              <Button href="https://www.linkedin.com/in/antonebsen/" target="_blank" rel="noopener" variant="ghost"><i class="fa-brands fa-linkedin mr-2"></i> {content.hero.cta.linkedin}</Button>
            </div>
    
            <div class="flex flex-wrap gap-2">
               {content.hero.pills.map((pill: string) => (
                 <Pill variant="accent">{pill}</Pill>
               ))}
            </div>
          </Card>
    
          <div class="hidden md:block">
            <Card variant="glass" class="p-6">
              <SectionHeading>{content.sidebar.title}</SectionHeading>
              <ul class="list-none p-0 m-0 space-y-2 text-sm text-dim opacity-90">
                {content.sidebar.items.map((item: string) => (
                    <li class="relative pl-4 before:content-['-'] before:absolute before:left-0 before:text-accent">{item}</li>
                ))}
              </ul>
            </Card>
          </div>
        </div>
      </Section>
  
      <!-- PROJECT GRID -->
      <Section>
        <div class="projects-grid">
          {projects?.map((p: any) => (
            <ProjectCard
              title={p.title}
              tagString={p.tags ? p.tags.join(' · ') : ''}
              description={p.description}
              tools={[]}
              output={p.featured ? content.ui.featured : content.ui.project}
              links={p.url ? [{ text: content.ui.viewProject, url: p.url, icon: 'arrow-right' }] : []}
              lang={lang}
            />
          ))}
        </div>
      </Section>
  
      <!-- DEEP DIVES -->
      <Section id="discovery">
        <DiscoveryGrid 
          title={lang === 'da' ? 'Protokoller & Arkiv' : 'Protocols & Archive'}
          items={[
            { 
                label: lang === 'da' ? 'Projekt-cases' : 'Case Studies', 
                url: lang === 'da' ? '/cases' : '/en/cases', 
                icon: 'fa-folder-open', 
                description: lang === 'da' ? 'Dybdegående gennemgang' : "In-depth reviews"
            },
            { 
                label: lang === 'da' ? 'Downloads' : 'Resources', 
                url: lang === 'da' ? '/resources' : '/en/resources', 
                icon: 'fa-download', 
                description: lang === 'da' ? 'Templates og værktøjer' : "Templates and tools"
            },
            { 
                label: lang === 'da' ? 'API Protokol' : 'API Protocol', 
                url: lang === 'da' ? '/api-docs' : '/en/api-docs', 
                icon: 'fa-code', 
                description: lang === 'da' ? 'Teknisk dokumentation' : "Technical documentation"
            },
            { 
                label: lang === 'da' ? 'Mit Setup' : 'My Setup', 
                url: lang === 'da' ? '/uses' : '/en/uses', 
                icon: 'fa-laptop-code', 
                description: lang === 'da' ? 'Soft- og hardware' : "Software and hardware"
            },
            { 
                label: lang === 'da' ? 'Sundhed' : 'Health', 
                url: lang === 'da' ? '/health' : '/en/health', 
                icon: 'fa-heart-pulse', 
                description: lang === 'da' ? 'Min sundhedsprotokol' : "My health protocol"
            },
            { 
                label: lang === 'da' ? 'Omtale' : 'Media', 
                url: lang === 'da' ? '/media' : '/en/media', 
                icon: 'fa-newspaper', 
                description: lang === 'da' ? 'Presse og omtale' : "Press and mentions"
            }
          ]}
        />
      </Section>
  
      <!-- Footer card -->
      <Section>
        <ContactCard />
      </Section>
  
  </main>
</Layout>




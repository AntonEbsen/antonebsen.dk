---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';
import Pill from '@components/ui/Pill.astro';
import Button from '@components/ui/Button.astro';
import { supabase } from '@lib/supabase';

  de: {
    title: "Lieblingsbücher – Anton Meier Ebsen Jørgensen",
    desc: "Eine kuratierte Liste meiner Lieblingsbücher – Klassiker, Fachbücher und Bücher, zu denen ich immer wieder zurückkehre.",
    eyebrow: "Über mich · Leseliste",
    heroTitle: "Meine Lieblingsbücher",
    heroText: "Eine kuratierte Liste von Büchern, aus denen ich am meisten mitgenommen habe – entweder weil sie meine Denkweise geprägt haben oder weil ich sie immer wieder lese.",
    categories: ["Klassiker", "Fachbücher", "Biografien", "Glaube & Ethik", "Sprache & Schreiben"],
    listBtn: "Liste ansehen",
    recommendBtn: "Ein Buch empfehlen",
    usageTitle: "Wie ich diese Liste nutze",
    usageText1: "Ich aktualisiere diese Liste regelmäßig. Einige sind 'Must-Reads', andere haben einfach zu einem bestimmten Zeitpunkt in meinem Leben genau richtig gepasst.",
    usageText2: "Tipp: Das Hinzufügen von Jahreszahlen und Notizen macht die Liste persönlicher.",
    listTitle: "Favoriten (Live DB)",
    listSub: "Direkt aus der \"Living Library\"-Datenbank geladen.",
    empty: "Die Bibliothek ist leer.",
    ctaTitle: "Empfehlen Sie mir ein Buch",
    ctaText: "Schreiben Sie mir gerne eine E-Mail, wenn Sie Vorschläge für interessante Lektüre haben."
  }
};

const content = (t as any)[lang] || t.da;

// Data Fetching
import { getBooks } from '../../lib/api';
const books = await getBooks();
---

<Layout 
  title={content.title}
  description={content.desc}
  bodyClass="books-page"
>

  <style>
    .books-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px;
      align-items: start;
    }

    .books-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 980px) {
      .hero-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <main class="books-wrap">

    <!-- HERO -->
    <Section>
      <div class="hero-grid">
        <Card variant="glass" class="p-8">
          <p class="text-xs font-extrabold uppercase tracking-widest text-dim mb-3">{content.eyebrow}</p>
          <h1 class="text-4xl leading-[1.15] mb-5 font-bold">{content.heroTitle}</h1>
          <p class="text-[17px] leading-relaxed text-dim mb-6 opacity-90">
            {content.heroText}
          </p>
  
          <div class="flex flex-wrap gap-2 mb-8" aria-label="Categories">
            {content.categories.map(cat => <Pill variant="accent">{cat}</Pill>)}
          </div>
  
          <div class="flex flex-wrap gap-3">
            <Button href="#list"><i class="fa-solid fa-book mr-2"></i> {content.listBtn}</Button>
            <Button href={isDa ? "/contact" : "/en/contact"} variant="ghost"><i class="fa-solid fa-envelope mr-2"></i> {content.recommendBtn}</Button>
          </div>
        </Card>
  
        <div class="hidden md:block">
          <Card variant="glass" class="p-6">
            <SectionHeading>{content.usageTitle}</SectionHeading>
            <p class="text-[13px] text-dim mb-4 opacity-70 leading-relaxed">
              {content.usageText1}
            </p>
            <p class="text-[13px] text-dim opacity-70 leading-relaxed">
              {content.usageText2}
            </p>
          </Card>
        </div>
      </div>
    </Section>

    <!-- CATEGORIES -->
    <Section class="mb-8">
      <div class="flex flex-wrap gap-2 justify-center" id="book-filters">
        <button class="filter-btn active px-4 py-2 rounded-full border border-white/10 text-xs font-bold uppercase tracking-widest hover:bg-white/5 transition-all" data-category="all">
          Alle
        </button>
        {content.categories.map(cat => (
          <button class="filter-btn px-4 py-2 rounded-full border border-white/10 text-xs font-bold uppercase tracking-widest hover:bg-white/5 transition-all" data-category={cat}>
            {cat}
          </button>
        ))}
      </div>
    </Section>

    <!-- LIST -->
    <Section id="list">
      <Card variant="bordered" class="p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
          <div>
            <SectionHeading>{content.listTitle}</SectionHeading>
            <p class="text-dim opacity-70 text-sm">
              {content.listSub}
            </p>
          </div>
          <div class="text-xs font-mono text-accent bg-accent/5 px-3 py-1.5 rounded-lg border border-accent/10">
            {books.length} VOLUMES LOGGED
          </div>
        </div>

        <div class="books-grid" id="books-grid">
           {books.length === 0 ? (
               <p class="text-dim col-span-full text-center py-12">{content.empty}</p>
           ) : (
             books.map((book: any, bIdx: number) => {
                 const r = Math.min(Math.max(book.rating || 0, 0), 5);
                 const ratingStars = '★'.repeat(r) + '☆'.repeat(5 - r);
                 const category = book.category || (bIdx % 2 === 0 ? 'Fagligt' : 'Klassikere'); // Mock category if missing
                
                return (
                 <div class="book-card group relative flex flex-col gap-3 p-6 rounded-2xl border border-white/5 bg-white/[0.02] hover:bg-white/[0.04] transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:shadow-black/40" data-category={category}>
                    <div class="absolute -top-px -left-px -right-px h-1 bg-gradient-to-r from-accent/40 to-transparent rounded-t-2xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-accent mb-1">{category}</span>
                        <span class="text-[10px] bg-white/5 px-2 py-0.5 rounded text-white/40 border border-white/5">{book.status || 'Read'}</span>
                    </div>

                    <h3 class="text-xl font-bold text-white group-hover:text-accent transition-colors leading-tight">{book.title}</h3>
                    <p class="text-sm text-dim mb-4">{book.author || 'Unknown'}</p>
                    
                    {book.notes && (
                      <div class="relative">
                        <i class="fa-solid fa-quote-left absolute -left-4 -top-2 text-accent/10 text-2xl"></i>
                        <p class="text-[13px] text-white/70 italic leading-relaxed pl-2 border-l border-white/10 mb-4">
                          {book.notes}
                        </p>
                      </div>
                    )}

                    {book.takeaway && (
                      <div class="mt-2 p-3 bg-accent/5 rounded-lg border border-accent/10">
                        <p class="text-[11px] font-bold text-accent uppercase tracking-wider mb-1">Key Takeaway</p>
                        <p class="text-[12px] text-dim">{book.takeaway}</p>
                      </div>
                    )}
                    
                    <div class="mt-auto pt-6 border-t border-white/5 flex justify-between items-center">
                        <span class="text-gold-500/80 tracking-widest text-xs">{ratingStars}</span>
                        <span class="text-[10px] font-mono text-white/30 uppercase">{new Date(book.created_at).getFullYear()} EDITION</span>
                    </div>
                 </div>
                );
             })
            )}
        </div>
      </Card>
    </Section>

    <script>
      const filterBtns = document.querySelectorAll('.filter-btn');
      const bookCards = document.querySelectorAll('.book-card');

      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const category = (btn as HTMLElement).dataset.category;
          
          // Update button UI
          filterBtns.forEach(b => b.classList.remove('active', 'bg-accent', 'text-bg', 'border-accent'));
          btn.classList.add('active', 'bg-accent', 'text-bg', 'border-accent');

          // Filter cards
          bookCards.forEach(card => {
            const cardCat = (card as HTMLElement).dataset.category;
            if (category === 'all' || cardCat === category) {
              (card as HTMLElement).style.display = 'flex';
              setTimeout(() => (card as HTMLElement).style.opacity = '1', 10);
            } else {
              (card as HTMLElement).style.opacity = '0';
              setTimeout(() => (card as HTMLElement).style.display = 'none', 300);
            }
          });
        });
      });
    </script>

    <style>
      .filter-btn.active {
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
      }
      .book-card {
        transition: opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      }
    </style>

    <!-- CTA -->
    <Section>
      <ContactCard 
        variant="glass" 
        title={content.ctaTitle} 
        text={content.ctaText}
        action="email"
      />
    </Section>

  </main>
</Layout>





---
import '@styles/styles.css';
---

<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eremita | Ørkenen</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Fonts -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon-cross.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body { font-family: 'Cinzel', serif; }
        .text-body { font-family: 'Playfair Display', serif; }

        /* The blurred text effect */
        .blur-target {
            filter: blur(20px);
            opacity: 0.2;
            transition: all 0.5s ease-out; /* Slow to allow "calming" feeling, but fast enough to react to movement */
        }
        .clarity {
            filter: blur(0px);
            opacity: 1;
        }
        
    </style>
</head>
<body class="bg-[#C2B280] text-[#3d342b] min-h-screen overflow-hidden flex flex-col items-center justify-center relative cursor-none select-none">

    <!-- Nav (Hidden unless hovered? No, keep minimal) -->
    <nav class="fixed top-8 left-8 z-50 mix-blend-multiply opacity-50 hover:opacity-100 transition-opacity">
        <a href="/shrine" class="text-[#3d342b] transition-colors text-xl flex items-center gap-2">
            <i class="fa-solid fa-arrow-left"></i>
            <span class="text-xs uppercase tracking-widest hidden md:inline">Forlad Ørkenen</span>
        </a>
    </nav>
    
    <!-- Status Indicator -->
    <div class="fixed top-8 right-8 z-50 text-right opacity-60">
        <div class="text-[9px] uppercase tracking-[0.2em] text-[#3d342b] mb-1">Stilhed</div>
        <div class="w-24 h-1 bg-[#3d342b]/20 rounded-full overflow-hidden">
            <div id="silence-bar" class="w-0 h-full bg-[#3d342b] transition-all duration-300"></div>
        </div>
    </div>

    <!-- MAIN VISUAL: Sandstorm Canvas -->
    <canvas id="sand-canvas" class="fixed inset-0 w-full h-full pointer-events-none z-10"></canvas>
    
    <!-- Overlay Gradient (Vignette) -->
    <div class="fixed inset-0 pointer-events-none z-20 bg-radial-gradient"></div>

    <!-- CONTENT (Hidden behind blur) -->
    <div class="relative z-30 max-w-2xl px-12 text-center blur-target" id="target-content">
        <h1 class="text-4xl md:text-6xl font-serif text-[#2a241e] mb-8 drop-shadow-sm">Vox Clamantis</h1>
        <p class="text-xl md:text-2xl text-body italic leading-relaxed text-[#4a4036]">
            "Jeg ledte hende ud i ørkenen,<br>
            for at tale til hendes hjerte."
        </p>
        <p class="text-xs uppercase tracking-widest mt-8 opacity-60">- Hoseas 2,16</p>
        
        <div class="mt-16 opacity-0 transition-opacity duration-2000" id="deep-content">
            <p class="text-sm text-body italic">
                (I stilheden findes svaret, som støjen skjulte.)
            </p>
        </div>
    </div>
    
    <!-- Instructions (Fades out) -->
    <div id="instruction" class="fixed bottom-12 text-center z-40 animate-pulse text-[#3d342b]/60 text-xs uppercase tracking-widest pointer-events-none">
        Vær helt stille
    </div>

    <!-- Audio Permission Button (If needed, sticking to auto-try first) -->
    <button id="start-btn" class="fixed inset-0 z-50 bg-[#C2B280] flex flex-col items-center justify-center gap-4 transition-opacity duration-500" onclick="initExperience()">
         <span class="text-xs uppercase tracking-widest">Træd ind i stilheden</span>
         <i class="fa-solid fa-wind text-2xl animate-pulse"></i>
    </button>

    <script>
        const target = document.getElementById('target-content');
        const silenceBar = document.getElementById('silence-bar');
        const deepContent = document.getElementById('deep-content');
        const instruction = document.getElementById('instruction');
        const startBtn = document.getElementById('start-btn');
        const canvas = document.getElementById('sand-canvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let mouseX = 0, mouseY = 0;
        let velocity = 100; // Start loud/busy
        let stillness = 0; // 0 to 100
        let isRunning = false;
        let audioCtx: AudioContext | null = null;
        let noiseNode: AudioBufferSourceNode | null = null;
        let gainNode: GainNode | null = null;
        let lowPass: BiquadFilterNode | null = null;
        
        // --- 1. RESIZE ---
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 2. INPUT TRACKING ---
        let lastX = 0, lastY = 0;
        document.addEventListener('mousemove', (e) => {
            if(!isRunning) return;
            const dx = Math.abs(e.clientX - lastX);
            const dy = Math.abs(e.clientY - lastY);
            // Add to velocity "energy"
            velocity += (dx + dy) * 2; 
            velocity = Math.min(velocity, 200); // cap
            
            lastX = e.clientX;
            lastY = e.clientY;
            
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        // --- 3. AUDIO ENGINE (Brown Noise Wind) ---
        async function initAudio() {
            audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
            const bufferSize = audioCtx.sampleRate * 2; // 2s buffer
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);

            // Brown Noise Gen
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                lastOut = (lastOut + (0.02 * white)) / 1.02;
                data[i] = lastOut * 3.5; 
                data[i] *= 0.5; // Gain correction
            }

            noiseNode = audioCtx.createBufferSource();
            noiseNode.buffer = buffer;
            noiseNode.loop = true;
            
            gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.5; // Start volume
            
            lowPass = audioCtx.createBiquadFilter();
            lowPass.type = 'lowpass';
            lowPass.frequency.value = 400; // Start muffled
            
            noiseNode.connect(lowPass);
            lowPass.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            noiseNode.start();
        }

        (window as any).initExperience = async () => {
            startBtn.style.opacity = '0';
            setTimeout(() => startBtn.remove(), 500);
            
            await initAudio();
            isRunning = true;
            animate();
        };

        // --- 4. ANIMATION LOOP ---
        const particles = [];
        for(let i=0; i<300; i++) {
             particles.push({
                 x: Math.random() * width,
                 y: Math.random() * height,
                 size: Math.random() * 2,
                 speed: Math.random() * 5 + 2
             });
        }

        function animate() {
            ctx.clearRect(0,0,width,height);
            
            // --- LOGIC ---
            // Decay velocity
            velocity *= 0.95; 
            if(velocity < 0.1) velocity = 0;

            // Stillness meter logic
            if(velocity < 1) {
                // Determine "stillness" progress
                stillness += 0.2; // Rises slowly
            } else {
                stillness -= 2.0; // Drops fast if moving
            }
            stillness = Math.max(0, Math.min(100, stillness));

            // Feedback Visuals
            silenceBar.style.width = `${stillness}%`;
            
            // Blur / Clarity logic
            // If stillness > 80, we are clear.
            // Map blur to (100 - stillness)
            const blurAmount = Math.max(0, (100 - stillness) / 5); // 20px max
            target.style.filter = `blur(${blurAmount}px)`;
            target.style.opacity = `${0.2 + (stillness/100)*0.8}`;
            
            // Deep content reveal
            if(stillness > 95) {
                deepContent.style.opacity = '1';
                instruction.style.opacity = '0';
            } else {
                deepContent.style.opacity = '0';
            }

            // --- AUDIO UPDATE ---
            if(gainNode && lowPass) {
                // More stillness = Less Volume, Lower Filter Frequency
                // Volume: 100 stillness -> 0.1 vol
                // Volume: 0 stillness -> 0.8 vol
                const volTarget = 0.8 - (stillness / 100) * 0.7; 
                gainNode.gain.setTargetAtTime(volTarget, audioCtx.currentTime, 0.1);
                
                // Frequency: 0 stillness -> 1000Hz (Harsh wind)
                // Frequency: 100 stillness -> 100Hz (Deep rumble)
                const freqTarget = 1000 - (stillness / 100) * 900;
                lowPass.frequency.setTargetAtTime(freqTarget, audioCtx.currentTime, 0.1);
            }

            // --- PARTICLE DRAW (SAND) ---
            ctx.fillStyle = "#3d342b";
            // Opacity based on velocity (more wind = more dust visibility)
            const dustOpacity = 0.1 + (velocity / 200) * 0.4;
            
            for(let p of particles) {
                // Move
                p.x += p.speed + (velocity * 0.1); // Add wind speed
                
                // Reset
                if(p.x > width) p.x = -10;
                
                // Draw
                ctx.globalAlpha = dustOpacity * Math.random(); 
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
            }

            requestAnimationFrame(animate);
        }

    </script>
</body>
</html>

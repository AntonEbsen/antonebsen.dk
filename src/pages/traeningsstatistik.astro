---
import Layout from '../layouts/Layout.astro';
import Section from '../components/ui/Section.astro';
import Card from '../components/ui/Card.astro';
import SectionHeading from '../components/ui/SectionHeading.astro';
import Button from '../components/ui/Button.astro';
---

<Layout 
  title="Træningsstatistik – Anton Meier Ebsen Jørgensen" 
  description="Dashboard over min træningsprogression, volumen og PRs."
>
  <main class="container mx-auto px-4 py-12">
    <Section class="max-w-4xl mx-auto">
      <Card variant="glass" class="p-12 text-center">
        <SectionHeading class="mb-6">Træning (Live Data)</SectionHeading>
        <h1 class="text-4xl font-bold mb-6">Træningsstatistik</h1>
        <p class="text-xl text-dim mb-8 max-w-2xl mx-auto">
          Live-opdateret data direkte fra min træningslog. Fordi det der bliver målt, bliver forbedret.
        </p>
        
        <!-- CONSISTENCY HEATMAP -->
        <div class="mb-12 text-left">
            <div class="p-8 bg-glass border border-glass-border rounded-2xl">
                <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-fire"></i> Consistency Heatmap (Sidste 6 mdr.)
                </h3>
                <div id="heatmap-container" class="overflow-x-auto pb-4">
                    <div id="training-heatmap" class="grid grid-flow-col grid-rows-7 gap-1 min-w-[800px]">
                        <!-- Squares will be injected here -->
                    </div>
                </div>
                <div class="mt-4 flex items-center justify-end gap-2 text-[10px] text-white/30 font-bold uppercase">
                    <span>Mindre</span>
                    <div class="flex gap-1">
                        <div class="w-2.5 h-2.5 rounded-sm bg-white/5"></div>
                        <div class="w-2.5 h-2.5 rounded-sm bg-accent/20"></div>
                        <div class="w-2.5 h-2.5 rounded-sm bg-accent/40"></div>
                        <div class="w-2.5 h-2.5 rounded-sm bg-accent/70"></div>
                        <div class="w-2.5 h-2.5 rounded-sm bg-accent"></div>
                    </div>
                    <span>Mere</span>
                </div>
            </div>
        </div>

        <!-- KPI METRICS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-left">
          <div class="p-4 bg-glass border border-glass-border rounded-xl">
            <span class="text-xs uppercase text-accent font-bold">Total Volumen (All Time)</span>
            <div id="stat-tonnage" class="text-2xl font-bold mt-1 animate-pulse">...</div>
          </div>
          <div class="p-4 bg-glass border border-glass-border rounded-xl">
            <span class="text-xs uppercase text-accent font-bold">Sessions (Total)</span>
            <div id="stat-sessions" class="text-2xl font-bold mt-1 animate-pulse">...</div>
          </div>
          <div class="p-4 bg-glass border border-glass-border rounded-xl">
            <span class="text-xs uppercase text-accent font-bold">Favorit Løft</span>
            <div class="text-2xl font-bold mt-1">Squat</div>
          </div>
        </div>

        <!-- CHARTS SECTION -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12">
             <!-- Volume / Tonnage Chart -->
             <div class="p-6 bg-glass border border-glass-border rounded-2xl min-h-[350px]">
                <h3 class="text-left text-xs uppercase font-bold text-accent mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-chart-bar"></i> Volumen pr uge (kg)
                </h3>
                <div class="h-[280px]"><canvas id="volChart"></canvas></div>
             </div>

             <!-- Muscle Distribution Pie Chart -->
             <div class="p-6 bg-glass border border-glass-border rounded-2xl min-h-[350px]">
                <h3 class="text-left text-xs uppercase font-bold text-accent mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie"></i> Muskelfordeling (Sæt)
                </h3>
                <div class="h-[280px] flex items-center justify-center">
                    <canvas id="muscleDistChart"></canvas>
                </div>
             </div>
        </div>

        <!-- WEEKLY VOLUME DASHBOARD -->
        <div class="grid grid-cols-1 gap-6 mb-12 text-left">
            <div class="p-8 bg-glass border border-glass-border rounded-2xl">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h3 class="text-xl font-bold">Ugentlig Volumen-Tracking</h3>
                        <p class="text-sm text-dim">Antal hårde sæt de sidste 7 dage vs. anbefalede mål.</p>
                    </div>
                </div>
                
                <div id="volume-bars" class="space-y-6">
                    <!-- Bars will be injected here via JS -->
                    <div class="animate-pulse space-y-4">
                        <div class="h-4 bg-white/5 rounded w-1/4"></div>
                        <div class="h-8 bg-white/5 rounded"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARDIO CHART -->
        <div class="p-6 bg-glass border border-glass-border rounded-2xl mb-12">
            <h3 class="text-left text-xs uppercase font-bold text-accent mb-6 flex items-center gap-2">
                <i class="fa-solid fa-person-running"></i> Cardio-historik (km)
            </h3>
            <div class="h-[300px] w-full"><canvas id="cardioChart"></canvas></div>
        </div>

        <div class="flex justify-center gap-4">
          <Button href="/blog">Læs om min tilgang</Button>
          <Button href="/" variant="ghost">Tilbage til forsiden</Button>
        </div>
      </Card>
    </Section>
  </main>
</Layout>

<script>
  import Chart from 'chart.js/auto';

  async function initStats() {
    try {
      const res = await fetch('/api/training');
      const logs = await res.json();
      
      if (!logs || logs.length === 0) {
        document.getElementById('stat-tonnage')!.innerText = '0 kg';
        document.getElementById('stat-sessions')!.innerText = '0';
        return;
      }

      // 1. Calculate KPIs
      const totalTonnage = logs.reduce((sum: number, log: any) => sum + (log.tonnage_kg || 0), 0);
      const totalSessions = logs.length;

      document.getElementById('stat-tonnage')!.innerText = (totalTonnage / 1000).toFixed(1) + ' tons';
      document.getElementById('stat-tonnage')!.classList.remove('animate-pulse');
      
      document.getElementById('stat-sessions')!.innerText = totalSessions.toString();
      document.getElementById('stat-sessions')!.classList.remove('animate-pulse');

      // 2. Prepare Chart Data (Group by Week/Date)
      // Simple grouping by Date for now
      const tonnageByDate: Record<string, number> = {};
      const cardioByDate: Record<string, number> = {};

      logs.slice().reverse().forEach((log: any) => {
         const d = log.date;
         if (log.tonnage_kg) tonnageByDate[d] = (tonnageByDate[d] || 0) + log.tonnage_kg;
         if (log.distance_km) cardioByDate[d] = (cardioByDate[d] || 0) + log.distance_km;
      });

      const dates = Object.keys(tonnageByDate);
      const tonnages = dates.map(d => tonnageByDate[d]);
      
      const cDates = Object.keys(cardioByDate);
      const distances = cDates.map(d => cardioByDate[d]);

      // 3. Consistency Heatmap Logic
      const heatmapContainer = document.getElementById('training-heatmap')!;
      heatmapContainer.innerHTML = '';
      
      const today = new Date();
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(today.getMonth() - 6);
      
      // Calculate start date to be a Monday etc
      const startDate = new Date(sixMonthsAgo);
      startDate.setDate(startDate.getDate() - startDate.getDay() + 1);

      const logsByDate: Record<string, number> = {};
      logs.forEach((log: any) => {
          const d = log.date;
          logsByDate[d] = (logsByDate[d] || 0) + 1;
      });

      const dayCount = Math.ceil((today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 7;
      
      for (let i = 0; i < dayCount; i++) {
          const current = new Date(startDate);
          current.setDate(startDate.getDate() + i);
          const dateStr = current.toISOString().split('T')[0];
          const count = logsByDate[dateStr] || 0;
          
          let opacity = 'bg-white/5';
          if (count > 0) opacity = 'bg-accent/20';
          if (count > 2) opacity = 'bg-accent/40';
          if (count > 5) opacity = 'bg-accent/70';
          if (count > 10) opacity = 'bg-accent';

          const square = document.createElement('div');
          square.className = `w-3 h-3 rounded-sm ${opacity} hover:ring-1 hover:ring-white transition-all`;
          square.title = `${dateStr}: ${count} øvelser`;
          heatmapContainer.appendChild(square);
      }

      // 4. Muscle Group Volume Logic
      const muscleMapping: Record<string, string> = {
        'bryst': 'Chest', 'chest': 'Chest', 'incline press': 'Chest', 'fly': 'Chest',
        'ryg': 'Back', 'back': 'Back', 'lat': 'Back', 'row': 'Back', 'deadlift': 'Back', 'pull': 'Back',
        'ben': 'Legs', 'leg': 'Legs', 'squat': 'Legs', 'lunges': 'Legs', 'calf': 'Legs', 'læg': 'Legs', 'hip': 'Legs',
        'skulder': 'Shoulders', 'shoulder': 'Shoulders', 'deltoid': 'Shoulders', 'face pull': 'Shoulders',
        'triceps': 'Arms', 'biceps': 'Arms', 'curl': 'Arms', 'extension': 'Arms', 'pushdown': 'Arms',
        'core': 'Core', 'abs': 'Core', 'mave': 'Core', 'plank': 'Core', 'crunch': 'Core'
      };

      const getMuscleGroup = (name: string) => {
        name = name.toLowerCase();
        for (const [key, value] of Object.entries(muscleMapping)) {
            if (name.includes(key)) return value;
        }
        return 'Other';
      };

      const statsByMuscle: Record<string, { sets: number, weeklySets: number }> = {
        'Chest': { sets: 0, weeklySets: 0 },
        'Back': { sets: 0, weeklySets: 0 },
        'Legs': { sets: 0, weeklySets: 0 },
        'Shoulders': { sets: 0, weeklySets: 0 },
        'Arms': { sets: 0, weeklySets: 0 },
        'Core': { sets: 0, weeklySets: 0 }
      };

      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      logs.forEach((log: any) => {
        const group = getMuscleGroup(log.exercise_name || '');
        if (statsByMuscle[group]) {
            statsByMuscle[group].sets += 1; // Assuming 1 log entry = 1 set from training-program schema, or we can use the sets from the program
            if (new Date(log.date) >= sevenDaysAgo) {
                statsByMuscle[group].weeklySets += 1;
            }
        }
      });

      // Targets
      const targets: Record<string, { min: number, max: number }> = {
        'Chest': { min: 10, max: 15 },
        'Back': { min: 10, max: 15 },
        'Legs': { min: 10, max: 15 },
        'Shoulders': { min: 8, max: 12 },
        'Arms': { min: 6, max: 10 },
        'Core': { min: 6, max: 10 }
      };

      // Render Volume Bars
      const barsContainer = document.getElementById('volume-bars')!;
      barsContainer.innerHTML = '';
      
      Object.entries(statsByMuscle).forEach(([group, data]) => {
        const target = targets[group];
        if (!target) return;
        
        const percentage = Math.min((data.weeklySets / target.max) * 100, 100);
        const statusColor = data.weeklySets >= target.min ? '#baffc9' : '#ffd700';
        
        const barHtml = `
            <div>
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <span class="text-sm font-bold text-white uppercase tracking-wider">${group}</span>
                        <span class="text-[10px] text-white/30 ml-2">Mål: ${target.min}-${target.max} sæt</span>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-black italic text-white">${data.weeklySets}</span>
                        <span class="text-[10px] text-white/30 uppercase font-bold ml-1">Sets</span>
                    </div>
                </div>
                <div class="h-2 w-full bg-white/5 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-1000" style="width: ${percentage}%; background-color: ${statusColor}; box-shadow: 0 0 10px ${statusColor}40"></div>
                </div>
            </div>
        `;
        barsContainer.insertAdjacentHTML('beforeend', barHtml);
      });

      // 4. Render Charts
      const ctxV = document.getElementById('volChart') as HTMLCanvasElement;
      new Chart(ctxV, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [{
            label: 'Tonnage (kg)',
            data: tonnages,
            backgroundColor: '#FFD700',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#ffffff50', font: { size: 10 } }, grid: { display: false } },
            y: { ticks: { color: '#ffffff50', font: { size: 10 } }, grid: { color: '#ffffff10' } }
          }
        }
      });

      // Muscle Distribution Pie Chart
      const ctxM = document.getElementById('muscleDistChart') as HTMLCanvasElement;
      new Chart(ctxM, {
        type: 'doughnut',
        data: {
          labels: Object.keys(statsByMuscle),
          datasets: [{
            data: Object.values(statsByMuscle).map(d => d.sets),
            backgroundColor: ['#ffb3ba', '#baffc9', '#bae1ff', '#ffffba', '#dbdcff', '#ffdfba'],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: { 
            legend: { 
                position: 'right',
                labels: { color: '#ffffff80', font: { size: 10 }, padding: 20, usePointStyle: true }
            } 
          }
        }
      });

      const ctxC = document.getElementById('cardioChart') as HTMLCanvasElement;
      new Chart(ctxC, {
        type: 'line',
        data: {
          labels: cDates,
          datasets: [{
            label: 'Distance (km)',
            data: distances,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#ffffff50', font: { size: 10 } }, grid: { display: false } },
            y: { ticks: { color: '#ffffff50', font: { size: 10 } }, grid: { color: '#ffffff10' } }
          }
        }
      });

    } catch (err) {
      console.error("Stats Error", err);
    }
  }

  // Run on load
  initStats();
</script>
  </main>
</Layout>

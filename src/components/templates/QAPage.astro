---
import Layout from '@layouts/Layout.astro';
import Section from '@components/ui/Section.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import { createClient } from '@supabase/supabase-js';
import qaStatic from '@data/qa.json';

interface Props {
  lang: 'da' | 'en';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

// UI Strings
const t = {
  da: {
    title: "Q&A | Anton Ebsen",
    desc: "Sp√∏rg mig om alt. √òkonomi, kode, tr√¶ning.",
    heroTitle: "Ask Me Anything üé§",
    heroText: "Ingen sp√∏rgsm√•l er for dumme. Her samler jeg svarene.",
    writeTitle: "Stil et sp√∏rgsm√•l",
    writeText: "Det kan v√¶re om studiet, kode, tr√¶ning eller hvilken pizza der er bedst.",
    labelName: "Navn (Valgfrit)",
    holderName: "Anonym",
    labelQ: "Sp√∏rgsm√•l",
    holderQ: "Skriv l√∏s...",
    btnSend: "Send Sp√∏rgsm√•l",
    btnSending: "Sender...",
    success: "Modtaget! Venter p√• svar.",
    error: "Der skete en fejl. Pr√∏v igen.",
    pinnedTitle: "Ofte Stillede",
    recentTitle: "Nylige Svar",
    noRecent: "Ingen nye sp√∏rgsm√•l besvaret endnu. V√¶r den f√∏rste!",
    anonymous: "Anonym"
  },
  en: {
    title: "Q&A | Anton Ebsen",
    desc: "Ask me anything. Economics, code, training.",
    heroTitle: "Ask Me Anything üé§",
    heroText: "No question is too stupid. Here I collect the answers.",
    writeTitle: "Ask a Question",
    writeText: "It can be about studies, code, training, or which pizza is best.",
    labelName: "Name (Optional)",
    holderName: "Anonymous",
    labelQ: "Question",
    holderQ: "Type away...",
    btnSend: "Send Question",
    btnSending: "Sending...",
    success: "Received! Waiting for answer.",
    error: "An error occurred. Try again.",
    pinnedTitle: "Frequently Asked",
    recentTitle: "Recent Answers",
    noRecent: "No new questions answered yet. Be the first!",
    anonymous: "Anonymous"
  }
};

const content = isDa ? t.da : t.en;

// Data Fetching
const supabase = createClient(import.meta.env.SUPABASE_URL, import.meta.env.SUPABASE_ANON_KEY);
let { data: questions, error } = await supabase
    .from('questions')
    .select('*')
    .eq('status', 'answered')
    .order('created_at', { ascending: false });

if (error) questions = [];
---

<Layout 
  title={content.title} 
  description={content.desc}
>
  <main class="max-w-4xl mx-auto px-4 py-12">
     <Section>
        <div class="text-center mb-16">
            <h1 class="text-4xl font-bold mb-4 text-gold-400 drop-shadow-[0_0_15px_rgba(255,215,0,0.3)]">
                {content.heroTitle}
            </h1>
            <p class="text-dim text-lg">
                {content.heroText}
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            
            <!-- LEFT COLUMN: WRITE -->
            <div>
                <div class="sticky top-24">
                    <div class="bg-gray-900/40 p-6 rounded-lg border border-gold-500/20 shadow-[0_0_20px_rgba(255,215,0,0.05)]">
                        <SectionHeading>{content.writeTitle}</SectionHeading>
                        <p class="text-sm text-dim mb-6">{content.writeText}</p>
                        
                        <form id="qa-public-form" class="space-y-4">
                            <div>
                                <label class="block text-xs uppercase text-dim font-bold mb-1">{content.labelName}</label>
                                <input type="text" id="qa-name" placeholder={content.holderName} class="w-full bg-black/50 border border-gray-700 p-3 rounded text-gray-200 focus:border-gold-500 focus:outline-none transition-colors" />
                            </div>
                            <div>
                                <label class="block text-xs uppercase text-dim font-bold mb-1">{content.labelQ}</label>
                                <textarea id="qa-text" rows="4" required placeholder={content.holderQ} class="w-full bg-black/50 border border-gray-700 p-3 rounded text-gray-200 focus:border-gold-500 focus:outline-none transition-colors"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-gold-500 hover:bg-gold-400 text-black font-bold py-3 rounded transition-colors flex items-center justify-center gap-2"
                                    data-send={content.btnSend} data-sending={content.btnSending}>
                                <i class="fa-solid fa-paper-plane"></i> {content.btnSend}
                            </button>
                            <p id="qa-success" class="text-green-400 text-xs text-center hidden"><i class="fa-solid fa-check mr-1"></i> {content.success}</p>
                            <p id="qa-error" class="text-red-400 text-xs text-center hidden"><i class="fa-solid fa-circle-exclamation mr-1"></i> {content.error}</p>
                        </form>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: READ -->
            <div class="space-y-8">
                
                <!-- PINNED -->
                <div class="mb-8">
                    <h3 class="text-gold-500 text-sm font-bold uppercase tracking-widest mb-4 border-b border-gray-800 pb-2">{content.pinnedTitle}</h3>
                    <div class="space-y-6">
                        {qaStatic.pinned.map(item => (
                            <div class="opacity-80 hover:opacity-100 transition-opacity">
                                <h4 class="font-bold text-white mb-1"><i class="fa-solid fa-thumbtack text-gold-500/50 mr-2 text-xs"></i>{isDa ? item.q_da : item.q_en}</h4>
                                <p class="text-dim text-sm leading-relaxed pl-5 border-l-2 border-gray-800">{isDa ? item.a_da : item.a_en}</p>
                            </div>
                        ))}
                    </div>
                </div>

                <!-- DYNAMIC -->
                <div>
                    <h3 class="text-gold-500 text-sm font-bold uppercase tracking-widest mb-4 border-b border-gray-800 pb-2">{content.recentTitle}</h3>
                    <div class="space-y-8">
                        {questions?.map(q => (
                            <div class="group">
                                <h4 class="font-bold text-white mb-2 text-lg">{q.question}</h4>
                                <div class="flex items-center gap-2 mb-3 text-xs text-dim opacity-60">
                                    <span class="bg-gray-800 px-1.5 rounded">{q.asker_name || content.anonymous}</span>
                                    <span>‚Ä¢</span>
                                    <span>{new Date(q.created_at).toLocaleDateString(isDa ? 'da-DK' : 'en-US')}</span>
                                </div>
                                <div class="bg-gray-900/30 p-4 rounded border border-white/5 relative group-hover:border-gold-500/20 transition-colors">
                                    <i class="fa-solid fa-quote-left absolute top-3 left-3 text-4xl text-white/5 -z-10"></i>
                                    <p class="text-gray-300 leading-relaxed whitespace-pre-line">{q.answer}</p>
                                </div>
                            </div>
                        ))}
                        {questions?.length === 0 && (
                            <p class="text-dim text-sm italic">{content.noRecent}</p>
                        )}
                    </div>
                </div>

            </div>
        </div>
     </Section>
  </main>

<script>
    const form = document.getElementById('qa-public-form');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = (e.target as HTMLFormElement).querySelector('button')!;
            const successMsg = document.getElementById('qa-success')!;
            const errorMsg = document.getElementById('qa-error')!;
            
            const originalTextHTML = btn.innerHTML;
            const sendingText = btn.getAttribute('data-sending') || "Sending...";

            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${sendingText}`;
            btn.disabled = true;
            successMsg.classList.add('hidden');
            errorMsg.classList.add('hidden');

            const question = (document.getElementById('qa-text') as HTMLTextAreaElement).value;
            const asker_name = (document.getElementById('qa-name') as HTMLInputElement).value;

            try {
                await fetch('/api/qa', {
                    method: 'POST',
                    body: JSON.stringify({ question, asker_name })
                });
                
                (e.target as HTMLFormElement).reset();
                successMsg.classList.remove('hidden');
                setTimeout(() => {
                    successMsg.classList.add('hidden');
                }, 5000);
            } catch (err) {
                console.error(err);
                errorMsg.classList.remove('hidden');
            } finally {
                btn.innerHTML = originalTextHTML;
                btn.disabled = false;
            }
        });
    }
</script>

</Layout>

---
interface Props {
  courses: any[];
  lang: 'da' | 'en';
}

const { courses, lang } = Astro.props;
const isDa = lang === 'da';

// 1. Definition of Specialization Categories
// Each category has a set of tags/keywords, a threshold, and a visual style
const specializations = [
  {
    id: 'macro',
    labels: { da: 'Makroøkonomisk Ekspert', en: 'Macroeconomics Expert' },
    keywords: ['Makro', 'Macro', 'Business Cycles', 'General Equilibrium', 'CGE', 'Financial System', 'SVAR'],
    color: 'accent',
    icon: 'fa-chart-line',
    threshold: 22.5 // ECTS
  },
  {
    id: 'quant',
    labels: { da: 'Kvantitativ Specialist', en: 'Quantitative Specialist' },
    keywords: ['Metode', 'Method', 'Økonometri', 'Econometrics', 'Coding', 'Programming', 'GAMS', 'MATLAB', 'Python', 'Numerical Analysis'],
    color: 'indigo-400',
    icon: 'fa-code',
    threshold: 30
  },
  {
    id: 'ai',
    labels: { da: 'AI & Data Practitioner', en: 'AI & Data Practitioner' },
    keywords: ['AI', 'Machine Learning', 'Neural Networks', 'Causal Inference', 'Algorithmic'],
    color: 'emerald-400',
    icon: 'fa-brain',
    threshold: 7.5
  },
  {
    id: 'finance',
    labels: { da: 'Finansiel Analytiker', en: 'Financial Analyst' },
    keywords: ['Finans', 'Finance', 'Asset Pricing', 'Decision Making', 'Markets'],
    color: 'amber-400',
    icon: 'fa-coins',
    threshold: 15
  }
];

// 2. Logic to calculate earned ECTS per specialization
const achievements = specializations.map(spec => {
  const earnedEcts = courses.reduce((sum, course) => {
    const ects = parseFloat(course.ects || '0');
    if (isNaN(ects)) return sum;

    // Match by tag OR search in syllabus/description/title
    const matchesTag = spec.keywords.some(k => 
      course.tag?.toLowerCase().includes(k.toLowerCase()) ||
      course.title?.toLowerCase().includes(k.toLowerCase()) ||
      course.syllabus?.some((s: string) => s.toLowerCase().includes(k.toLowerCase()))
    );

    return matchesTag ? sum + ects : sum;
  }, 0);

  return {
    ...spec,
    earnedEcts,
    isUnlocked: earnedEcts >= spec.threshold
  };
}).filter(a => a.isUnlocked); // Only show unlocked badges
---

<div class="flex flex-wrap gap-3 mt-6">
  {achievements.map((badge, index) => (
    <div 
      class="badge-container group relative"
      style={`--delay: ${index * 0.1}s; --badge-color: ${badge.color === 'accent' ? 'var(--accent)' : badge.color}`}
    >
      <div class="flex items-center gap-2.5 px-4 py-2 rounded-full bg-white/[0.03] border border-white/5 hover:border-white/10 transition-all duration-300 hover:bg-white/[0.05] cursor-default">
        <div class="w-2 h-2 rounded-full" style={`background-color: var(--badge-color); box-shadow: 0 0 10px var(--badge-color);`}></div>
        <i class={`fa-solid ${badge.icon} text-[10px] opacity-40 group-hover:opacity-100 transition-opacity`} style={`color: var(--badge-color)`}></i>
        <span class="text-[10px] font-black uppercase tracking-widest text-white/70 group-hover:text-white transition-colors">
          {badge.labels[lang]}
        </span>
      </div>

      {/* Tooltip with ECTS progress */}
      <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 opacity-0 group-hover:opacity-100 transition-all duration-200 pointer-events-none translate-y-2 group-hover:translate-y-0">
        <div class="bg-black/90 backdrop-blur-xl border border-white/10 px-3 py-1.5 rounded-lg whitespace-nowrap">
          <p class="text-[9px] font-bold text-white/50 uppercase tracking-tighter">
            {isDa ? 'Kvalificeret via' : 'Qualified through'} <span class="text-white">{badge.earnedEcts} ECTS</span>
          </p>
        </div>
        <div class="w-2 h-2 bg-black/90 border-r border-b border-white/10 rotate-45 absolute -bottom-1 left-1/2 -translate-x-1/2"></div>
      </div>
    </div>
  ))}
</div>

<style>
  .badge-container {
    animation: badge-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    animation-delay: var(--delay);
    opacity: 0;
    transform: scale(0.9) translateY(5px);
  }

  @keyframes badge-pop {
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .badge-container::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 9999px;
    background: radial-gradient(circle at center, var(--badge-color) 0%, transparent 70%);
    opacity: 0;
    filter: blur(15px);
    transition: opacity 0.3s;
    z-index: -1;
  }

  .badge-container:hover::before {
    opacity: 0.15;
  }
</style>

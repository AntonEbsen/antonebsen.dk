---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import Pill from '@components/ui/Pill.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';
import { getEntry } from 'astro:content';
import { supabase } from '@lib/supabase';

// New Components
import EducationTimeline from '@components/education/EducationTimeline.astro';
import ThesisSpotlight from '@components/education/ThesisSpotlight.astro';
import TeachingStatsWidget from '@components/education/TeachingStatsWidget.astro';

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

// 1. UI Content
const pageEntry = await getEntry('pages', `${lang}/education`);
if (!pageEntry) throw new Error(`Missing pages entry for ${lang}/education`);
const content: any = pageEntry.data; 

// 2. CV Data
const cvEntry = await getEntry('cv', lang);
if (!cvEntry) throw new Error(`Missing cv entry for ${lang}`);
const cv = cvEntry.data;

// Data Fetching for Education (JSON)
const experience = cv.education || [];
// Matches based on keywords, could be improved with IDs in JSON
const ku = experience.find(e => e.institution.includes("Copenhagen") || e.institution.includes("Københavns Universitet"));
const hhx = experience.find(e => e.degree.includes("HHX"));

// Data Fetching for Projects (Supabase)
let projects = [];
let projError = null;

if (supabase) {
  const res = await supabase
    .from('projects')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(3);
  projects = res.data || [];
  projError = res.error;
}

if (projError) projects = [];

const certificationLink = isDa ? '/certifications' : '/en/certifications';
const cvLink = isDa ? '/cv' : '/en/cv';

// Data Construction for Timeline
const timelineEvents = [
    {
        year: '2021 – Present',
        title: ku?.degree || 'MSc Economics',
        institution: ku?.institution || 'University of Copenhagen',
        description: ku?.description || '',
        type: 'degree',
        progress: 85
    },
    {
        year: '2023 – Present',
        title: isDa ? 'Studenterunderviser' : 'Teaching Assistant',
        institution: 'Djøf',
        description: isDa ? 'Undervisning i Excel & VBA.' : 'Teaching Excel & VBA.',
        type: 'job'
    },
    {
        year: '2021',
        title: isDa ? 'Bachelor i Økonomi' : 'BSc in Economics',
        institution: 'University of Copenhagen',
        description: isDa ? 'Speciale i Global Financial Cycle.' : 'Thesis on Global Financial Cycle.',
        type: 'degree'
    },
    {
        year: '2018 – 2021',
        title: hhx?.degree || 'HHX',
        institution: hhx?.institution || 'Celf',
        description: hhx?.description || '',
        type: 'degree'
    }
];

// Data for Thesis
const thesis = {
    title: "Global Financial Cycle & Spillovers",
    subtitle: isDa ? "Bachelorprojekt i Økonomi" : "Bachelor's Thesis in Economics",
    description: isDa 
        ? "En økonometrisk analyse af hvordan amerikansk pengepolitik påvirker globale finansielle markeder. Brug af SVAR-modeller og højfrekvente data."
        : "An econometric analysis of US monetary policy spillovers to global financial markets using SVAR models and high-frequency data.",
    tags: ["Econometrics", "Python", "Monetary Policy", "Time Series"],
    downloadLink: "#", 
    codeLink: "https://github.com/AntonEbsen" 
};

// Teaching Stats
const teachingStats = [
    isDa ? "Gennemsnitlig score: <strong>4.8 / 5.0</strong>" : "Average Score: <strong>4.8 / 5.0</strong>",
    isDa ? "Antal kursister: <strong>500+</strong>" : "Students Taught: <strong>500+</strong>",
    isDa ? "Fag: Excel, VBA, Power Query" : "Subjects: Excel, VBA, Power Query"
];
---

<Layout 
  title={content.title}
  description={content.desc}
  bodyClass="edu-page"
>
  <style>
    .edu-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }
    
    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px;
      align-items: start;
    }

    .courses-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 14px;
      margin-top: 12px;
    }

    .main-grid {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        gap: 24px;
        margin-top: 24px;
    }

    @media (max-width: 980px) {
      .hero-grid, .courses-grid, .main-grid { 
        grid-template-columns: 1fr; 
      }
    }
  </style>

  <main class="edu-wrap">

    <!-- HERO -->
    <Section>
      <div class="hero-grid">
        <Card variant="glass" class="p-6">
          <p class="text-xs font-extrabold uppercase tracking-wider text-dim mb-3">{isDa ? 'Uddannelse' : 'Education'}</p>
          <h1 class="text-4xl leading-tight mb-4 font-bold">{content.hero.title}</h1>
          <p class="text-lg leading-relaxed text-dim mb-6">
            {content.hero.text}
          </p>
  
          <div class="flex flex-wrap gap-3 mb-6">
            <Button href="#timeline">{isDa ? 'Tidslinje' : 'Timeline'}</Button>
            <Button href="#courses" variant="ghost">{content.hero.buttons.course}</Button>
            <Button href="#thesis" variant="ghost">{isDa ? 'Speciale' : 'Thesis'}</Button>
          </div>
  
          <div class="flex flex-wrap gap-2">
            {content.hero.pills.map(p => <Pill variant="accent">{p}</Pill>)}
          </div>
        </Card>
  
        <div class="hidden md:block">
           <TeachingStatsWidget 
                title={isDa ? "Undervisning" : "Teaching Impact"}
                stats={teachingStats}
                link={isDa ? '/kursusstatistik' : '/en/course-stats'}
                linkText={isDa ? "Se fuld rapport" : "View Full Report"}
           />
        </div>
      </div>
    </Section>

    <div class="main-grid">
        <div class="flex flex-col gap-8">
            <!-- TIMELINE -->
            <Section id="timeline">
                 <EducationTimeline 
                    title={isDa ? "Min Akademiske Rejse" : "My Academic Journey"} 
                    events={timelineEvents}
                 />
            </Section>

            <!-- THESIS SPOTLIGHT -->
            <Section id="thesis">
                <ThesisSpotlight 
                    title={thesis.title}
                    subtitle={thesis.subtitle}
                    description={thesis.description}
                    tags={thesis.tags}
                    downloadLink={thesis.downloadLink}
                    codeLink={thesis.codeLink}
                />
            </Section>
        </div>

        <div class="flex flex-col gap-6">
             <!-- Mobile Stats (visible only on small screens if we wanted, but here sticking to grid logic) -->
             <div class="md:hidden">
                 <TeachingStatsWidget 
                    title={isDa ? "Undervisning" : "Teaching Impact"}
                    stats={teachingStats}
                    link={isDa ? '/kursusstatistik' : '/en/course-stats'}
                    linkText={isDa ? "Se fuld rapport" : "View Full Report"}
                />
             </div>

             <!-- Short Bio Card (moved here) -->
             <Card variant="glass" class="p-6 sticky top-6">
                <SectionHeading>{content.short.title}</SectionHeading>
                <p class="text-[13px] text-dim mb-4 opacity-70">
                  {content.short.text}
                </p>
                <Button href={`${cvLink}#education`} variant="ghost" class="w-full">{content.short.btn}</Button>
             </Card>
        </div>
    </div>


    <!-- COURSES NETWORK -->
    <Section id="courses" class="mt-12">
      <Card variant="bordered" class="p-6">
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
            <div>
                <SectionHeading>{content.courses.title}</SectionHeading>
                <p class="text-dim opacity-70 max-w-xl">
                  {content.courses.tip}
                </p>
            </div>
            
            <!-- Filter Controls -->
            <div class="flex flex-wrap gap-2" id="course-filters">
                <button class="text-xs font-bold px-3 py-1.5 rounded-full bg-accent text-black transition-all filter-btn active" data-filter="all">All</button>
                <button class="text-xs font-bold px-3 py-1.5 rounded-full bg-white/5 text-dim border border-white/10 hover:bg-white/10 transition-all filter-btn" data-filter="Makro">Macro</button>
                <button class="text-xs font-bold px-3 py-1.5 rounded-full bg-white/5 text-dim border border-white/10 hover:bg-white/10 transition-all filter-btn" data-filter="Coding">Tech</button>
                <button class="text-xs font-bold px-3 py-1.5 rounded-full bg-white/5 text-dim border border-white/10 hover:bg-white/10 transition-all filter-btn" data-filter="Modeller">Models</button>
            </div>
        </div>

        <div class="courses-grid" id="courses-grid">
          {cv.courses && cv.courses.map(course => (
            <div class="course-item" data-tag={course.tag}>
                <Card variant="bordered" class="flex flex-col h-full bg-glass">
                  <div class="flex justify-between items-start mb-3 gap-2">
                    <h3 class="text-[16px] font-bold leading-tight m-0">{course.title}</h3>
                    <Pill variant="accent" class="shrink-0">{course.tag}</Pill>
                  </div>
                  <p class="text-[13px] text-dim mb-3">{course.institution}</p>
                  <p class="text-[14px] text-dim opacity-80 leading-relaxed mb-4 flex-grow">
                    {course.description}
                  </p>
                  <div class="flex flex-wrap gap-2 mt-auto">
                    {course.links && course.links.map(link => (
                      <a href={link.href} class="text-xs font-bold text-accent no-underline hover:text-white transition-colors">{link.text} →</a>
                    ))}
                  </div>
                </Card>
            </div>
          ))}
        </div>
      </Card>
    </Section>

    <!-- PROJECTS (Keeping existing section) -->
    <Section id="projects" class="mt-12">
      <Card variant="bordered" class="p-6">
        <SectionHeading>{content.projects.title}</SectionHeading>

        <div class="courses-grid">
          {projects.map(proj => (
            <Card variant="bordered" class="flex flex-col h-full bg-glass">
              <div class="flex justify-between items-start mb-3 gap-2">
                <h3 class="text-[16px] font-bold leading-tight m-0">{proj.title}</h3>
                <Pill variant="accent" class="shrink-0">{proj.tags && proj.tags[0] ? proj.tags[0] : 'Project'}</Pill>
              </div>
              <p class="text-[14px] text-dim opacity-80 leading-relaxed mb-4 flex-grow">
                {proj.description}
              </p>
              <div class="flex flex-wrap gap-2 mt-auto">
                 {proj.url && (
                  <a href={proj.url} class="text-xs font-bold text-accent no-underline hover:text-white transition-colors">View Project →</a>
                 )}
              </div>
            </Card>
          ))}
        </div>
        <div class="mt-6 text-center">
            <Button href={isDa ? '/portfolio' : '/en/portfolio'} variant="ghost">{content.projects.btn}</Button>
        </div>
      </Card>
    </Section>

    <!-- CTA -->
    <Section class="mt-12">
      <Card variant="default" class="p-6">
        <div class="mt-8 pt-8 border-t border-white/5 reveal reveal-slide-up" data-delay="300">
           <p class="text-dim opacity-70 mb-6">{content.cta?.text}</p>
           <div class="flex flex-wrap gap-4">
           {isDa && (
           <Button href={certificationLink}>{content.cta?.btn}</Button>
           )}
           <Button href={isDa ? '/contact' : '/en/contact'} variant="ghost">{content.cta?.contactBtn}</Button>
           </div>
         </div>
      </Card>
    </Section>

  </main>

  <script>
      // Filtering Logic
      const buttons = document.querySelectorAll('.filter-btn');
      const items = document.querySelectorAll('.course-item');

      buttons.forEach(btn => {
          btn.addEventListener('click', () => {
              // Toggle active state
              buttons.forEach(b => {
                  b.classList.remove('bg-accent', 'text-black');
                  b.classList.add('bg-white/5', 'text-dim');
              });
              btn.classList.remove('bg-white/5', 'text-dim');
              btn.classList.add('bg-accent', 'text-black');

              const filter = btn.getAttribute('data-filter');

              items.forEach(item => {
                  const tag = item.getAttribute('data-tag');
                  if (filter === 'all' || tag === filter) {
                      item.style.display = 'block';
                      item.classList.add('animate-fade-in');
                  } else {
                      item.style.display = 'none';
                  }
              });
          });
      });
  </script>
</Layout>

---
import Layout from '@layouts/Layout.astro';
import group from '../data/group.json';
import { createClient } from '@supabase/supabase-js';

export const prerender = false;

let error = "";
let authenticated = false;

// Supabase Init
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseKey = import.meta.env.SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const password = data.get("password")?.toString().toLowerCase();
        
        if (password === "manifestet") {
            authenticated = true;
        } else {
            error = "Uværdig kode! Prøv igen, kammerat.";
        }
    } catch (e) {
        error = "Kontrarevolutionær fejl opstået.";
    }
}

// Fetch Events (Try-catch for missing table)
let events = [];
try {
    const { data: eventData } = await supabase
        .from('study_group_events')
        .select('*')
        .order('date', { ascending: true });
    events = eventData || [];
} catch (e) {
    console.warn("Table study_group_events not found yet.");
}

// Mock Milestones
const milestones = [
    { id: 1, title: "Problemformulering", status: "Komplet", project: "Seminar" },
    { id: 2, title: "Dataindsamling", status: "I gang", project: "Seminar" },
    { id: 3, title: "Litteraturgennemgang", status: "Planlagt", project: "Speciale" }
];
---

<Layout title="Kollektivet | De tre kammerater" description="Koordinationsportal for Stalin, Mao og Che">
    <main class="min-h-screen bg-[#0a0a0a] text-white font-sans selection:bg-red-600/30">
        
        {!authenticated ? (
            <div class="h-screen flex flex-col items-center justify-center px-6 relative overflow-hidden">
                {/* Revolutionary Background Elements */}
                <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-red-600 blur-[150px] rounded-full"></div>
                </div>

                <div class="max-w-md w-full relative z-10 space-y-12 text-center">
                    <div class="space-y-4">
                        <div class="w-24 h-24 bg-red-700/20 border border-red-600/40 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-[0_0_50px_rgba(185,28,28,0.2)] group hover:scale-105 transition-transform duration-500">
                             <i class="fa-solid fa-flag text-red-600 text-4xl animate-pulse"></i>
                        </div>
                        <h1 class="text-4xl font-black uppercase tracking-tighter italic text-white leading-none">De tre kammerater</h1>
                        <p class="text-red-500/60 font-medium uppercase tracking-[0.2em] text-[10px]">Eksklusiv adgang for kollektivet</p>
                    </div>

                    <form method="POST" class="space-y-4">
                        <div class="relative group">
                            <input 
                                type="password" 
                                name="password" 
                                placeholder="Indtast revolutions-koden..." 
                                required
                                class="w-full bg-white/[0.03] border border-white/10 rounded-2xl px-6 py-4 text-white placeholder:text-white/20 focus:outline-none focus:border-red-600/50 focus:ring-4 focus:ring-red-600/10 transition-all text-center tracking-widest"
                            />
                        </div>
                        {error && <p class="text-red-500 text-xs font-bold animate-bounce uppercase tracking-widest">{error}</p>}
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-black uppercase tracking-widest py-4 rounded-2xl transition-all shadow-[0_0_30px_rgba(185,28,28,0.3)] active:scale-[0.98]">
                            Tilgå Portalen
                        </button>
                    </form>

                    <p class="text-white/10 text-[10px] font-medium uppercase tracking-widest">"Proletarer i alle lande, foren eder!"</p>
                </div>
            </div>
        ) : (
            <div class="animate-in fade-in duration-1000">
                {/* Authenticated Dashboard */}
                <nav class="fixed top-0 left-0 w-full z-[100] px-8 py-10 flex justify-between items-center bg-gradient-to-b from-black to-transparent">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-red-600 flex items-center justify-center rounded-lg shadow-glow-red">
                            <i class="fa-solid fa-star text-white text-lg"></i>
                        </div>
                        <span class="font-black uppercase tracking-tighter text-xl italic pt-1">De tre kammerater</span>
                    </div>
                    <a href="/" class="text-[10px] font-black uppercase tracking-widest text-red-600/60 hover:text-red-500 transition-colors">Log ud <i class="fa-solid fa-right-from-bracket ml-2"></i></a>
                </nav>

                <div class="max-w-7xl mx-auto px-8 pt-40 pb-32 space-y-32">
                    
                    {/* Header Section */}
                    <section class="grid grid-cols-1 lg:grid-cols-2 gap-20 items-end">
                        <div class="space-y-8">
                            <div class="space-y-4">
                                <span class="bg-red-600/10 text-red-600 px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border border-red-600/20 shadow-sm">Kollektiv Status: Aktiv</span>
                                <h2 class="text-6xl md:text-8xl font-black italic tracking-tighter leading-none text-white">Den Akademiske <br/> <span class="text-red-600">Revolution</span></h2>
                            </div>
                            <p class="text-white/40 text-lg max-w-lg leading-relaxed italic">
                                Placeringscenter for seminaropgaven og det kommende speciale. Her koordinerer vi vores indsats for at opnå det ultimative akademiske resultat.
                            </p>
                        </div>
                        
                        <div class="bg-white/[0.03] border border-white/5 rounded-[48px] p-10 flex items-center justify-between group hover:border-red-600/30 transition-all duration-500">
                            <div class="space-y-2">
                                <p class="text-[10px] font-black uppercase tracking-widest text-red-600">Dagens Manifest</p>
                                <p class="text-xl font-bold italic text-white/90">"Hver yder efter evne, hver modtager efter behov."</p>
                            </div>
                            <i class="fa-solid fa-quote-right text-4xl text-red-600/20 group-hover:text-red-600/40 transition-colors"></i>
                        </div>
                    </section>

                    {/* Members Grid */}
                    <section class="space-y-16">
                        <div class="flex items-center gap-6">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic">Kameraterne</h3>
                            <div class="h-px flex-1 bg-white/5"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            {group.map(member => (
                                <div class="bg-white/[0.02] border border-white/5 rounded-[40px] p-8 space-y-6 group hover:bg-white/[0.04] hover:border-red-600/20 transition-all duration-500">
                                    <div class="relative w-20 h-20 mx-auto">
                                        <div class="absolute inset-0 bg-red-600 rounded-2xl blur-2xl opacity-0 group-hover:opacity-20 transition-opacity"></div>
                                        <img src={member.image} alt={member.name} class="w-full h-full rounded-2xl grayscale group-hover:grayscale-0 transition-all duration-700 relative z-10" />
                                    </div>
                                    <div class="text-center space-y-2">
                                        <h4 class="text-lg font-black uppercase tracking-tight text-white">{member.alias}</h4>
                                        <p class="text-red-600 text-[10px] font-black uppercase tracking-widest">{member.role}</p>
                                        <p class="text-white/30 text-[11px] leading-relaxed italic pt-4">{member.description}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>

                    {/* Coordination Board */}
                    <section class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                        
                        {/* Calendar Board */}
                        <div class="lg:col-span-2 space-y-12">
                            <div class="flex items-center justify-between">
                                <h3 class="text-3xl font-black uppercase tracking-tighter italic">Kollektiv Kalender</h3>
                                <button class="bg-red-600/10 hover:bg-red-600 text-red-600 hover:text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest border border-red-600/20 transition-all shadow-sm">Planlæg Møde +</button>
                            </div>

                            <div class="grid grid-cols-1 gap-4">
                                {events.length > 0 ? events.map(event => (
                                    <div class="flex items-center gap-6 p-6 bg-white/[0.03] border border-white/5 rounded-3xl hover:border-red-600/30 transition-all group">
                                        <div class="w-16 h-16 flex flex-col items-center justify-center bg-red-600/10 rounded-2xl border border-red-600/20 group-hover:bg-red-600 group-hover:text-white transition-all text-red-600">
                                            <span class="text-xs font-black uppercase">{new Date(event.date).toLocaleDateString('da-DK', { month: 'short' })}</span>
                                            <span class="text-xl font-black leading-none">{new Date(event.date).getDate()}</span>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="font-bold text-lg text-white group-hover:text-red-500 transition-colors uppercase tracking-tight">{event.title}</h4>
                                            <p class="text-white/40 text-xs italic">{event.location || "Lokation uafklaret"}</p>
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-white/10 mr-4"></i>
                                    </div>
                                )) : (
                                    <div class="p-20 border-2 border-dashed border-white/5 rounded-[40px] text-center space-y-4">
                                        <i class="fa-solid fa-calendar-xmark text-white/5 text-5xl"></i>
                                        <p class="text-white/20 font-medium italic">Ingen planlagte møder fundet. <br/> Socialisér kalenderen for at komme i gang.</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Progress Tracker */}
                        <div class="space-y-12">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic text-red-600">Fremgang</h3>
                            
                            <div class="space-y-10 p-10 bg-white/[0.03] border border-white/5 rounded-[48px] relative overflow-hidden group">
                                <div class="absolute top-0 right-0 w-32 h-32 bg-red-600/5 blur-3xl rounded-full"></div>
                                
                                <div class="space-y-8">
                                    <div class="space-y-4">
                                        <div class="flex justify-between text-[10px] font-black uppercase tracking-widest mb-2">
                                            <span class="text-white/40">Seminaropgave</span>
                                            <span class="text-red-600">35%</span>
                                        </div>
                                        <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                                            <div class="h-full bg-red-600 w-[35%] shadow-[0_0_15px_rgba(185,28,28,0.5)]"></div>
                                        </div>
                                    </div>

                                    <div class="space-y-4 pt-4 border-t border-white/5">
                                        <div class="flex justify-between text-[10px] font-black uppercase tracking-widest mb-2">
                                            <span class="text-white/40">Kandidatspeciale</span>
                                            <span class="text-red-600">5%</span>
                                        </div>
                                        <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                                            <div class="h-full bg-red-600 w-[5%] shadow-[0_0_15px_rgba(185,28,28,0.5)]"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-6 pt-10">
                                    <p class="text-[10px] font-black uppercase tracking-widest text-white/60 italic">Milestones</p>
                                    <div class="space-y-4">
                                        {milestones.map(m => (
                                            <div class="flex items-center gap-4 group/item">
                                                <div class={`w-4 h-4 rounded-md border ${m.status === 'Komplet' ? 'bg-red-600 border-red-600 shadow-glow-red' : 'border-white/20'} flex items-center justify-center transition-all`}>
                                                    {m.status === 'Komplet' && <i class="fa-solid fa-check text-[8px] text-white"></i>}
                                                </div>
                                                <span class={`text-[11px] font-medium tracking-wide ${m.status === 'Komplet' ? 'text-white/80 line-through' : 'text-white/40'}`}>{m.title}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </section>

                    {/* Resource Vault & Productivity Section (New) */}
                    <section class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                        
                        {/* Resource Vault */}
                        <div class="space-y-12">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic">Ressource-Hvælvingen</h3>
                            <div class="grid grid-cols-1 gap-4">
                                {[
                                    { name: "Overleaf: Seminaropgave", url: "#", icon: "fa-leaf" },
                                    { name: "Fælles Google Drive", url: "#", icon: "fa-brands fa-google-drive" },
                                    { name: "GitHub Repository", url: "#", icon: "fa-brands fa-github" },
                                    { name: "Litteraturliste (Mendeley)", url: "#", icon: "fa-book" }
                                ].map(link => (
                                    <a href={link.url} class="flex items-center justify-between p-6 bg-white/[0.03] border border-white/5 rounded-3xl hover:border-red-600/30 transition-all group">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 bg-red-600/10 rounded-xl flex items-center justify-center text-red-600 group-hover:bg-red-600 group-hover:text-white transition-all">
                                                <i class={`fa-solid ${link.icon}`}></i>
                                            </div>
                                            <span class="font-bold text-white uppercase tracking-tight">{link.name}</span>
                                        </div>
                                        <i class="fa-solid fa-arrow-up-right-from-square text-white/10 group-hover:text-red-600 transition-colors"></i>
                                    </a>
                                ))}
                            </div>
                        </div>

                        {/* Revolutionary Pomodoro Timer */}
                        <div class="space-y-12">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic text-red-600">Arbejdsdisciplin</h3>
                            <div class="p-10 bg-white/[0.03] border border-white/5 rounded-[48px] text-center space-y-8 relative overflow-hidden">
                                <div class="space-y-2">
                                    <p class="text-[10px] font-black uppercase tracking-widest text-white/40">Revolutionary Work-Timer</p>
                                    <div id="timer-display" class="text-7xl font-black tabular-nums tracking-tighter text-white">25:00</div>
                                </div>
                                
                                <div class="flex justify-center gap-4">
                                    <button id="timer-start" class="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-black uppercase tracking-widest rounded-xl transition-all shadow-glow-red">Start</button>
                                    <button id="timer-reset" class="px-8 py-3 bg-white/5 hover:bg-white/10 text-white/60 font-black uppercase tracking-widest rounded-xl transition-all">Reset</button>
                                </div>

                                <p class="text-[10px] font-medium text-white/20 uppercase tracking-widest italic pt-4">"Ingen pause uden produktion."</p>
                            </div>
                        </div>
                    </section>

                    {/* Collective Decisions (Polls) Section (New) */}
                    <section class="max-w-4xl mx-auto space-y-16">
                        <div class="flex items-center gap-6">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic">Kollektive Beslutninger</h3>
                            <div class="h-px flex-1 bg-white/5"></div>
                        </div>

                        <div class="bg-white/[0.02] border border-white/5 rounded-[48px] p-12 space-y-8">
                            <div class="space-y-2">
                                <p class="text-[10px] font-black uppercase tracking-widest text-red-600">Næste afstemning</p>
                                <h4 class="text-2xl font-bold text-white">Hvor skal vi mødes næste gang?</h4>
                            </div>

                            <div class="space-y-4">
                                {[
                                    { label: "CSS (Center for Sundhed og Samfund)", votes: 2, total: 3 },
                                    { label: "Grønjordskollegiet (Hos Stalin)", votes: 1, total: 3 },
                                    { label: "Det Kgl. Bibliotek", votes: 0, total: 3 }
                                ].map(option => (
                                    <button class="w-full relative p-6 bg-white/[0.03] border border-white/5 rounded-2xl hover:border-red-600/20 transition-all text-left group overflow-hidden">
                                        <div class="relative z-10 flex justify-between items-center">
                                            <span class="font-bold text-white/80 group-hover:text-white transition-colors">{option.label}</span>
                                            <span class="text-red-600 font-black text-xs">{option.votes} / {option.total}</span>
                                        </div>
                                        <div class="absolute left-0 top-0 h-full bg-red-600/10 transition-all duration-1000" style={`width: ${(option.votes / option.total) * 100}%`}></div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </section>

                    {/* Phase 3: Den Røde Bog & Dekret-tavlen */}
                    <section class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                        
                        {/* Den Røde Bog (Reading List) */}
                        <div class="space-y-12">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic">Den Røde Bog <span class="text-red-600 text-sm">(Læseliste)</span></h3>
                            <div class="space-y-4">
                                {[
                                    { title: "Capital in the 21st Century", author: "Piketty", readers: ["Stalin", "Mao"] },
                                    { title: "Macroeconomic Theory", author: "Romer", readers: ["Che"] },
                                    { title: "Seminar Core Paper #1", author: "Kollektivet", readers: ["Mao"] }
                                ].map(book => (
                                    <div class="p-6 bg-white/[0.03] border border-white/5 rounded-3xl group hover:border-red-600/20 transition-all">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="space-y-1">
                                                <h4 class="font-bold text-white uppercase tracking-tight">{book.title}</h4>
                                                <p class="text-white/40 text-xs italic">{book.author}</p>
                                            </div>
                                            <i class="fa-solid fa-book-open text-red-600/20 group-hover:text-red-600 transition-colors"></i>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            {book.readers.map(reader => (
                                                <span class="px-2 py-1 bg-red-600/10 border border-red-600/20 rounded-md text-[8px] font-black uppercase tracking-widest text-red-600">
                                                    Læst af {reader}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Dekret-tavlen (Message Board) */}
                        <div class="space-y-12">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic text-red-600">Dekret-tavlen</h3>
                            <div class="p-10 bg-white/[0.02] border border-white/5 rounded-[48px] space-y-8 relative overflow-hidden">
                                <div class="absolute -top-10 -right-10 w-40 h-40 bg-red-600/5 blur-3xl rounded-full"></div>
                                <div class="space-y-6">
                                    {[
                                        { from: "Stalin", msg: "Nyt udkast til seminaropgaven ligger på Overleaf. Til gennemsyn!", time: "2 timer siden" },
                                        { from: "Che", msg: "Jeg tager kaffe og croissanter med på tirsdag. Husk kopper!", time: "5 timer siden" }
                                    ].map(decree => (
                                        <div class="space-y-2 border-l-2 border-red-600/30 pl-6 py-2">
                                            <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-red-600">
                                                <span>Kamerat {decree.from}</span>
                                                <span class="text-white/20">{decree.time}</span>
                                            </div>
                                            <p class="text-sm font-medium italic text-white/80">"{decree.msg}"</p>
                                        </div>
                                    ))}
                                </div>
                                <button class="w-full py-4 bg-white/5 hover:bg-white/10 text-white/40 hover:text-white font-black uppercase tracking-widest rounded-2xl transition-all border border-dashed border-white/10">Udsted nyt dekret +</button>
                            </div>
                        </div>
                    </section>

                    {/* Kollektivkassen (Ledger) */}
                    <section class="max-w-4xl mx-auto space-y-16">
                        <div class="flex items-center gap-6">
                            <h3 class="text-3xl font-black uppercase tracking-tighter italic">Kollektivkassen <span class="text-red-600 text-sm">(Regnskab)</span></h3>
                            <div class="h-px flex-1 bg-white/5"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {[
                                { name: "Stalin", balance: -50, item: "Print & Papir" },
                                { name: "Mao", balance: 120, item: "Specialkaffe" },
                                { name: "Che", balance: -70, item: "Snacks" }
                            ].map(entry => (
                                <div class="p-8 bg-white/[0.03] border border-white/5 rounded-[40px] text-center space-y-4 group hover:border-red-600/20 transition-all">
                                    <h4 class="text-lg font-black uppercase tracking-tight text-white/60">{entry.name}</h4>
                                    <div class={`text-3xl font-black tabular-nums ${entry.balance >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                                        {entry.balance >= 0 ? '+' : ''}{entry.balance} kr.
                                    </div>
                                    <p class="text-[10px] font-black uppercase tracking-widest text-white/20 italic">Sidst: {entry.item}</p>
                                </div>
                            ))}
                        </div>
                        <p class="text-center text-[10px] text-white/10 uppercase tracking-[0.2em]">Retfærdighed gennem ligelig fordeling af kaffe-omkostninger.</p>
                    </section>

                    {/* Footer / Manifesto */}
                    <footer class="pt-20 border-t border-white/5 text-center space-y-8">
                        <div class="flex justify-center gap-4 text-red-600/20 text-4xl">
                            <i class="fa-solid fa-hammer"></i>
                            <i class="fa-solid fa-gear"></i>
                        </div>
                        <p class="text-dim text-[10px] font-black uppercase tracking-[0.5em]">De tre kammerater — Fællesskab & Resultater</p>
                    </footer>

                </div>
            </div>
        )}

    </main>
</Layout>

<script>
    // Revolutionary timer logic
    let timer;
    let timeLeft = 25 * 60;
    const display = document.getElementById('timer-display');
    const startBtn = document.getElementById('timer-start');
    const resetBtn = document.getElementById('timer-reset');

    function updateDisplay() {
        if (!display) return;
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    if (startBtn) {
        startBtn.addEventListener('click', () => {
            if (timer) {
                clearInterval(timer);
                timer = null;
                startBtn.textContent = 'Fortsæt';
            } else {
                startBtn.textContent = 'Pause';
                timer = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateDisplay();
                    } else {
                        clearInterval(timer);
                        alert("Arbejdet for kollektivet er afsluttet! Tag en velfortjent pause.");
                    }
                }, 1000);
            }
        });
    }

    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            clearInterval(timer);
            timer = null;
            timeLeft = 25 * 60;
            updateDisplay();
            if (startBtn) startBtn.textContent = 'Start';
        });
    }
</script>

<style>
    .shadow-glow-red {
        box-shadow: 0 0 20px rgba(185, 28, 28, 0.4);
    }
</style>

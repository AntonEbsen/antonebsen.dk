
---
import '@styles/styles.css';
---

<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capella Lucis | Votivekapellet</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Fonts -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon-cross.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body { font-family: 'Cinzel', serif; }
        .text-body { font-family: 'Playfair Display', serif; }
        
        /* Candle Flickering Animation */
        @keyframes flicker {
            0% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95) translateX(1px); }
            100% { opacity: 0.9; transform: scale(1); }
        }
        .flame {
            animation: flicker 3s infinite ease-in-out;
        }
        .flame:nth-child(2n) { animation-duration: 2.5s; animation-delay: 0.1s; }
        .flame:nth-child(3n) { animation-duration: 3.5s; animation-delay: 0.2s; }
        .flame:nth-child(5n) { animation-duration: 4s; animation-delay: 0.3s; }

        /* Glow Effect */
        .candle-glow {
            box-shadow: 0 0 15px 2px rgba(255, 165, 0, 0.3);
        }
        .candle-glow:hover {
            box-shadow: 0 0 25px 5px rgba(255, 165, 0, 0.5);
        }
    </style>
</head>
<body class="bg-[#050508] text-gray-300 min-h-screen relative overflow-hidden selection:bg-orange-500/30">

    <!-- Background -->
    <div class="fixed inset-0 z-0 pointer-events-none bg-black">
        <div class="absolute inset-0 bg-gradient-to-b from-black via-[#0a0500] to-[#1a0f05] opacity-80"></div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-8 left-8 z-50">
        <a href="/shrine" class="text-orange-500/60 hover:text-orange-400 transition-colors text-xl flex items-center gap-2">
            <i class="fa-solid fa-arrow-left"></i>
            <span class="text-xs uppercase tracking-widest hidden md:inline">Tilbage</span>
        </a>
    </nav>

    <!-- Main Content -->
    <main class="relative z-10 w-full min-h-screen flex flex-col items-center py-20 px-4">
        
        <!-- Header -->
        <div class="text-center mb-12 animate-fade-in-up">
            <h1 class="text-3xl md:text-4xl text-orange-100 font-bold tracking-wider mb-2">Capella Lucis</h1>
            <p class="text-xs text-orange-500/60 uppercase tracking-[0.4em]">Kapellet for de Små Lys</p>
        </div>

        <!-- Candle Grid -->
        <div class="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4 md:gap-6 max-w-5xl mx-auto mb-12 w-full px-4" id="candle-grid">
            <!-- Candles will be injected here -->
            <div class="text-center col-span-full py-8 text-gray-600 animate-pulse hidden" id="loading-indicator">
                Tænder lysene...
            </div>
        </div>

        <!-- Instructions -->
        <div class="text-center max-w-md mx-auto animate-fade-in-up delay-200">
            <p class="text-body text-gray-500 italic text-sm">
                Klik på en tom plads for at tænde et lys for en intention.
                <br>Lyset brænder i 24 timer.
            </p>
        </div>

    </main>

    <!-- Light Candle Modal -->
    <div id="light-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="bg-[#120a05] border border-orange-900/30 p-8 rounded-lg max-w-md w-full mx-4 relative transform scale-95 transition-all duration-300 shadow-[0_0_50px_rgba(255,100,0,0.1)]" id="modal-content">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-600 hover:text-white transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>
            
            <h2 class="text-xl text-orange-100 font-serif mb-6 text-center">Tænd et Lys</h2>
            
            <form id="candle-form" class="space-y-6">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-orange-500/60 mb-2">Din Intention (Bøn)</label>
                    <textarea 
                        id="intention-input"
                        rows="3" 
                        class="w-full bg-[#0a0500] border border-orange-900/30 rounded p-3 text-orange-100 placeholder:text-gray-700 focus:border-orange-500/50 focus:outline-none transition-colors text-body resize-none"
                        placeholder="For min syge bedstemor..."
                        maxlength="100"
                        required
                    ></textarea>
                </div>
                
                <input type="hidden" id="position-input">

                <button type="submit" class="w-full bg-orange-900/20 border border-orange-500/30 hover:bg-orange-900/40 hover:border-orange-500/50 text-orange-100 py-3 rounded uppercase tracking-widest text-xs transition-all duration-300 group">
                    <span class="group-hover:text-white transition-colors">Tænd lyset</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- View Intention Modal -->
    <div id="view-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="bg-[#120a05] border border-orange-900/30 p-8 rounded-lg max-w-md w-full mx-4 relative transform scale-95 transition-all duration-300 shadow-[0_0_50px_rgba(255,100,0,0.2)] text-center" id="view-content">
            <button id="close-view" class="absolute top-4 right-4 text-gray-600 hover:text-white transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>
            
            <div class="w-12 h-12 mx-auto mb-4 text-orange-500 animate-pulse">
                <i class="fa-solid fa-fire text-3xl"></i>
            </div>
            
            <p id="view-message" class="text-body text-xl text-orange-100 italic leading-relaxed mb-4">
                "..."
            </p>
            
            <p class="text-[10px] text-gray-600 uppercase tracking-widest mt-6">Tændt <span id="view-time"></span></p>
        </div>
    </div>

    <script>
        // State
        const TOTAL_SLOTS = 50; 
        let activeCandles = []; // Array of { id, message, position, created_at }

        // DOM Elements
        const grid = document.getElementById('candle-grid');
        const loading = document.getElementById('loading-indicator');
        const lightModal = document.getElementById('light-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModal = document.getElementById('close-modal');
        const form = document.getElementById('candle-form');
        const intentionInput = document.getElementById('intention-input');
        const posInput = document.getElementById('position-input');
        
        const viewModal = document.getElementById('view-modal');
        const viewContent = document.getElementById('view-content');
        const viewMessage = document.getElementById('view-message');
        const viewTime = document.getElementById('view-time');
        const closeView = document.getElementById('close-view');

        // Init
        fetchCandles();

        async function fetchCandles() {
            loading?.classList.remove('hidden');
            try {
                const res = await fetch('/api/candles');
                if(res.ok) {
                    activeCandles = await res.json();
                }
            } catch(e) {
                console.error(e);
            } finally {
                loading?.classList.add('hidden');
                renderGrid();
            }
        }

        function renderGrid() {
            if(!grid) return;
            grid.innerHTML = '';

            for(let i = 0; i < TOTAL_SLOTS; i++) {
                // Check if slot has a candle
                const candle = activeCandles.find((c: any) => c.position === i);
                
                const cell = document.createElement('div');
                cell.className = "aspect-square flex items-end justify-center pb-2 relative transition-all duration-300 rounded";
                
                if(candle) {
                    // Lit Candle
                    cell.className += " cursor-pointer candle-glow group";
                    cell.innerHTML = `
                        <div class="relative w-4 h-12 bg-gradient-to-t from-orange-900/20 to-transparent rounded-full flex justify-center items-end">
                            <div class="w-1.5 h-6 bg-[#3d2b1f] rounded-sm mb-1"></div> <!-- Candle Body -->
                            <div class="absolute -top-3 w-3 h-3 bg-orange-500 rounded-full blur-[2px] flame opacity-90"></div>
                            <div class="absolute -top-3 w-1.5 h-1.5 bg-yellow-200 rounded-full flame animate-flicker"></div>
                        </div>
                        <div class="absolute inset-0 bg-transparent" onclick="viewCandle(${i})"></div>
                    `;
                } else {
                    // Empty Slot
                    cell.className += " cursor-pointer hover:bg-white/5 border border-white/10 hover:border-orange-500/40";
                    cell.onclick = () => openLightModal(i);
                    cell.innerHTML = `
                        <div class="w-2 h-2 rounded-full bg-white/5 group-hover:bg-orange-500/30 transition-colors"></div>
                    `;
                }
                
                grid.appendChild(cell);
            }
        }

        // --- Lighting Logic ---
        function openLightModal(idx: number) {
            if(posInput) (posInput as HTMLInputElement).value = idx.toString();
            lightModal?.classList.remove('opacity-0', 'pointer-events-none');
            modalContent?.classList.remove('scale-95');
            modalContent?.classList.add('scale-100');
            intentionInput?.focus();
        }

        function closeLightModalFn() {
            lightModal?.classList.add('opacity-0', 'pointer-events-none');
            modalContent?.classList.remove('scale-100');
            modalContent?.classList.add('scale-95');
            (form as HTMLFormElement).reset();
        }

        closeModal?.addEventListener('click', closeLightModalFn);
        
        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = (intentionInput as HTMLInputElement).value;
            const position = parseInt((posInput as HTMLInputElement).value);

            try {
                const res = await fetch('/api/candles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, position })
                });
                
                if(res.ok) {
                    closeLightModalFn();
                    fetchCandles(); // Refresh
                }
            } catch(e) {
                alert("Failed to light candle.");
            }
        });

        // --- Viewing Logic ---
        (window as any).viewCandle = (idx: number) => {
            const candle = activeCandles.find((c: any) => c.position === idx);
            if(!candle) return;

            if(viewMessage) viewMessage.innerText = `"${(candle as any).message}"`;
            if(viewTime) {
                const date = new Date((candle as any).created_at);
                viewTime.innerText = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            viewModal?.classList.remove('opacity-0', 'pointer-events-none');
            viewContent?.classList.remove('scale-95');
            viewContent?.classList.add('scale-100');
        };

        closeView?.addEventListener('click', () => {
            viewModal?.classList.add('opacity-0', 'pointer-events-none');
            viewContent?.classList.remove('scale-100');
            viewContent?.classList.add('scale-95');
        });

        // Close on ESC
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                closeLightModalFn();
                closeView?.click();
            }
        });
    </script>

    <style>
        .animate-fade-in-up {
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
    </style>
</body>
</html>

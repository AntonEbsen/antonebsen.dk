---
import '@styles/styles.css';
---

<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forbøn | Ad Majorem Dei Gloriam</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Fonts -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon-cross.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body { font-family: 'Cinzel', serif; }
        .sans { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-[#050508] text-gray-300 min-h-screen m-0 p-0 selection:bg-gold-500/30">

    <!-- Background -->
    <div class="fixed inset-0 z-0 pointer-events-none bg-gradient-to-b from-[#020205] via-[#0a0a1a] to-black">
         <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/stardust.png');"></div>
         <!-- Warm Glow at bottom -->
         <div class="absolute bottom-0 w-full h-[30vh] bg-gradient-to-t from-gold-900/10 to-transparent"></div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-8 left-8 z-50">
        <a href="/shrine" class="text-gold-500/60 hover:text-gold-400 transition-colors text-xl flex items-center gap-2 sans">
            <i class="fa-solid fa-arrow-left"></i>
            <span class="text-xs uppercase tracking-widest hidden md:inline">Tilbage</span>
        </a>
    </nav>

    <!-- Main Content -->
    <main class="relative z-10 w-full max-w-4xl mx-auto p-6 md:py-20 flex flex-col items-center">
        
        <header class="text-center mb-16 animate-fade-in-up">
            <h1 class="text-3xl md:text-5xl text-transparent bg-clip-text bg-gradient-to-b from-gold-200 to-gold-600 mb-4">
                Forbøn
            </h1>
            <p class="text-sm sans text-gray-500 uppercase tracking-widest">
                Et fællesskab i bøn
            </p>
        </header>

        <!-- Use a Grid layout for Form (Left) and Wall (Right) on Desktop? Or Stacked? Stacked is better for mobile focus. -->
        
        <!-- Submission Form -->
        <section class="w-full max-w-xl mb-24 animate-fade-in-up delay-100">
            <div class="bg-gray-900/30 border border-gold-900/30 p-8 rounded-lg backdrop-blur-sm relative group hover:border-gold-500/30 transition-colors">
                
                <h2 class="text-xl text-gold-400 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-hands-praying text-sm opacity-70"></i> Tænd et lys i mørket
                </h2>

                <form id="prayer-form" class="space-y-6">
                    <div>
                        <textarea 
                            name="content" 
                            required 
                            maxlength="500"
                            rows="4"
                            class="w-full bg-black/40 border border-gray-800 rounded p-4 text-gray-300 sans text-sm focus:border-gold-500/50 outline-none transition-colors placeholder:text-gray-700 resize-none"
                            placeholder="Min bøn er..."
                        ></textarea>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <input 
                            type="text" 
                            name="author" 
                            class="bg-transparent border-b border-gray-800 text-gray-500 text-xs sans uppercase tracking-widest focus:border-gold-500/50 outline-none w-1/2 py-2"
                            placeholder="Navn (Valgfrit)"
                        >
                        
                        <button type="submit" class="bg-gold-900/20 hover:bg-gold-500/20 text-gold-500 border border-gold-500/30 px-6 py-2 rounded text-xs sans uppercase tracking-widest transition-all">
                            Send Bøn
                        </button>
                    </div>
                </form>
                
                <!-- Success Message Overlay -->
                <div id="success-msg" class="absolute inset-0 bg-black/90 flex flex-col items-center justify-center rounded-lg opacity-0 pointer-events-none transition-opacity">
                    <i class="fa-solid fa-check text-gold-500 text-3xl mb-4"></i>
                    <p class="text-gold-200 sans text-sm">Din bøn er modtaget.</p>
                </div>
            </div>
        </section>

        <!-- The Prayer Wall -->
        <section class="w-full animate-fade-in-up delay-200">
             <div class="flex items-center justify-center mb-12">
                <div class="h-px w-24 bg-gradient-to-r from-transparent to-gold-900/50"></div>
                <span class="px-4 text-xs sans uppercase tracking-widest text-gray-600">Seneste Bønner</span>
                <div class="h-px w-24 bg-gradient-to-l from-transparent to-gold-900/50"></div>
             </div>

             <!-- Grid Container -->
             <div id="prayer-grid" class="columns-1 md:columns-2 gap-6 space-y-6">
                 <!-- Prayers injected via JS -->
                 <div class="animate-pulse bg-gray-900/20 h-32 rounded border border-white/5"></div>
                 <div class="animate-pulse bg-gray-900/20 h-48 rounded border border-white/5"></div>
             </div>
        </section>

    </main>

    <style>
        .animate-fade-in-up {
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script>
        const form = document.getElementById('prayer-form') as HTMLFormElement;
        const grid = document.getElementById('prayer-grid');
        const successMsg = document.getElementById('success-msg');

        // Fetch Prayers
        async function fetchPrayers() {
            try {
                const res = await fetch('/api/prayers');
                const data = await res.json();
                
                if (grid) {
                    grid.innerHTML = '';
                    if (data.length === 0) {
                        grid.innerHTML = '<p class="text-center text-gray-600 text-sm sans italic w-full col-span-2">Ingen bønner endnu. Vær den første.</p>';
                        return;
                    }

                    data.forEach((prayer: any) => {
                        const card = document.createElement('div');
                        card.className = "break-inside-avoid bg-gray-900/20 border border-white/5 hover:border-gold-500/10 p-6 rounded mb-6 transition-all hover:-translate-y-1 duration-500";
                        
                        // Format date
                        const date = new Date(prayer.created_at).toLocaleDateString('da-DK', { day: 'numeric', month: 'short' });

                        card.innerHTML = `
                            <p class="text-gray-300 font-serif leading-relaxed text-lg mb-4">
                                "${prayer.content}"
                            </p>
                            <div class="flex justify-between items-center border-t border-white/5 pt-4">
                                <span class="text-gold-500/60 text-xs sans uppercase tracking-wider">${prayer.author}</span>
                                <span class="text-gray-700 text-[10px] sans">${date}</span>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Handle Submit
        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const content = formData.get('content');
            const author = formData.get('author');

            try {
                const res = await fetch('/api/prayers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, author })
                });

                if (res.ok) {
                    // Show success
                    if (successMsg) {
                        successMsg.style.opacity = '1';
                        successMsg.style.pointerEvents = 'auto'; // Block clicks
                    }
                    
                    form.reset();
                    fetchPrayers(); // Refresh list

                    // Hide success after delay
                    setTimeout(() => {
                        if (successMsg) {
                            successMsg.style.opacity = '0';
                            successMsg.style.pointerEvents = 'none';
                        }
                    }, 3000);
                }
            } catch (e) {
                alert("Der skete en fejl. Prøv igen.");
            }
        });

        // Init
        fetchPrayers();
    </script>
</body>
</html>

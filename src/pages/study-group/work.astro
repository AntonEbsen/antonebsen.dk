---
import StudyGroupLayout from '../../layouts/study-group/StudyGroupBaseLayout.astro';

export const prerender = false;
---

<StudyGroupLayout title="Arbejdslejren" activePage="work">
    <div class="space-y-32">
        <div class="space-y-4">
            <h2 class="text-6xl font-black italic tracking-tighter text-white uppercase">Arbejde & <br/> <span class="text-red-600">Disciplin</span></h2>
            <p class="text-white/40 text-lg max-w-lg leading-relaxed italic">
                Her omsÃ¦ttes teori til praksis. Hold Ã¸je med dine opgaver, kÃ¸r timeren og glem ikke kritikken.
            </p>
        </div>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            
            {/* PlanÃ¸konomi-Modulet (Workload Planner) */}
            <div class="space-y-12">
                <h3 class="text-3xl font-black uppercase tracking-tighter italic text-red-600">PlanÃ¸konomi-Modulet</h3>
                <div class="space-y-4">
                    {[
                        { task: "Metode & Teori", assigned: "Mao", status: "I gang", color: "red" },
                        { task: "Data-cleaning & Stata", assigned: "Stalin", status: "FÃ¦rdig", color: "green" },
                        { task: "Konklusion & Diskussion", assigned: "Che", status: "Planlagt", color: "white" },
                        { task: "Litteraturliste", assigned: "Mao", status: "I gang", color: "red" }
                    ].map(item => (
                        <div class="p-8 bg-white/[0.03] border border-white/5 rounded-[32px] flex items-center justify-between group hover:border-red-600/30 transition-all">
                            <div class="space-y-1">
                                <h4 class="font-bold text-white text-lg uppercase tracking-tight">{item.task}</h4>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-black uppercase tracking-widest text-white/20">Ansvarlig:</span>
                                    <span class="text-red-600 text-[10px] font-black uppercase tracking-widest">{item.assigned}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class={`text-[10px] font-black uppercase tracking-[0.2em] px-4 py-2 rounded-full border ${item.status === 'FÃ¦rdig' ? 'bg-green-500/10 text-green-500 border-green-500/20' : item.status === 'I gang' ? 'bg-red-600/10 text-red-600 border-red-600/20' : 'bg-white/5 text-white/20 border-white/5'}`}>
                                    {item.status}
                                </span>
                            </div>
                        </div>
                    ))}
                    <button class="w-full py-4 bg-white/5 hover:bg-white/10 text-white/20 hover:text-white rounded-[32px] text-[10px] font-black uppercase tracking-widest transition-all border border-dashed border-white/5 mt-4">Omfordel arbejdskraft +</button>
                </div>
            </div>

            {/* Revolutionary Pomodoro Timer */}
            <div class="space-y-12">
                <h3 class="text-3xl font-black uppercase tracking-tighter italic text-red-600">Arbejdsdisciplin</h3>
                <div class="p-16 bg-white/[0.02] border border-white/5 rounded-[64px] text-center space-y-12 relative overflow-hidden">
                    <div class="space-y-4">
                        <p class="text-[10px] font-black uppercase tracking-widest text-white/20 italic">Arbejdsuge: 14 / Seminarvagt: Aktiv</p>
                        <div id="timer-display" class="text-8xl font-black tabular-nums tracking-tighter text-white">25:00</div>
                    </div>
                    
                    <div class="flex justify-center gap-6">
                        <button id="timer-start" class="px-10 py-4 bg-red-600 hover:bg-red-700 text-white font-black uppercase tracking-widest rounded-2xl transition-all shadow-glow-red text-xs">Start Session</button>
                        <button id="timer-reset" class="px-10 py-4 bg-white/5 hover:bg-white/10 text-white/60 font-black uppercase tracking-widest rounded-2xl transition-all text-xs">Reset</button>
                    </div>

                    <p class="text-[12px] font-medium text-white/20 uppercase tracking-[0.3em] italic pt-4">"Ingen pause uden produktion."</p>
                </div>

                {/* Kritik & Selvkritik */}
                <div class="space-y-8 mt-20">
                    <h3 class="text-2xl font-black uppercase tracking-tighter italic">Kritik & Selvkritik</h3>
                    <div class="space-y-4">
                        {[
                            { title: "Metodeafsnit v2", author: "Che", status: "Venter pÃ¥ Stalin" },
                            { title: "Data-analyse (Stata)", author: "Stalin", status: "Godkendt af Mao" }
                        ].map(review => (
                            <div class="flex items-center justify-between p-6 bg-white/[0.03] border border-white/5 rounded-3xl hover:border-red-600/30 transition-all">
                                <div class="flex items-center gap-4">
                                    <i class="fa-solid fa-file-signature text-red-600/40"></i>
                                    <div>
                                        <h4 class="font-bold text-white text-sm uppercase tracking-tight">{review.title}</h4>
                                        <p class="text-white/20 text-[9px] uppercase font-black tracking-widest">Af Kamerat {review.author}</p>
                                    </div>
                                </div>
                                <span class={`px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest ${review.status.includes('Godkendt') ? 'bg-green-500/10 text-green-500 border-green-500/20' : 'bg-red-600/10 text-red-600 border-red-600/20'}`}>
                                    {review.status}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </section>

        {/* Det Ideologiske Arkiv (Idea Bank) */}
        <section class="space-y-16">
            <div class="flex items-center gap-6">
                <h3 class="text-3xl font-black uppercase tracking-tighter italic text-red-600">Det Ideologiske Arkiv</h3>
                <div class="h-px flex-1 bg-white/5"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                {[
                    { title: "Teori om AI i Ã˜k.", text: "Potentielt emne til specialet. Hvordan pÃ¥virker LLMs produktivitet?" },
                    { title: "Nye Ã˜konometriske modeller", text: "Tjek 'Synthetic Control Method' til seminaropgaven." },
                    { title: "VelfÃ¦rdsteori v3", text: "Hvordan kan vi optimere kaffeforbruget i forhold til studie-output?" }
                ].map(note => (
                    <div class="p-10 bg-red-600/5 border border-red-600/10 rounded-[48px] space-y-6 hover:bg-red-600/10 transition-all cursor-pointer group">
                        <div class="flex justify-between items-start">
                             <h4 class="font-bold text-white text-lg uppercase tracking-tight group-hover:text-red-600 transition-colors">{note.title}</h4>
                             <i class="fa-solid fa-thumbtack text-red-600/20 group-hover:text-red-600 transition-colors"></i>
                        </div>
                        <p class="text-white/40 text-sm italic leading-relaxed">{note.text}</p>
                    </div>
                ))}
            </div>
        </section>
    </div>

    <script>
        import { createClient } from '@supabase/supabase-js';
        const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL;
        const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || import.meta.env.SUPABASE_ANON_KEY;
        const supabase = createClient(supabaseUrl, supabaseKey);

        const comradeId = document.cookie.split('; ').find(row => row.startsWith('study_comrade='))?.split('=')[1];

        let timer;
        let timeLeft = 25 * 60;
        const display = document.getElementById('timer-display');
        const startBtn = document.getElementById('timer-start');
        const resetBtn = document.getElementById('timer-reset');

        function updateDisplay() {
            if (!display) return;
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function syncTimerState(isActive) {
            if (!comradeId) return;
            if (isActive) {
                await supabase.from('study_active_timers').upsert({
                    member_id: comradeId,
                    start_time: new Date().toISOString(),
                    duration_minutes: 25,
                    is_active: true
                }, { onConflict: 'member_id' });
            } else {
                await supabase.from('study_active_timers')
                    .update({ is_active: false })
                    .eq('member_id', comradeId);
            }
        }

        async function finishSession() {
            if (!comradeId) return;
            
            // 1. Clear active timer
            await syncTimerState(false);

            // 2. Update Leaderboard (+1 Pomodoro)
            const { data: current } = await supabase
                .from('study_leaderboard')
                .select('pomodoros')
                .eq('member_id', comradeId)
                .single();
            
            await supabase.from('study_leaderboard').upsert({
                member_id: comradeId,
                pomodoros: (current?.pomodoros || 0) + 1,
                updated_at: new Date().toISOString()
            }, { onConflict: 'member_id' });

            alert("Arbejdet for kollektivet er afsluttet! Din indsats er registreret pÃ¥ leaderboardet.");
        }

        if (startBtn) {
            startBtn.addEventListener('click', async () => {
                if (timer) {
                    // Pause logic
                    clearInterval(timer);
                    timer = null;
                    startBtn.textContent = 'FortsÃ¦t';
                    startBtn.classList.remove('bg-red-700');
                    await syncTimerState(false);
                } else {
                    // Start logic
                    startBtn.textContent = 'Hver minut tÃ¦ller...';
                    startBtn.classList.add('bg-red-700');
                    await syncTimerState(true);
                    
                    timer = setInterval(async () => {
                        if (timeLeft > 0) {
                            timeLeft--;
                            updateDisplay();
                        } else {
                            clearInterval(timer);
                            timer = null;
                            await finishSession();
                            timeLeft = 25 * 60;
                            updateDisplay();
                            startBtn.textContent = 'Start Ny Session';
                            startBtn.classList.remove('bg-red-700');
                        }
                    }, 1000);
                }
            });
        }

        if (resetBtn) {
            resetBtn.addEventListener('click', async () => {
                clearInterval(timer);
                timer = null;
                timeLeft = 25 * 60;
                updateDisplay();
                if (startBtn) {
                    startBtn.textContent = 'Start Session';
                    startBtn.classList.remove('bg-red-700');
                }
                await syncTimerState(false);
            });
        }
    </script>
</StudyGroupLayout>




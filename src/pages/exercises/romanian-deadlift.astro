---
import Layout from '@layouts/Layout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import Button from '@components/ui/Button.astro';

const techInfo = {
  title: "Romanian Deadlift",
  muscles: ["Bagl친r (Hamstrings)", "Baller (Glutes)", "Erector Spinae (L칝nd)"],
  benefits: [
    "Den absolut bedste 칮velse til at bygge hamstrings i str칝k.",
    "Forbedrer din hip-hinge mekanik markant.",
    "Giver en massiv carry-over til dit klassiske d칮dl칮ft."
  ],
  setup: [
    "St친 med f칮dderne i hoftebredde og grib h친ndv칝gte eller en stang.",
    "Ret ryggen, skyd brystet frem og hold en let b칮jning i kn칝ene.",
    "Sp칝nd i coren f칮r du starter bev칝gelsen."
  ],
  execution: [
    "Skyd hoften s친 langt bagud som muligt (vigtigste cue!).",
    "Lad v칝gten glide t칝t ned langs benene.",
    "Stop n친r du m칝rker et maksimalt str칝k i hamstrings (typisk lige under kn칝et).",
    "Tr칝k opad ved at skyde hoften frem og knibe ballerne sammen."
  ]
};
---

<Layout title="Romanian Deadlift: Teknik & Stats">
  <main class="container mx-auto px-4 py-12">
    <Section class="max-w-5xl mx-auto">
      <div class="mb-12 text-center reveal reveal-fade">
        <SectionHeading>칒velses-Fokus</SectionHeading>
        <h1 class="text-4xl md:text-6xl font-black mb-6 uppercase italic tracking-tighter italic">Romanian Deadlift</h1>
        <div class="flex flex-wrap justify-center gap-3">
          {techInfo.muscles.map(m => (
            <span class="px-3 py-1 rounded-full border border-accent/20 bg-accent/5 text-[10px] font-bold uppercase tracking-widest text-accent">{m}</span>
          ))}
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
          <Card variant="glass" class="p-6 reveal reveal-slide-right">
            <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-6 border-b border-white/5 pb-2">Personlige Rekorder</h3>
            <div class="space-y-6">
              <div><p class="text-[10px] text-white/30 uppercase font-bold mb-1">Max Weight</p><div id="stat-pb-weight" class="text-3xl font-black text-white italic">-- kg</div></div>
              <div><p class="text-[10px] text-white/30 uppercase font-bold mb-1">Estimeret 1RM</p><div id="stat-e1rm" class="text-3xl font-black text-accent italic">-- kg</div></div>
              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/5">
                <div><p class="text-[10px] text-white/30 uppercase font-bold">Total Sessions</p><p id="stat-total-sessions" class="font-bold text-sm">--</p></div>
                <div><p class="text-[10px] text-white/30 uppercase font-bold">Avg RPE</p><p id="stat-avg-rpe" class="font-bold text-sm">--</p></div>
              </div>
            </div>
          </Card>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-75">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-6 border-b border-white/5 pb-2">Styrke-niveau</h3>
            <div class="text-center py-4">
                <div id="strength-badge" class="inline-block px-4 py-2 rounded-full border border-white/10 bg-white/5 text-sm font-black uppercase tracking-widest mb-4 italic">Calculating...</div>
                <p id="strength-next" class="text-[10px] text-white/30 uppercase font-bold">N칝ste m친l: -- kg</p>
            </div>
            <div class="space-y-2 mt-4">
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Novice</span><span class="text-white/40">1.0x BW</span></div>
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Intermediate</span><span class="text-white/40">1.5x BW</span></div>
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Advanced</span><span class="text-white/40">2.0x BW</span></div>
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Elite</span><span class="text-white/40">2.5x BW</span></div>
            </div>
          </Card>
        </div>

        <div class="lg:col-span-2 space-y-8">
          <Card variant="glass" class="p-6 reveal reveal-slide-up">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-8">Styrke-udvikling (e1RM)</h3>
            <div class="min-h-[350px] w-full"><canvas id="progressionChart"></canvas></div>
            <p class="text-[10px] text-white/30 mt-4 italic text-center">Inkluderer data fra tidligere "RDL" og "RDL DB" logs.</p>
          </Card>
        </div>
      </div>
    </Section>
  </main>

  <script>
    import Chart from 'chart.js/auto';
    async function initStats() {
      try {
        const res = await fetch('/api/training');
        const allLogs = await res.json();
        // Matcher b친de 'RDL' og det fulde navn
        const logs = allLogs.filter((l: any) => l.exercise_name?.toLowerCase().includes('rdl') || l.exercise_name?.toLowerCase().includes('romanian deadlift')).sort((a: any, b: any) => new Date(a.date).getTime() - new Date(b.date).getTime());
        if (logs.length === 0) return;

        const maxWeight = Math.max(...logs.map((l:any)=>l.weight_kg));
        document.getElementById('stat-pb-weight')!.innerText = `${maxWeight} kg`;

        const e1rms = logs.map((l: any) => {
           const reps = l.reps || 8;
           return Math.round(l.weight_kg / (1.0278 - 0.0278 * reps));
        });
        const currentE1RM = Math.max(...e1rms);
        document.getElementById('stat-e1rm')!.innerText = `${currentE1RM} kg`;

        // Strength Standards (Relative to 85kg BW for RDL)
        const bw = 85;
        const standards = [
            { label: 'Novice', ratio: 1.0 },
            { label: 'Intermediate', ratio: 1.5 },
            { label: 'Advanced', ratio: 2.0 },
            { label: 'Elite', ratio: 2.5 }
        ];

        let tier = standards[0];
        let nextTier = standards[1];
        
        for (let i = 0; i < standards.length; i++) {
            if (currentE1RM >= standards[i].ratio * bw) {
                tier = standards[i];
                nextTier = standards[i+1] || null;
            }
        }

        const badge = document.getElementById('strength-badge')!;
        badge.innerText = tier.label;
        if (tier.label === 'Elite') badge.classList.add('text-accent', 'border-accent/40', 'bg-accent/10');
        else if (tier.label === 'Advanced') badge.classList.add('text-blue-400', 'border-blue-400/40', 'bg-blue-400/10');
        else if (tier.label === 'Intermediate') badge.classList.add('text-green-400', 'border-green-400/40', 'bg-green-400/10');

        if (nextTier) {
            document.getElementById('strength-next')!.innerText = `N칝ste m친l: ${Math.ceil(nextTier.ratio * bw)} kg (${nextTier.label})`;
        } else {
            document.getElementById('strength-next')!.innerText = `Du er i toppen! 游댠`;
        }
        
        document.getElementById('stat-total-sessions')!.innerText = [...new Set(logs.map((l:any)=>l.date))].length.toString();
        const rpes = logs.map((l: any) => l.rpe).filter(Boolean);
        document.getElementById('stat-avg-rpe')!.innerText = rpes.length > 0 ? (rpes.reduce((a:number, b:number) => a+b, 0) / rpes.length).toFixed(1) : '--';

        const ctx = document.getElementById('progressionChart') as HTMLCanvasElement;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: logs.map((l: any) => new Date(l.date).toLocaleDateString('da-DK', { day: 'numeric', month: 'short' })),
                datasets: [{ label: 'Estimeret 1RM (kg)', data: e1rms, borderColor: '#FFD700', backgroundColor: 'rgba(212, 175, 55, 0.1)', borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#FFD700', fill: true, tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'rgba(255, 255, 255, 0.3)', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: 'rgba(255, 255, 255, 0.5)', font: { size: 10 } }, grid: { color: 'rgba(255, 255, 255, 0.05)' } } } }
        });
      } catch (e) { console.error(e); }
    }
    initStats();
  </script>
</Layout>

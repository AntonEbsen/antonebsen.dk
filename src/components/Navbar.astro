---
import LanguageSwitcher from './common/LanguageSwitcher.astro';
import { getLangFromUrl, useTranslations, useNav } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const navItems = useNav(lang);
const pathname = new URL(Astro.request.url).pathname;
---

<nav class="navbar sticky top-0 z-[1000] bg-[#050505]/80 backdrop-blur-[16px] px-6 py-4 border-b border-[#d4af37]/15 shadow-[0_4px_30px_rgba(0,0,0,0.4)]" aria-label="Primær navigation">
  <div class="max-w-[1300px] mx-auto flex items-center justify-between gap-4 flex-col md:flex-row md:gap-4">
    <div class="flex items-center gap-1 flex-wrap justify-center md:justify-start">
      {navItems.map(item => (
        item.children && item.children.length > 0 ? (
          <div class="relative inline-flex items-center group">
            <a href={item.url} class={`inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 text-dim hover:text-white hover:bg-white/5 ${pathname.startsWith(item.url) ? "!text-accent !bg-accent-soft font-semibold" : ""}`}>
              {item.label} 
              <i class="fa-solid fa-chevron-down text-[10px] ml-1.5 opacity-90"></i>
            </a>
            {/* Dropdown */}
            <div class="absolute top-[calc(100%+12px)] left-1/2 -translate-x-1/2 min-w-[220px] bg-[#0a0a0a] border border-glass-border border-t-[2px] border-t-accent rounded-xl p-2 shadow-[0_10px_40px_rgba(0,0,0,0.5)] z-[9999] opacity-0 invisible pointer-events-none translate-y-[10px] transition-all duration-200 group-hover:opacity-100 group-hover:visible group-hover:pointer-events-auto group-hover:translate-y-0 hidden md:block before:content-[''] before:absolute before:-top-3 before:left-0 before:right-0 before:h-3">
               {item.children.map(child => (
                 <a 
                   href={child.url} 
                   class="block px-3.5 py-2.5 rounded-lg text-dim no-underline font-medium text-[13.5px] transition-all duration-200 hover:bg-white/[0.03] hover:text-white hover:pl-[18px]"
                   target={child.external ? "_blank" : "_self"}
                   rel={child.external ? "noopener noreferrer" : ""}
                 >
                   {child.label}
                   {child.external && <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-1 opacity-80"></i>}
                 </a>
               ))}
            </div>
            {/* Mobile Dropdown (controlled by JS) */}
             <div class="dropdown-mobile hidden w-full relative top-0 left-0 bg-transparent border-none shadow-none pl-3 md:hidden">
               {item.children.map(child => (
                 <a 
                   href={child.url} 
                   class="block px-3.5 py-2.5 rounded-lg text-dim no-underline font-medium text-[13.5px] "
                 >
                   {child.label}
                 </a>
               ))}
             </div>
          </div>
        ) : (
          <a class={`inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 text-dim hover:text-white hover:bg-white/5 ${pathname === item.url || (pathname.startsWith(item.url + '/') && item.url !== '/' && item.url !== '/en') ? "!text-accent !bg-accent-soft font-semibold" : ""}`} href={item.url}>
            {item.label}
          </a>
        )
      ))}
    </div>

    <div class="relative inline-flex items-center min-w-[220px] max-w-[420px] w-[clamp(220px,28vw,420px)] group/search" role="search">
      <label class="sr-only" for="siteSearch">Søg på siden</label>
      <input
        id="siteSearch"
        class="w-full px-4 py-2.5 rounded-[14px] border border-glass-border bg-white/5 text-text outline-none font-medium transition-all duration-300 focus:border-accent focus:bg-white/10 focus:shadow-[0_0_15px_rgba(96,165,250,0.2)]"
        type="search"
        placeholder="Søg..."
        autocomplete="off"
        aria-autocomplete="list"
        aria-controls="searchResults"
      />
      <div class="absolute bottom-0 left-[10%] w-[80%] h-[1px] bg-accent scale-x-0 transition-transform duration-300 group-focus-within/search:scale-x-100 group-focus-within/search:animate-[scanBar_2s_infinite]"></div>
      <div id="searchResults" class="absolute top-[calc(100%+10px)] left-0 right-0 bg-[#0a0a0c]/95 backdrop-blur-2xl rounded-[14px] shadow-card border border-glass-border p-2 z-[9999] opacity-0 invisible pointer-events-none -translate-y-[2px] transition-all duration-150 [&.is-open]:opacity-100 [&.is-open]:visible [&.is-open]:pointer-events-auto [&.is-open]:translate-y-0" role="listbox" aria-label="Søgeresultater"></div>
    </div>
    
    <div class="flex items-center gap-3">
      <a href="/dashboard" id="now-status" class="no-underline hidden items-center gap-2 mr-3 bg-gray-900/50 px-2 py-1.5 text-dim hover:text-white transition-colors rounded-full border border-gold-500/20 shadow-[0_0_10px_rgba(255,215,0,0.1)] group" title="Live Status">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
          </span>
          <span id="now-emoji-display" class="text-sm leading-none"></span>
      </a>
      <LanguageSwitcher />
    </div>

<script>
  fetch('/api/now')
    .then(res => res.json())
    .then(data => {
      if (data && data.status) {
        const el = document.getElementById('now-status');
        const emo = document.getElementById('now-emoji-display');
        if (el && emo) {
          emo.innerText = data.emoji || '⚡';
          el.title = `Nuværende status: ${data.status}`; // Set tooltip
          el.classList.remove('hidden');
          el.classList.add('flex');
        }
      }
    })
    .catch(err => console.error('Status fetch failed', err));
</script>
  </div>
</nav>

<script>
  // Mobile dropdown logic
  document.addEventListener("DOMContentLoaded", () => {
    const mobileLinks = document.querySelectorAll(".navbar .group > a .fa-chevron-down");
    
    mobileLinks.forEach(icon => {
        const link = icon.closest('a');
        if(!link) return;
        
        link.addEventListener("click", (e) => {
            if (window.matchMedia("(max-width: 980px)").matches) {
                e.preventDefault();
                const dropdown = link.nextElementSibling?.nextElementSibling; // Get mobile dropdown
                if(dropdown) {
                    dropdown.classList.toggle("hidden");
                }
            }
        });
    });
  });

  // --- COMMAND MODE / GLOBAL SEARCH ---
  const searchInput = document.getElementById('siteSearch');
  const searchResults = document.getElementById('searchResults');
  let searchIndex = [];
  let isIndexLoaded = false;

  async function loadSearchIndex() {
      if (isIndexLoaded) return;
      try {
          const res = await fetch('/api/search-index');
          if (!res.ok) throw new Error("Failed to load index");
          searchIndex = await res.json();
          isIndexLoaded = true;
      } catch (e) {
          console.error("Search index error:", e);
      }
  }

  // CMD+K Shortcut
  document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          searchInput?.focus();
          loadSearchIndex(); // Predownload on shortcut
      }
      // Escape to close
      if (e.key === 'Escape') {
          searchInput?.blur();
          searchResults?.classList.remove('is-open');
      }
  });

  if (searchInput && searchResults) {
      searchInput.addEventListener('focus', loadSearchIndex);
      
      searchInput.addEventListener('input', (e) => {
          const query = (e.target as HTMLInputElement).value.toLowerCase();
          
          if (!query || query.length === 0) {
              searchResults.classList.remove('is-open');
              return;
          }

          if (!isIndexLoaded) return; // Wait for load

          // Filter Logic
          const matches = searchIndex.filter((item: any) => 
               item.title.toLowerCase().includes(query) || 
               (item.tags && item.tags.some((t: string) => t.toLowerCase().includes(query)))
          ).slice(0, 6);

          // Render
          const html = matches.map((item: any) => `
              <a href="${item.url}" class="block p-3 hover:bg-white/10 rounded-lg flex items-center gap-3 group transition-all duration-200 border border-transparent hover:border-white/5">
                  <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-dim group-hover:text-accent group-hover:bg-accent/10 transition-colors">
                      <i class="fa-solid ${item.icon}"></i>
                  </div>
                  <div class="flex-1">
                      <div class="flex items-center justify-between">
                          <span class="text-sm font-medium text-gray-200 group-hover:text-white transition-colors">${item.title}</span>
                          ${item.type === 'command' ? '<span class="text-[10px] font-mono text-accent bg-accent/10 px-1.5 py-0.5 rounded border border-accent/20">CMD</span>' : ''}
                      </div>
                      ${item.description ? `<p class="text-xs text-dim line-clamp-1">${item.description}</p>` : ''}
                  </div>
              </a>
          `).join('');

          // "Ask AI" Footer
          const aiFooter = `
              <div class="border-t border-white/10 mt-2 pt-2">
                   <a href="/ai?q=${encodeURIComponent(query)}" class="block p-3 hover:bg-purple-500/10 rounded-lg flex items-center gap-3 group transition-all duration-200 border border-transparent hover:border-purple-500/20">
                      <div class="w-8 h-8 rounded bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:text-purple-300 transition-colors">
                          <i class="fa-solid fa-sparkles"></i>
                      </div>
                      <div>
                          <span class="text-sm font-medium text-purple-200 group-hover:text-white transition-colors">Ask AI: "${query}"</span>
                          <p class="text-xs text-purple-400/60 group-hover:text-purple-300/80">Semantic Search & Analysis</p>
                      </div>
                   </a>
              </div>
          `;

          searchResults.innerHTML = html + aiFooter;
          searchResults.classList.add('is-open');
      });

      // Click outside to close
      document.addEventListener('click', (e) => {
          if (!searchInput.contains(e.target as Node) && !searchResults.contains(e.target as Node)) {
              searchResults.classList.remove('is-open');
          }
      });
  }
</script>


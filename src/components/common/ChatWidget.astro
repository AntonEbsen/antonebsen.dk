---
import { getLangFromUrl } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);

const t = {
  da: {
    title: "Anton's AI",
    online: "Online",
    intro: "Hej! Jeg er Antons AI-assistent. Sp√∏rg mig om hans erfaring, eller bed mig om at <strong>vise en graf</strong> over hans kompetencer!",
    placeholder: "Pr√∏v f.eks: 'Vis mig en graf over dine skills'...",
    disclaimer: "Drevet af AI ¬∑ Kan lave fejl",
    error: "Beklager, jeg st√∏dte p√• en fejl.",
    configError: "Konfigurationsfejl: Mangler API-n√∏gle.",
    serverError: "Beklager, jeg kan ikke f√• forbindelse til serveren.",
    prompts: ["üìä Vis mig en graf over Antons skills", "üíº Opsummer Antons erfaring", "üöÄ Hvorfor skal jeg ans√¶tte Anton?"]
  },
  en: {
    title: "Anton's AI",
    online: "Online",
    intro: "Hi! I'm Anton's AI assistant. Ask me about his experience, or ask me to <strong>graph his skills</strong>!",
    placeholder: "Try: 'Show me a graph of your skills'...",
    disclaimer: "Powered by AI ¬∑ May produce inaccuracies",
    error: "Sorry, I encountered an error.",
    configError: "Configuration Error: Missing API Key.",
    serverError: "Sorry, I'm having trouble reaching the server.",
    prompts: ["üìä Graph Anton's skills", "üíº Summarize Anton's experience", "üöÄ Why should I hire Anton?"]
  }
}[lang];
---

<div id="chat-widget" class="fixed bottom-6 right-6 z-50 flex flex-col items-end pointer-events-none" data-lang={lang}>
  
  <!-- Chat Window -->
  <div id="chat-window" class="w-[350px] h-[500px] mb-4 bg-glass border border-glass-border rounded-xl shadow-2xl flex flex-col transform translate-y-10 opacity-0 pointer-events-auto transition-all duration-300 origin-bottom-right hidden">
    
    <!-- Header -->
    <div class="p-4 border-b border-glass-border flex justify-between items-center bg-accent/5 rounded-t-xl">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-accent text-bg flex items-center justify-center">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div>
          <h3 class="font-bold text-sm">{t.title}</h3>
          <p class="text-[10px] text-accent flex items-center gap-1">
            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> {t.online}
          </p>
        </div>
      </div>
      <div class="flex gap-2">
        <a href="/chat" class="text-dim hover:text-accent transition-colors p-1" title={lang==='da' ? "√Öbn stor chat" : "Open full chat"}>
          <i class="fa-solid fa-expand"></i>
        </a>
        <button id="close-chat" class="text-dim hover:text-white transition-colors p-1">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 scrollbar-hide text-sm">
      <div class="flex gap-2">
        <div class="w-6 h-6 rounded-full bg-accent/20 flex-shrink-0 flex items-center justify-center text-[10px] text-accent mt-1">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div class="bg-glass-border/50 p-3 rounded-lg rounded-tl-none max-w-[85%]">
          <p>{t.intro}</p>
        </div>
      </div>
      
      <!-- Quick Prompts -->
      <div class="grid grid-cols-1 gap-2 pl-12">
         {t.prompts.map(p => (
           <button class="text-left text-xs bg-white/5 border border-white/10 hover:bg-white/10 hover:border-accent/50 transition-colors rounded-lg p-2 text-dim hover:text-white quick-prompt-btn">
             {p}
           </button>
         ))}
      </div>
      
      <!-- Messages will appear here -->
    </div>

    <!-- Input -->
    <div class="p-3 border-t border-glass-border bg-glass/50 rounded-b-xl">
      <form id="chat-form" class="flex gap-2">
        <input 
          type="text" 
          id="chat-input"
          placeholder={t.placeholder}
          class="flex-1 bg-bg/50 border border-glass-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent/50 transition-colors placeholder:text-dim/50"
          autocomplete="off"
        />
        <button type="button" id="voice-btn" class="bg-glass/20 text-dim hover:text-white hover:bg-glass/40 w-9 h-9 rounded-lg flex items-center justify-center transition-all group relative" title="Speak to Anton (Voice Mode)">
           <i class="fa-solid fa-microphone text-xs group-hover:scale-110 transition-transform"></i>
           <span class="absolute inset-0 rounded-lg border border-red-500 opacity-0 transition-opacity" id="voice-indicator"></span>
        </button>
        <button type="submit" class="bg-accent text-bg w-9 h-9 rounded-lg flex items-center justify-center hover:bg-white transition-colors">
          <i class="fa-solid fa-paper-plane text-xs"></i>
        </button>
      </form>
      <div class="text-[10px] text-center text-dim/30 mt-2">
        {t.disclaimer}
      </div>
    </div>
  </div>

  <!-- Toggle Button -->
  <button id="chat-toggle" class="pointer-events-auto w-14 h-14 bg-accent text-bg rounded-full shadow-lg shadow-accent/20 flex items-center justify-center hover:bg-white hover:scale-110 transition-all duration-300 group">
    <i class="fa-solid fa-message text-xl group-hover:scale-110 transition-transform"></i>
  </button>

</div>

<script>
  // Simple chat toggle logic
  const widget = document.getElementById('chat-widget');
  const window = document.getElementById('chat-window');
  const toggle = document.getElementById('chat-toggle');
  const close = document.getElementById('close-chat');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('chat-input') as HTMLInputElement;
  const messages = document.getElementById('chat-messages');
  const voiceBtn = document.getElementById('voice-btn');
  const voiceIndicator = document.getElementById('voice-indicator');

  // Voice Interaction Logic
  let recognition;
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = currentLang === 'da' ? 'da-DK' : 'en-US';
      recognition.interimResults = false;

      recognition.onstart = () => {
          console.log("üé§ Voice recognition started");
          voiceIndicator.classList.remove('opacity-0');
          voiceIndicator.classList.add('animate-pulse', 'border-red-500');
          voiceBtn.classList.add('text-red-400');
      };

      recognition.onend = () => {
          console.log("üé§ Voice recognition ended");
          voiceIndicator.classList.add('opacity-0');
          voiceIndicator.classList.remove('animate-pulse', 'border-red-500');
          voiceBtn.classList.remove('text-red-400');
      };

      recognition.onerror = (event) => {
          console.error("üé§ Voice error:", event.error);
          voiceIndicator.classList.add('opacity-0'); 
          voiceBtn.classList.remove('text-red-400');
          if (event.error === 'not-allowed') {
              alert("Microphone access denied. Please allow microphone permissions in your browser settings.");
          }
      };

      recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          console.log("üé§ Transcript:", transcript);
          input.value = transcript;
          input.focus();
      };
      
      voiceBtn?.addEventListener('click', () => {
          console.log("üé§ Mic button clicked");
          try {
              recognition.start();
          } catch (e) {
              console.log("Recognition already started or error:", e);
              recognition.stop();
          }
      });
  } else {
      // Hide button if not supported
      if(voiceBtn) voiceBtn.style.display = 'none';
  }
  const currentLang = widget?.getAttribute('data-lang') || 'da';

  let isOpen = false;

  function toggleChat() {
    isOpen = !isOpen;
    if (isOpen) {
      window.classList.remove('hidden');
      // Small timeout for transition
      setTimeout(() => {
        window.classList.remove('translate-y-10', 'opacity-0');
        toggle.classList.add('scale-0', 'opacity-0');
        toggle.style.display = 'none'; 
      }, 10);
      input.focus();
    } else {
      window.classList.add('translate-y-10', 'opacity-0');
      toggle.style.display = 'flex';
      setTimeout(() => {
         toggle.classList.remove('scale-0', 'opacity-0');
      }, 10);
      setTimeout(() => {
        window.classList.add('hidden');
      }, 300);
    }
  }

  toggle.addEventListener('click', toggleChat);
  toggle.addEventListener('click', toggleChat);
  close.addEventListener('click', toggleChat);

  // Quick Prompts Logic
  document.querySelectorAll('.quick-prompt-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const text = (e.currentTarget as HTMLElement).textContent?.trim();
        if(text) {
            input.value = text;
            form?.dispatchEvent(new Event('submit'));
            // Remove prompts after first click to clean up UI
            (e.currentTarget as HTMLElement).parentElement?.remove();
        }
    });
  });

  // Demo functionality
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const query = input.value.trim();
    if (!query) return;

    // User Message
    addMessage(query, 'user');
    input.value = '';

    // Thinking
    showTyping();

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: query, lang: currentLang })
      });

      removeTyping();

      if (!res.ok) {
          const data = await res.json();
          const errorMsg = data.message || (currentLang === 'da' ? "Beklager, fejl." : "Sorry, error.");
          addMessage(`‚ö†Ô∏è ${errorMsg}`, 'ai');
          if (data.error === 'Configuration Error') {
             addMessage("To fix this: Create a .env file in the root and add GEMINI_API_KEY=AIzaSy...", 'ai');
          }
          return;
      }

      // Create a placeholder message for the stream
      const messageContent = addMessage("", 'ai');
      const reader = res.body?.getReader();
      const decoder = new TextDecoder();
      let accumulatedText = "";

      if (reader) {
          while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value, { stream: true });
              accumulatedText += chunk;
              
              // Update the UI with the formatted text (hides text-based tags)
              messageContent.innerHTML = formatMessageText(accumulatedText);
              messages.scrollTop = messages.scrollHeight;
          }
      }

      // Final processing for regex tags (Charts/Navigation) on the complete text
      const wrapper = messageContent.closest('.ai-content-wrapper');
      processSpecialTags(accumulatedText, wrapper); // Pass the wrapper div

    } catch (err) {
      removeTyping();
      const srvErr = currentLang === 'da' ? "Forbindelsesfejl" : "Connection Error";
      addMessage(`‚ö†Ô∏è ${srvErr}: ${err.message || 'Unknown'}`, 'ai');
      console.error("Chat Error:", err);
    }
  });

  function formatMessageText(text) {
      return text.replace(/<<<CHART[\s\S]*?CHART>>>/g, '').replace(/<<<NAVIGATE:.*?>>>/gi, '').replace(/<<<SUGGESTIONS:.*?>>>/g, '');
  }

  function processSpecialTags(text, containerDiv) {
        // Check for Chart Block
        const chartMatch = text.match(/<<<CHART([\s\S]*?)CHART>>>/);
        if (chartMatch) {
            const jsonStr = chartMatch[1];
            try {
                const chartData = JSON.parse(jsonStr);
                const canvasId = 'chart-' + Date.now();
                const canvasContainer = document.createElement('div');
                canvasContainer.className = "mt-2 p-2 bg-white/5 rounded-lg border border-white/10";
                canvasContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                
                const textDiv = containerDiv.querySelector('.message-bubble');
                if (textDiv) textDiv.appendChild(canvasContainer);
                messages.scrollTop = messages.scrollHeight; // Scroll after adding chart

                import('chart.js/auto').then(({ default: Chart }) => {
                    const ctx = document.getElementById(canvasId);
                    if (ctx) {
                        new Chart(ctx, {
                            type: chartData.type,
                            data: chartData.data,
                            options: {
                                ...chartData.options,
                                color: 'rgba(255, 255, 255, 0.7)',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                scale: {
                                    ticks: { color: 'rgba(255, 255, 255, 0.5)' },
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                                },
                                plugins: {
                                    legend: { labels: { color: 'rgba(255, 255, 255, 0.8)' } }
                                }
                            }
                        });
                    }
                });

            } catch (e) {
                console.error("Chart Render Error", e);
            }
        }
        
       // Check for Navigation Block
        const navMatch = text.match(/<<<NAVIGATE:\s*(.*?)\s*>>>/i);
        if (navMatch) {
            const rawPath = navMatch[1].trim();
            const path = rawPath.replace(/\.$/, '');
            
            const navDiv = document.createElement('div');
            navDiv.className = "flex items-center gap-2 text-xs text-accent mt-2 pl-2 font-bold animate-pulse";
            navDiv.innerHTML = `<i class="fa-solid fa-arrow-right-long"></i> Navigating to ${path}...`;
            containerDiv.appendChild(navDiv);
            messages.scrollTop = messages.scrollHeight;

            console.log("Concierge navigating to:", path);

            setTimeout(() => {
                window.location.href = path;
            }, 500);
        }

        // Check for Suggestions Block
        const suggestMatch = text.match(/<<<SUGGESTIONS:(.*?)>>>/);
        if (suggestMatch) {
            const jsonStr = suggestMatch[1];
            try {
                const suggestions = JSON.parse(jsonStr);
                const chipsContainer = document.createElement('div');
                chipsContainer.className = "flex flex-wrap gap-2 mt-2 w-full"; // Added w-full
                
                suggestions.forEach(s => {
                    const btn = document.createElement('button');
                    // Style updated for better visibility below text
                    btn.className = "text-xs bg-accent/10 hover:bg-accent hover:text-bg text-accent border border-accent/20 rounded-full px-3 py-1 transition-all duration-300";
                    btn.innerText = s;
                    btn.addEventListener('click', () => {
                        const input = document.getElementById('chat-input');
                        const form = document.getElementById('chat-form');
                        if (input && form) {
                            input.value = s;
                            form.dispatchEvent(new Event('submit'));
                            // Remove suggestions after clicking
                            chipsContainer.remove();
                        }
                    });
                    chipsContainer.appendChild(btn);
                });
                
                containerDiv.appendChild(chipsContainer);
                messages.scrollTop = messages.scrollHeight;

            } catch (e) {
                console.error("Suggestion Parse Error", e);
            }
        }
  }

  function addMessage(text, role) {
    const div = document.createElement('div');
    div.className = `flex gap-2 ${role === 'user' ? 'flex-row-reverse' : ''}`;
    
    let contentElement;

    if (role === 'ai') {
      div.innerHTML = `
        <div class="w-6 h-6 rounded-full bg-accent/20 flex-shrink-0 flex items-center justify-center text-[10px] text-accent mt-1">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div class="flex flex-col max-w-[85%] ai-content-wrapper">
            <div class="bg-glass-border/50 p-3 rounded-lg rounded-tl-none text-left message-bubble">
                <p></p>
            </div>
        </div>
      `;
      // We set content later for AI to allow streaming updates
      contentElement = div.querySelector('p');
      if (text) contentElement.innerHTML = formatMessageText(text);

    } else {
      div.innerHTML = `
        <div class="bg-accent text-bg p-3 rounded-lg rounded-tr-none max-w-[85%] text-left">
          <p>${text}</p>
        </div>
      `;
    }
    
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    
    return contentElement; // Return the P element for updates
  }

  function showTyping() {
    const div = document.createElement('div');
    div.id = 'typing-indicator';
    div.className = 'flex gap-2';
    div.innerHTML = `
       <div class="w-6 h-6 rounded-full bg-accent/20 flex-shrink-0 flex items-center justify-center text-[10px] text-accent mt-1">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div class="bg-glass-border/50 p-3 rounded-lg rounded-tl-none">
          <div class="flex gap-1">
            <span class="w-1.5 h-1.5 bg-dim/50 rounded-full animate-bounce"></span>
            <span class="w-1.5 h-1.5 bg-dim/50 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
            <span class="w-1.5 h-1.5 bg-dim/50 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
          </div>
        </div>
    `;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function removeTyping() {
    const el = document.getElementById('typing-indicator');
    if (el) el.remove();
  }

  function getMockResponse(q) {
    q = q.toLowerCase();
    if (q.includes('experience') || q.includes('work')) return "Anton has experience as a Student Teacher at Dj√∏f (Excel/VBA) and as an Office Assistant in L√ºbeck. He focuses on data, macros, and modeling.";
    if (q.includes('project') || q.includes('case')) return "He has worked on several projects, including a Global Financial Cycle bachelor thesis, RBC models, and heterogenous effects in the ECB.";
    if (q.includes('contact') || q.includes('email')) return "You can contact Anton at anton.ebsen@gmail.com.";
    return "This is a demo mode. To make me simpler and smarter (and read PDFs!), please connect me to an AI backend!";
  }

</script>

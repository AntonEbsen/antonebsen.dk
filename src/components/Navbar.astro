---
import siteData from '../data/site.json';
import LanguageSwitcher from './common/LanguageSwitcher.astro';
const pathname = new URL(Astro.request.url).pathname;
---

<nav class="navbar" aria-label="Primær navigation">
  <div class="nav-inner">
    <div class="nav-left">
      {siteData.navigation.map(item => (
        item.dropdown ? (
          <div class="nav-item has-dropdown">
            <a href={item.url} class={`nav-link ${pathname === item.url ? 'active' : ''}`}>{item.label}</a>
            <div class="dropdown" role="menu" aria-label={`${item.label} undermenu`}>
              {item.dropdown.map(subItem => (
                <a 
                  href={subItem.url} 
                  role="menuitem"
                  target={subItem.external ? "_blank" : undefined}
                  rel={subItem.external ? "noopener" : undefined}
                >
                  {subItem.label}
                </a>
              ))}
            </div>
          </div>
        ) : (
          <a class={pathname === item.url || (item.activeMatch && pathname === item.activeMatch) ? "active" : ""} href={item.url}>{item.label}</a>
        )
      ))}
    </div>

    <div class="nav-search" role="search">
      <label class="sr-only" for="siteSearch">Søg på siden</label>
      <input
        id="siteSearch"
        class="nav-search-input"
        type="search"
        placeholder="Søg… (fx “SAS”, “CGE”, “Excel”)"
        autocomplete="off"
        aria-autocomplete="list"
        aria-controls="searchResults"
        aria-expanded="false"
      />
      <div id="searchResults" class="search-results" role="listbox" aria-label="Søgeresultater"></div>
    </div>
    
    <div class="nav-right">
      <LanguageSwitcher />
    </div>
  </div>
</nav>

<script>
  // Mobile dropdown logic
  document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll(".navbar .has-dropdown > .nav-link");
    links.forEach(link => {
      link.addEventListener("click", (e) => {
        if (window.matchMedia("(max-width: 980px)").matches) {
          e.preventDefault();
          link.parentElement.classList.toggle("open");
        }
      });
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".navbar .has-dropdown")) {
        document.querySelectorAll(".navbar .has-dropdown.open")
          .forEach(x => x.classList.remove("open"));
      }
    });
  });
</script>

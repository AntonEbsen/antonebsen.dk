---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import AvailabilityStatus from '@components/ui/AvailabilityStatus';
import InteractiveGlobe from '@components/ui/InteractiveGlobe';
import { getEntry } from 'astro:content';

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const entry = await getEntry('pages', `${lang}/contact`);

if (!entry) {
  throw new Error(`Could not find content for ${lang}/contact`);
}

const content: any = entry.data;

// Social Links (could be moved to config)
const socials = [
  { name: 'LinkedIn', icon: 'fa-brands fa-linkedin', url: 'https://www.linkedin.com/in/antonebsen/', id: 'linkedin-link' },
  { name: 'GitHub', icon: 'fa-brands fa-github', url: 'https://github.com/AntonEbsen', id: 'github-link' },
  { name: 'X / Twitter', icon: 'fa-brands fa-x-twitter', url: 'https://x.com/antonebsen', id: 'twitter-link' }
];

const email = "anton@antonebsen.dk";
---

<Layout 
  title={content.title}
  description={content.description}
  bodyClass={content.bodyClass}
>
  <style>
    .contact-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 3rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    @media (min-width: 1024px) {
        .contact-grid {
            grid-template-columns: 1fr 1.2fr;
            gap: 4rem;
            align-items: center;
        }
    }
  </style>

  <Section class="pt-32 pb-20">
      <div class="contact-grid px-6">
          
          <!-- LEFT COLUMN: Info & Map -->
          <div class="space-y-12 animate-fade-in-left">
              <div>
                  <h1 class="text-5xl md:text-6xl font-black mb-6 tracking-tight">{content.heading}</h1>
                  <p class="text-dim text-lg leading-relaxed max-w-md" set:html={content.text} />
              </div>

              <!-- Contact Actions -->
              <div class="space-y-6">
                  <!-- Email Copy -->
                  <div class="group relative cursor-pointer" id="email-trigger">
                      <div class="flex items-center gap-4 bg-white/5 border border-white/10 p-4 rounded-xl hover:bg-white/10 hover:border-accent/30 transition-all duration-300">
                          <div class="w-12 h-12 bg-accent/10 rounded-full flex items-center justify-center text-accent group-hover:scale-110 transition-transform">
                              <i class="fa-solid fa-envelope text-xl"></i>
                          </div>
                          <div>
                              <p class="text-xs text-dim uppercase tracking-wider font-bold mb-1">Email</p>
                              <p class="text-white font-mono text-lg">{email}</p>
                          </div>
                          <div class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity text-accent text-sm">
                              <i class="fa-solid fa-copy"></i>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Socials -->
                  <div class="flex gap-4">
                      {socials.map(s => (
                          <a href={s.url} target="_blank" rel="noopener noreferrer" id={s.id}
                             class="w-12 h-12 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-dim hover:text-white hover:bg-accent hover:border-accent transition-all duration-300 hover:scale-110">
                              <i class={s.icon + " text-xl"}></i>
                          </a>
                      ))}
                  </div>
              </div>

              <!-- Interactive Globe -->
              <div class="relative w-full h-64 bg-white/5 rounded-2xl border border-white/10 overflow-hidden group">
                  <InteractiveGlobe client:load />
              </div>
          </div>

          <!-- RIGHT COLUMN: Form -->
          <div class="animate-fade-in-right delay-100">
             <Card variant="glass" class="p-8 md:p-10 border border-white/10 relative overflow-hidden">
                <!-- Background Glow -->
                <div class="absolute -top-20 -right-20 w-64 h-64 bg-accent/10 rounded-full blur-[80px] pointer-events-none"></div>

                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Send a Message</h2>
                    <AvailabilityStatus client:load />
                </div>

                <form id="contact-form" class="space-y-5" 
                      data-msg-error-api={content.form?.errorAPI} 
                      data-msg-error-net={content.form?.errorNet}
                >
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="group">
                            <label class="block text-dim text-xs font-bold uppercase tracking-wider mb-2 group-focus-within:text-white transition-colors">{content.form?.name}</label>
                            <input type="text" id="c-name" name="name" required 
                                   class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white placeholder-white/20 focus:border-accent focus:bg-white/5 focus:outline-none transition-all duration-300" 
                                   placeholder={content.form?.namePlaceholder} />
                        </div>
                        
                        <div class="group">
                            <label class="block text-dim text-xs font-bold uppercase tracking-wider mb-2 group-focus-within:text-white transition-colors">{content.form?.email}</label>
                            <input type="email" id="c-email" name="email" required 
                                   class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white placeholder-white/20 focus:border-accent focus:bg-white/5 focus:outline-none transition-all duration-300" 
                                   placeholder={content.form?.emailPlaceholder} />
                        </div>
                    </div>

                    <div class="group relative">
                        <div class="flex justify-between items-end mb-2">
                            <label class="block text-dim text-xs font-bold uppercase tracking-wider group-focus-within:text-white transition-colors">{content.form?.message}</label>
                            
                            <div class="flex gap-2">
                                <!-- Voice Dictation Button -->
                                <button type="button" id="voice-dictate-btn" class="text-[10px] flex items-center gap-1 text-dim hover:text-white transition-colors bg-white/5 hover:bg-white/10 px-2 py-1 rounded border border-white/10">
                                    <i class="fa-solid fa-microphone"></i>
                                    Dictate
                                </button>
                                
                                <!-- AI Auto-Fill Button -->
                                <button type="button" id="ai-generate-btn" class="text-[10px] flex items-center gap-1 text-accent hover:text-white transition-colors bg-accent/10 hover:bg-accent/20 px-2 py-1 rounded border border-accent/20">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                                    AI Intro
                                </button>
                            </div>
                        </div>
                        <textarea id="c-message" name="message" required rows="6" 
                                  class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-white placeholder-white/20 focus:border-accent focus:bg-white/5 focus:outline-none transition-all duration-300 resize-none" 
                                  placeholder={content.form?.messagePlaceholder}></textarea>
                    </div>

                    <div id="form-status" class="hidden p-4 rounded-xl bg-green-500/20 border border-green-500/30 text-green-400 text-center text-sm font-bold animate-fade-in-up">
                        <i class="fa-solid fa-check-circle mr-2"></i> {content.form?.success}
                    </div>

                    <Button size="lg" icon="paper-plane" class="w-full justify-center text-base py-4 shadow-lg shadow-accent/10">{content.form?.submit}</Button>
                </form>
             </Card>
          </div>
      </div>
  </Section>
</Layout>

<script>
    import { unlockAchievement } from '../../lib/gamification';

    const form = document.getElementById('contact-form') as HTMLFormElement;
    const status = document.getElementById('form-status')!;
    const messageInput = document.getElementById('c-message') as HTMLTextAreaElement;
    const aiBtn = document.getElementById('ai-generate-btn');
    const voiceBtn = document.getElementById('voice-dictate-btn');
    const emailTrigger = document.getElementById('email-trigger');
    const linkedinLink = document.getElementById('linkedin-link');

    // 1. COPY EMAIL Logic
    emailTrigger?.addEventListener('click', () => {
        const text = "anton@antonebsen.dk";
        navigator.clipboard.writeText(text).then(() => {
            unlockAchievement('recruiter');
            const icon = emailTrigger.querySelector('.fa-copy');
            if(icon) {
                icon.className = 'fa-solid fa-check text-green-500';
                setTimeout(() => { icon.className = 'fa-solid fa-copy'; }, 2000);
            }
        });
    });

    linkedinLink?.addEventListener('click', () => {
        unlockAchievement('recruiter');
    });

    // 2. AI GENERATE INTRO
    aiBtn?.addEventListener('click', () => {
        aiBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Writing...';
        setTimeout(() => {
            const template = "Hi Anton,\n\nI came across your portfolio and was impressed by your work on the AI Chatbot integration. We are looking for someone with your profile for a potential collaboration.\n\nCould we schedule a brief call to discuss?\n\nBest regards,";
            let i = 0;
            messageInput.value = "";
            const type = () => {
                if (i < template.length) {
                    messageInput.value += template.charAt(i);
                    i++;
                    setTimeout(type, 10);
                } else {
                    aiBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Generated!';
                    setTimeout(() => { 
                         aiBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> AI Intro';
                    }, 2000);
                }
            };
            type();
        }, 600);
    });

    // 3. VOICE DICTATION (Using existing STT API)
    voiceBtn?.addEventListener('click', async () => {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Speech recognition is not supported in your browser.');
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = document.documentElement.lang || 'en-US';

        const originalBtnText = voiceBtn.innerHTML;
        voiceBtn.innerHTML = '<i class="fa-solid fa-circle text-red-500 animate-pulse"></i> Listening...';
        voiceBtn.classList.add('border-red-500', 'text-white');

        recognition.onresult = (event) => {
             let interimTranscript = '';
             let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            if (finalTranscript) {
                 const currentVal = messageInput.value;
                 messageInput.value = currentVal ? currentVal + ' ' + finalTranscript : finalTranscript;
            }
        };

        recognition.onend = () => {
             voiceBtn.innerHTML = originalBtnText;
             voiceBtn.classList.remove('border-red-500', 'text-white');
             unlockAchievement('quiz_novice'); // Maybe add a 'speaker' achievement later
        };

        recognition.start();
    });

    // 4. FORM SUBMIT
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        const msgErrorAPI = form.dataset.msgErrorApi || 'Error';
        const msgErrorNet = form.dataset.msgErrorNet || 'Network Error';

        const btn = form.querySelector('button[type="submit"]');
        if (btn) btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sending...';

        try {
            const res = await fetch('/api/contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                form.reset();
                status.classList.remove('hidden');
                unlockAchievement('recruiter');
                
                if (btn) btn.innerHTML = 'Message Sent!';
                setTimeout(() => { 
                    status.classList.add('hidden');
                    if (btn) btn.innerHTML = 'Send Message';
                }, 5000);
            } else {
                alert(msgErrorAPI);
                if (btn) btn.innerHTML = 'Try Again';
            }
        } catch (err) {
            console.error(err);
            alert(msgErrorNet);
            if (btn) btn.innerHTML = 'Try Again';
        }
    });
</script>

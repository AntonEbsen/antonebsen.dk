---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import Pill from '@components/ui/Pill.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';
import SkillGroup from '@components/skills/SkillGroup.astro';
import MethodologyCard from '@components/skills/MethodologyCard.astro';
import { getEntry } from 'astro:content';

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

// 1. Fetch Page Content (Translations)
// Fallback manual translations if json is missing, but ideally fetch from a page json
const t = {
  da: {
    title: "Anton Meier Ebsen Jørgensen – Kompetencer",
    desc: "Kompetencer: værktøjer, metoder og arbejdsområder inden for makroøkonomi, økonometri, data og undervisning.",
    heroTitle: "Værktøjer, metoder og det jeg leverer",
    heroText: "Kompetencer i et format der er let at bruge: <strong>hvad</strong> jeg kan, <strong>hvordan</strong> jeg arbejder, og <strong>hvilket output</strong> man kan forvente.",
    btns: { core: "Værktøjskasse", methods: "Metoder", deliv: "Leverancer" },
    toolsTitle: "Min Værktøjskasse",
    stackTitle: "Teknologisk Stack",
    methodsTitle: "Faglige Metoder",
    ctaTitle: "Har du et konkret behov?",
    ctaText: "Skriv format + mål. Så foreslår jeg en struktur."
  },
  en: {
    title: "Anton Meier Ebsen Jørgensen – Competencies",
    desc: "Competencies: tools, methods, and focus areas in macroeconomics, econometrics, data, and teaching.",
    heroTitle: "Tools, Methods, and Deliverables",
    heroText: "Competencies in a format that's easy to use: <strong>what</strong> I can do, <strong>how</strong> I work, and <strong>what output</strong> you can expect.",
     btns: { core: "Toolkit", methods: "Methods", deliv: "Deliverables" },
    toolsTitle: "My Toolkit",
    stackTitle: "Tech Stack",
    methodsTitle: "Professional Methods",
    ctaTitle: "Have a specific need?",
    ctaText: "Let me know the format and goal. I'll suggest a structure."
  },
  de: {
    title: "Anton Meier Ebsen Jørgensen – Kompetenzen",
    desc: "Kompetenzen: Werkzeuge, Methoden und Fokusbereiche.",
    heroTitle: "Werkzeuge, Methoden und Ergebnisse",
    heroText: "Kompetenzen in einem einfach zu nutzenden Format.",
     btns: { core: "Werkzeugkasten", methods: "Methoden", deliv: "Ergebnisse" },
    toolsTitle: "Mein Werkzeugkasten",
    stackTitle: "Technologie-Stack",
    methodsTitle: "Fachliche Methoden",
    ctaTitle: "Haben Sie einen konkreten Bedarf?",
    ctaText: "Teilen Sie mir Format und Ziel mit."
  }
};

const content = lang === 'da' ? t.da : (lang === 'en' ? t.en : t.de);

// 2. Fetch Skills Data (Local JSON)
const skillsEntry = await getEntry('skills', lang); 
const skillsData = skillsEntry?.data || { professional: [], programming: [] };

// 3. Fetch CV Data for "Verified Skills" cross-referencing
const cvEntry = await getEntry('cv', lang);
const cv = cvEntry?.data;

// Helper to find courses that verify a skill
const getVerifyingCourses = (skillName: string) => {
    if (!cv?.courses) return [];
    return cv.courses
        .filter(c => c.verifiedSkills && c.verifiedSkills.includes(skillName))
        .map(c => ({
            title: c.title,
            href: isDa ? '/courses' : `/${lang}/courses`, // Deep link logic could be refined
            grade: c.grade
        }));
};

// 4. Transform Data
// Add "verifiedIn" to programming skills
const enrichedProgramming = skillsData.programming.map(skill => ({
    ...skill,
    verifiedIn: getVerifyingCourses(skill.name)
}));

const expertTools = enrichedProgramming.filter(s => s.level === 'expert');
const stackTools = enrichedProgramming.filter(s => s.level === 'stack');
const professionalSkills = skillsData.professional;

---

<Layout 
  title={content.title}
  description={content.desc}
  bodyClass="skills-page"
>
  <style>
    .skills-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px;
      align-items: start;
    }

    .grid-methods {
       display: grid;
       grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
       gap: 14px; 
    }

    @media (max-width: 768px) {
      .hero-grid { grid-template-columns: 1fr; }
    }
  </style>

  <main class="skills-wrap">

    <!-- HERO -->
    <Section>
      <div class="hero-grid">
        <Card variant="glass" class="p-8">
          <p class="text-xs font-extrabold uppercase tracking-wider text-dim mb-3">{isDa ? 'Kompetencer' : 'Competencies'}</p>
          <h1 class="text-4xl leading-tight mb-4 font-bold">{content.heroTitle}</h1>
          <p class="text-lg leading-relaxed text-dim mb-6" set:html={content.heroText}></p>
  
          <div class="flex flex-wrap gap-3">
            <Button href="#toolkit"><i class="fa-solid fa-toolbox mr-2"></i> {content.btns.core}</Button>
            <Button href="#methods" variant="ghost"><i class="fa-solid fa-layer-group mr-2"></i> {content.btns.methods}</Button>
            <Button href="#contact" variant="ghost"><i class="fa-solid fa-paper-plane mr-2"></i> Kontakt</Button>
          </div>
        </Card>
  
        <div class="hidden md:block">
           <Card variant="glass" class="p-6 h-full flex flex-col justify-center">
                <div class="space-y-4">
                    <div class="flex items-center gap-3 text-dim">
                        <i class="fa-solid fa-check-circle text-accent"></i>
                        <span>{isDa ? 'Bevist gennem projekter' : 'Proven through projects'}</span>
                    </div>
                    <div class="flex items-center gap-3 text-dim">
                        <i class="fa-solid fa-check-circle text-accent"></i>
                        <span>{isDa ? 'Karakter-verificeret (10/12)' : 'Grade-verified (10/12)'}</span>
                    </div>
                    <div class="flex items-center gap-3 text-dim">
                         <i class="fa-solid fa-check-circle text-accent"></i>
                         <span>{isDa ? '100% Transparent' : '100% Transparent'}</span>
                    </div>
                </div>
           </Card>
        </div>
      </div>
    </Section>

    <!-- TOOLKIT (Daily Drivers) -->
    <Section id="toolkit">
       <SkillGroup 
          title={content.toolsTitle}
          skills={expertTools}
          variant="default"
       />
    </Section>

    <!-- STACK (Secondary Tools) -->
    <Section id="stack">
        <SkillGroup 
           title={content.stackTitle}
           skills={stackTools}
           variant="stack"
        />
     </Section>

    <!-- METHODS (Professional) -->
    <Section id="methods">
      <Card variant="default" class="p-6">
        <SectionHeading>{content.methodsTitle}</SectionHeading>
        <div class="grid-methods">
            {professionalSkills.map(s => (
                <MethodologyCard 
                    icon={s.icon}
                    title={s.name}
                    subtitle={s.title} 
                />
            ))}
        </div>
      </Card>
    </Section>

    <!-- CTA -->
    <Section id="contact">
      <ContactCard 
        variant="glass" 
        title={content.ctaTitle}
        text={content.ctaText}
        action="contact"
      />
    </Section>

  </main>
</Layout>




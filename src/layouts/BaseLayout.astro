---
import Navbar from '@components/Navbar.astro';
import Footer from '@components/Footer.astro';
import SEO from '@components/SEO.astro';
import ChatWidget from '@components/common/ChatWidget.astro';
import CommandPalette from '@components/common/CommandPalette.astro';
import { getLangFromUrl } from '@i18n/utils';
import '@styles/styles.css';
import '@styles/themes.css';
import '@fontsource-variable/inter';
import { ClientRouter } from 'astro:transitions';
import SpeedInsights from "@vercel/speed-insights/astro"
import { Analytics } from "@vercel/analytics/react"

interface Props {
  title: string;
  description?: string;
  image?: string;
  article?: boolean;
  bodyClass?: string;
}

const { title, description, image, article, bodyClass = "" } = Astro.props;
const lang = getLangFromUrl(Astro.url);
---

<!DOCTYPE html>
<html lang={lang}>
<head>
  <SEO title={title} description={description} image={image} article={article} />
  <meta name="design-version" content="dark-gold-v1" />
  <ClientRouter />
  <SpeedInsights />
  <Analytics client:load />
  
  <!-- Fonts -->
  <!-- Fonts -->
  <!-- Self-hosted via @fontsource/inter/variable.css in the script/style block -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- Scripts -->
  <script src="/assets/js/search.js" defer></script>
  <script src="/assets/js/themes.js" defer></script>

  <slot name="head" />
</head>
<body class={bodyClass}>
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[9999] bg-gold-500 text-black px-4 py-2 font-bold rounded">
    Skip to Content
  </a>
  <Navbar />

  <div id="main-content">
    <slot />
  </div>

  <Footer />
  
  <ChatWidget />
  <CommandPalette />

  <script>
    // Premium reveal observer
    const revealObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
          // Optionally unobserve after revealing
          // revealObserver.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));
    });

    // Handle dynamic content (like search results or filtered CV items)
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node instanceof HTMLElement && node.classList.contains('reveal')) {
            revealObserver.observe(node);
          }
          if (node instanceof HTMLElement) {
             node.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));
          }
        });
      });
    });

    observer.observe(document.body, { childList: true, subtree: true });
  </script>
  <script>
    // Scroll Animation Observer
    const observerOptions = {
      root: null,
      rootMargin: '0px',
      threshold: 0.1
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
          observer.unobserve(entry.target); // Only animate once
        }
      });
    }, observerOptions);

    document.addEventListener('astro:page-load', () => {
      const elements = document.querySelectorAll('.animate-on-scroll');
      elements.forEach(el => observer.observe(el));
    });
  </script>
</body>
</html>


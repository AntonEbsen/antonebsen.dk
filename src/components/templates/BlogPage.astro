---
import Layout from '@layouts/BaseLayout.astro';
import Button from '@components/ui/Button.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

const t = {
  da: {
    title: "Anton Meier Ebsen Jørgensen – Blog",
    desc: "Blog med indlæg om faglige emner, træning og rejser.",
    heroTitle: "Indlæg og noter",
    heroText: "Fokus på <strong>Økonomi</strong>, <strong>Data</strong> og <strong>AI</strong>. Her deler jeg analyser, tanker og eksperimenter.",
    latestBtn: "Seneste nyt",
    bucketBtn: "Bucket List",
    statusPre: "Viser",
    statusPost: "indlæg.",
    statusEmpty: "Ingen indlæg endnu.",
    featuredTitle: "Udvalgte indlæg & ressourcer",
    featuredText: "Her er nogle af de ting, jeg har brugt mest tid på at skrive eller bygge.",
    featuredText: "Her er nogle af de ting, jeg har brugt mest tid på at skrive eller bygge.",
    readMore: "Læs mere",
    noPosts: "Ingen indlæg fundet. Tjek din database.",
    ctaTitle: "Forslag til indlæg?",
    ctaText: "Hvis du har et emne, jeg burde skrive om, så lad mig det vide.",
    readingTime: "min læsning",
    all: "Alle",
    academic: "Akademisk",
    analysis: "Analyse",
    tech: "Teknologi",
    featured: [

      {
        title: "Mine Favoritpodcasts",
        tag: "Inspiration",
        meta: "Makro · Data · Humor",
        desc: "En oversigt over de bedste kilder til viden og underholdning on-the-go.",
        link: "/podcasts",
        linkText: "Se liste"
      }
    ]
  },
  en: {
    title: "Anton Meier Ebsen Jørgensen – Blog",
    desc: "Blog with posts about professional topics, training, and travel.",
    heroTitle: "Posts and Notes",
    heroText: "Focus on <strong>Economics</strong>, <strong>Data</strong>, and <strong>AI</strong>. Sharing analysis, thoughts, and experiments.",
    latestBtn: "Latest News",
    bucketBtn: "Bucket List",
    statusPre: "Showing",
    statusPost: "posts.",
    statusEmpty: "No posts yet.",
    featuredTitle: "Featured Posts & Resources",
    featuredText: "Here are some of the things I have spent most time writing or building.",
    featuredText: "Here are some of the things I have spent most time writing or building.",
    readMore: "Read more",
    noPosts: "No posts found. Check your database.",
    ctaTitle: "Suggestions for posts?",
    ctaText: "If you have a topic I should write about, let me know.",
    readingTime: "min read",
    all: "All",
    academic: "Academic",
    analysis: "Analysis",
    tech: "Tech",
    featured: [

      {
        title: "My Favorite Podcasts",
        tag: "Inspiration",
        meta: "Macro · Data · Humor",
        desc: "An overview of the best sources for knowledge and entertainment on-the-go.",
        link: "/en/podcasts",
        linkText: "View List"
      }
    ]
  },
  de: {
    title: "Anton Meier Ebsen Jørgensen – Blog",
    desc: "Blog mit Beiträgen über berufliche Themen, Training und Reisen.",
    heroTitle: "Beiträge und Notizen",
    heroText: "Fokus auf <strong>Ökonomie</strong>, <strong>Daten</strong> und <strong>KI</strong>. Analysen, Gedanken und Experimente.",
    latestBtn: "Aktuelles",
    bucketBtn: "Bucket List",
    statusPre: "Zeige",
    statusPost: "Beiträge.",
    statusEmpty: "Noch keine Beiträge.",
    featuredTitle: "Hervorgehobene Beiträge & Ressourcen",
    featuredText: "Hier sind einige der Dinge, an denen ich am meisten gearbeitet oder die ich geschrieben habe.",
    featuredText: "Hier sind einige der Dinge, an denen ich am meisten gearbeitet oder die ich geschrieben habe.",
    readMore: "Weiterlesen",
    noPosts: "Keine Beiträge gefunden. Überprüfen Sie Ihre Datenbank.",
    ctaTitle: "Vorschläge für Beiträge?",
    ctaText: "Wenn Sie ein Thema haben, über das ich schreiben sollte, lassen Sie es mich bitte wissen.",
    featured: [

      {
        title: "Meine Lieblings-Podcasts",
        tag: "Inspiration",
        meta: "Makro · Daten · Humor",
        desc: "Eine Übersicht der besten Quellen für Wissen und Unterhaltung unterwegs.",
        link: "/de/podcasts",
        linkText: "Liste ansehen"
      }
    ]
  }
};

const content = (t as any)[lang] || t.da;

// Data Fetching (SSR)
// Data Fetching (SSR)
import BlogCard from '@components/blog/BlogCard.astro';
import HeroCarousel from '@components/blog/HeroCarousel';
import NewsletterSignup from '@components/blog/NewsletterSignup';
import EcosystemGraph from '../visuals/EcosystemGraph.tsx';
import { getCollection } from 'astro:content';

// Fetch Local Content
const localPosts = await getCollection('blog');

// Helper for reading time
const getReadingTime = (post: any) => {
  const textContent = isDa 
    ? (post.data.content_da || post.data.content || []) 
    : (post.data.content || []);
  
  const text = Array.isArray(textContent) ? textContent.join(' ') : String(textContent);
  const words = text.replace(/<[^>]*>/g, '').split(/\s+/).length;
  const minutes = Math.ceil(words / 200);
  return `${minutes} ${content.readingTime}`; // "min read" / "min læsning"
};

// Normalize Local Posts to match display format
const formattedLocalPosts = localPosts.map(p => ({
  title: isDa ? (p.data.title_da || p.data.title) : p.data.title, // Prefer localized title
  category: p.data.category,
  created_at: new Date().toISOString(), // Or add date to frontmatter
  excerpt: isDa ? (p.data.description_da || p.data.description) : p.data.description, // Prefer localized desc
  slug: p.id,
  series: p.data.series,
  seriesOrder: p.data.seriesOrder,
  readingTime: getReadingTime(p),
  isLocal: true
}));

// Group by Series
const seriesGroups: Record<string, typeof formattedLocalPosts> = {};
const standalonePosts: typeof formattedLocalPosts = [];

formattedLocalPosts.forEach(p => {
    if (p.series) {
        if (!seriesGroups[p.series]) seriesGroups[p.series] = [];
        seriesGroups[p.series].push(p);
    } else {
        standalonePosts.push(p);
    }
});

// Sort Series Items
Object.keys(seriesGroups).forEach(key => {
    seriesGroups[key].sort((a, b) => (a.seriesOrder || 0) - (b.seriesOrder || 0));
});

// Prepare Carousel Items (Select 3 high-impact posts)
const carouselSlugs = ['ai-monetary-policy', 'gfc-part-1', 'ecb-part-1'];
const carouselItems = formattedLocalPosts
    .filter(p => carouselSlugs.includes(p.slug))
    .map(p => ({
        title: p.title,
        description: p.excerpt,
        tag: p.category?.toUpperCase() || "FEATURED",
        meta: p.readingTime,
        link: isDa ? `/blog/${p.slug}` : `/en/blog/${p.slug}`,
        linkText: content.readMore
    }));

const posts = standalonePosts;  // "Latest" now only shows standalone posts 
// Note: Supabase fetching removed for now to prioritize local "Platinum" content.
// If valid archives exist in Supabase, we could merge them here.
---

<Layout 
  title={content.title}
  description={content.desc}
  bodyClass="blog-page"
>

  <style>
    .blog-wrap { 
      max-width: 1200px; 
      margin: 24px auto; 
      padding: 0 16px 32px; 
    }

    .hero-grid {
      display: grid; 
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px; 
      align-items: start; 
    }

    .posts-grid {
      display: grid; 
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px; 
      margin-top: 14px;
    }

    @media (max-width: 980px) {
      .hero-grid { 
        grid-template-columns: 1fr; 
      }
      .posts-grid { 
        grid-template-columns: 1fr; 
      }
    }

    .filter-btn {
      @apply px-4 py-2 rounded-full text-sm font-bold transition-all border border-white/5 bg-white/5 text-dim hover:bg-white/10;
    }

    .filter-btn.active {
      @apply bg-accent text-black border-accent;
    }

    .post-wrapper.hidden {
      display: none;
    }
  </style>

  <main class="blog-wrap">

    <!-- HERO -->
    <Section>
      <div class="hero-grid lg:h-[450px]">
        <div class="h-full">
            <HeroCarousel client:load items={carouselItems} lang={lang} />
        </div>
  
        <div class="hidden md:block h-full">
          <Card variant="glass" class="p-8 h-full flex flex-col justify-between">
            <div>
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-accent mb-4 tracking-widest">Status</p>
                <h2 class="text-2xl font-black mb-4 leading-tight">{content.heroTitle}</h2>
                <p class="text-dim opacity-70 mb-8 leading-relaxed text-sm" set:html={content.heroText}></p>
                
                <p class="text-[13px] font-bold text-white mb-2">
                    {posts.length > 0 ? `${content.statusPre} ${posts.length} ${content.statusPost}` : content.statusEmpty}
                </p>
                <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden">
                    <div class="bg-accent h-full w-2/3"></div>
                </div>
            </div>

            <!-- FILTERS -->
            <div class="mt-8">
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-dim mb-4">Filtrering</p>
                <div class="flex flex-wrap gap-2" id="blog-filters">
                    <button class="filter-btn active text-[11px]" data-filter="all">{content.all}</button>
                    <button class="filter-btn text-[11px]" data-filter="academic">{content.academic}</button>
                    <button class="filter-btn text-[11px]" data-filter="analysis">{content.analysis}</button>
                    <button class="filter-btn text-[11px]" data-filter="tech">{content.tech}</button>
                </div>
            </div>
          </Card>
        </div>
      </div>
    </Section>

    <!-- ===================== -->
    <!-- FEATURED POSTS -->
    <!-- ===================== -->
    <Section id="featured">
      <SectionHeading class="mb-4 text-xl font-bold">{content.featuredTitle}</SectionHeading>
      <div class="posts-grid mb-12">
        {content.featured.map(feat => (
            <BlogCard 
              title={feat.title}
              tag={feat.tag}
              meta={feat.meta}
              description={feat.desc}
              links={[{ label: feat.linkText, url: feat.link, icon: 'arrow-right' }]}
            />
        ))}
      </div>
    </Section>

    <!-- SERIES -->
    {Object.entries(seriesGroups).map(([seriesName, seriesPosts]) => (
        <Section class="mb-12">
            <SectionHeading class="mb-4 text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-accent"></i>
                {seriesName} <span class="text-xs font-normal opacity-50 ml-2">({seriesPosts.length} Parts)</span>
            </SectionHeading>
            <div class="posts-grid items-stretch">
                {seriesPosts.map(p => (
                    <div class="post-wrapper" data-category={p.category}>
                        <BlogCard 
                            title={p.title}
                            tag={`Part ${p.seriesOrder}`}
                            meta={new Date(p.created_at).toLocaleDateString(isDa ? 'da-DK' : 'en-US')}
                            readingTime={p.readingTime}
                            description={p.excerpt || ""}
                            links={[{ label: content.readMore, url: isDa ? `/blog/${p.slug}` : `/en/blog/${p.slug}`, icon: 'arrow-right' }]}
                        />
                    </div>
                ))}
            </div>
        </Section>
    ))}

    <Section id="latest">
      <div class="posts-grid items-stretch">
        {posts.map(p => (
            <div class="post-wrapper" data-category={p.category}>
                <BlogCard 
                title={p.title}
                tag={p.category || "Blog"}
                meta={new Date(p.created_at).toLocaleDateString(isDa ? 'da-DK' : 'en-US')}
                readingTime={p.readingTime}
                description={p.excerpt || ""}
                links={[{ label: content.readMore, url: isDa ? `/blog/${p.slug}` : `/en/blog/${p.slug}`, icon: 'arrow-right' }]}
                />
            </div>
        ))}
        {posts.length === 0 && (
            <div class="col-span-3 text-center py-12 border border-white/5 rounded-lg bg-white/5">
                <i class="fa-solid fa-feather text-4xl text-dim mb-4 opacity-50"></i>
                <p class="text-dim">{content.noPosts}</p>
            </div>
        )}
      </div>
    </Section>

    <!-- NEWSLETTER -->
    <Section>
        <NewsletterSignup client:load lang={lang} />
    </Section>

    <!-- ECOSYSTEM GRAPH -->
    <Section>
        <div class="mt-16">
            <EcosystemGraph client:visible />
        </div>
    </Section>

    <!-- CTA -->
    <Section>
      <ContactCard 
        variant="glass" 
        title={content.ctaTitle}
        text={content.ctaText}
        action="contact"
      />
    </Section>

  </main>
</Layout>

<script>
    const filterButtons = document.querySelectorAll('[data-filter]');
    const postWrappers = document.querySelectorAll('.post-wrapper');
    const sections = document.querySelectorAll('section');

    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter');

            // Update Active State
            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Filter Posts
            postWrappers.forEach(wrapper => {
                const category = wrapper.getAttribute('data-category');
                if (filter === 'all' || category === filter) {
                    (wrapper as HTMLElement).classList.remove('hidden');
                } else {
                    (wrapper as HTMLElement).classList.add('hidden');
                }
            });

            // Hide empty sections (Series)
            sections.forEach(section => {
                const childPosts = section.querySelectorAll('.post-wrapper:not(.hidden)');
                if (section.id === 'featured' || section.id === 'latest') return;
                
                if (childPosts.length === 0) {
                    (section as HTMLElement).style.display = 'none';
                } else {
                    (section as HTMLElement).style.display = 'block';
                }
            });
        });
    });
</script>




---
import Navbar from '@components/Navbar.astro';
import Footer from '@components/Footer.astro';
import SEO from '@components/SEO.astro';
import ChatWidget from '../components/common/ChatWidget.astro';
import CommandPalette from '@components/common/CommandPalette.astro';
import { AchievementToast } from '../components/game/AchievementToast';
import Chameleon from '@components/core/Chameleon.astro';
import { getLangFromUrl } from '@i18n/utils';
import '@styles/styles.css';
import '@styles/themes.css';
import SpeedInsights from "@vercel/speed-insights/astro"
import { Analytics } from "@vercel/analytics/react"
import '@fontsource-variable/inter';
import 'katex/dist/katex.min.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
  article?: boolean;
  bodyClass?: string;
  showChatWidget?: boolean;
  currentPath?: string;
}

const { title, description, image, article, bodyClass = "", showChatWidget = true } = Astro.props;
const lang = getLangFromUrl(Astro.url);
---

<!DOCTYPE html>
<html lang={lang}>
<head>
  <!-- 1. CRITICAL CSS: Inline everything needed for first paint -->
  <style is:inline>
    /* === CSS VARIABLES === */
    :root {
      /* BACKGROUNDS */
      --bg: #050505;
      --bg-gradient: radial-gradient(circle at 50% 0%, #1a1505 0%, #050505 60%);
      --depth-bg: radial-gradient(circle at 60% -20%, #1c1810 0%, #050505 50%);
      
      /* TEXT */
      --text: #f2f2f0;
      --text-dim: #d4d4d8;
      --muted: rgba(161, 161, 170, 0.4);
      
      /* ACCENT: GOLD */
      --accent: #D4AF37;
      --accent-light: #F4C430;
      --accent-soft: rgba(212, 175, 55, 0.15);
      --accent-glow: 0 0 25px rgba(212, 175, 55, 0.3);
      
      /* COMPONENTS */
      --nav: rgba(5, 5, 5, 0.85);
      --navHover: rgba(255, 255, 255, 0.06);
      
      /* GLASS / BORDERS */
      --glass: rgba(15, 15, 20, 0.7);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-border-hover: rgba(212, 175, 55, 0.5);
      
      --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8);
      --radius: 16px;
      
      /* TYPOGRAPHY - System font stack for instant render, Inter loads progressively */
      --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      --h1-size: clamp(48px, 6vw, 76px);
      --h2-size: clamp(28px, 4vw, 42px);
      --body-size: 16px;
      --lh-body: 1.7;
      --ls-heading: -0.02em;
    }
    
    /* Progressive enhancement: Use Inter when it loads */
    body {
      font-family: 'Inter', var(--font-main);
    }
    
    /* === RESET & BASE STYLES === */
    * { box-sizing: border-box; }
    
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    html {
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--font-main);
      transition: none !important;
    }
    
    body {
      font-family: var(--font-main);
      font-size: var(--body-size);
      line-height: var(--lh-body);
      background: var(--depth-bg);
      background-attachment: fixed;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      position: relative;
    }
    
    a {
      color: var(--accent);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    
    h1, h2, h3 {
      color: var(--text);
      margin: 0 0 0.5em;
      font-weight: 800;
    }
    
    /* === THEME STYLES === */
    .theme-lent {
      --bg: #0d0a14;
      --nav: rgba(20, 15, 30, 0.9);
      --accent: #9333ea;
      --depth-bg: radial-gradient(circle at 50% -20%, #171026 0%, #0d0a14 100%);
    }
    
    .theme-easter {
      --bg: #0a0f0e;
      --nav: rgba(15, 25, 20, 0.9);
      --accent: #14b8a6;
      --depth-bg: radial-gradient(circle at 50% -20%, #152520 0%, #0a0f0e 100%);
    }
    
    .theme-ascension {
      --bg: #0a0c14;
      --nav: rgba(15, 18, 25, 0.9);
      --accent: #3b82f6;
      --depth-bg: radial-gradient(circle at 50% -20%, #141a2b 0%, #0a0c14 100%);
    }
    
    .theme-pentecost {
      --bg: #0f0a0a;
      --nav: rgba(25, 15, 15, 0.9);
      --accent: #ef4444;
      --depth-bg: radial-gradient(circle at 50% -20%, #2b1515 0%, #0f0a0a 100%);
    }
    
    .theme-corpus {
      --bg: #0a0a05;
      --nav: rgba(25, 25, 15, 0.9);
      --accent: #f59e0b;
      --depth-bg: radial-gradient(circle at 50% -20%, #2b2b15 0%, #0a0a05 100%);
    }
    
    .theme-advent {
      --bg: #050810;
      --nav: rgba(10, 15, 30, 0.9);
      --accent: #314480;
      --depth-bg: radial-gradient(circle at 50% -20%, #101a35 0%, #050810 100%);
    }
    
    .theme-camino {
      --bg: #f6fff8;
      --nav: #123026;
      --navHover: #1a4537;
      --accent: #15803d;
      --season-bar: linear-gradient(90deg, rgba(21, 128, 61, 0.95), rgba(255, 255, 255, 0.15));
    }

    /* === MATH / KATEX === */
    .katex-display {
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 0.5rem;
      -webkit-overflow-scrolling: touch;
    }
  </style>
  <script is:inline>
    // Theme detection runs immediately before any content renders
    (function applyTheme() {
      const doc = document.documentElement;
      const override = localStorage.getItem("themeOverride");
      doc.classList.remove("theme-lent", "theme-easter", "theme-ascension", "theme-pentecost", "theme-corpus", "theme-advent", "theme-camino");
      if (override && override !== "auto") { doc.classList.add(override); return; }

      function atNoon(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0, 0); }
      function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }
      const today = atNoon(new Date()); const y = today.getFullYear();
      const easter = ((year) => {
        const a = year % 19, b = Math.floor(year / 100), c = year % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451);
        const month = Math.floor((h + l - 7 * m + 114) / 31), day = ((h + l - 7 * m + 114) % 31) + 1;
        return atNoon(new Date(year, month - 1, day));
      })(y);

      const ashWednesday = addDays(easter, -46), holySaturday = addDays(easter, -1), ascension = addDays(easter, 39), pentecost = addDays(easter, 49), corpusChristi = addDays(easter, 60), stJames = atNoon(new Date(y, 6, 25)), adventStart = (() => { for (let day = 27; day <= 33; day++) { const d = atNoon(new Date(y, 10, day)); if (d.getDay() === 0) return d; } return atNoon(new Date(y, 10, 27)); })();

      const inRangeFlags = (d, start, end) => { const x = d.getTime(); return x >= start.getTime() && x <= end.getTime(); };
      const sameDay = (a, b) => a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();

      let theme = null;
      if (inRangeFlags(today, ashWednesday, holySaturday)) theme = "theme-lent";
      else if (inRangeFlags(today, easter, addDays(ascension, -1))) theme = "theme-easter";
      else if (inRangeFlags(today, ascension, addDays(pentecost, -1))) theme = "theme-ascension";
      else if (inRangeFlags(today, pentecost, addDays(pentecost, 1))) theme = "theme-pentecost";
      else if (sameDay(today, corpusChristi) || sameDay(today, addDays(corpusChristi, 3))) theme = "theme-corpus";
      else if (inRangeFlags(today, adventStart, atNoon(new Date(y, 11, 24)))) theme = "theme-advent";
      else if (inRangeFlags(today, addDays(stJames, -1), addDays(stJames, 1))) theme = "theme-camino";
      if (theme) doc.classList.add(theme);
    })();
    
    // Re-apply theme after page transitions
    document.addEventListener('astro:after-swap', function() {
      const doc = document.documentElement;
      const override = localStorage.getItem("themeOverride");
      doc.classList.remove("theme-lent", "theme-easter", "theme-ascension", "theme-pentecost", "theme-corpus", "theme-advent", "theme-camino");
      if (override && override !== "auto") { doc.classList.add(override); }
    });
  </script>

  <!-- 2. SEO and other metadata -->
  <SEO title={title} description={description} image={image} article={article} />
  <meta name="design-version" content="dark-gold-v1" />
  <SpeedInsights />
  <Analytics client:load />
  
  <!-- 3. Font preloading for instant text rendering -->
  <!-- Replaced with @fontsource-variable/inter -->
  
  <!-- 4. Non-critical CSS and scripts (deferred) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="/assets/js/search.js" defer></script>

  <slot name="head" />
  
  <!-- Add grain texture after page loads for smoother first paint -->
  <script is:inline>
    window.addEventListener('DOMContentLoaded', function() {
      const grain = document.createElement('div');
      grain.style.cssText = 'content:"";position:fixed;inset:0;background:url("https://grainy-gradients.vercel.app/noise.svg");opacity:0.03;pointer-events:none;z-index:1000;';
      document.body.insertBefore(grain, document.body.firstChild);
    });
  </script>
</head>
<body class={bodyClass}>
  <Chameleon />
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[9999] bg-gold-500 text-black px-4 py-2 font-bold rounded">
    Skip to Content
  </a>
  <Navbar />

  <div id="main-content">
    <slot />
  </div>

  <Footer />

  
  {showChatWidget && <ChatWidget />}
  <CommandPalette />
  <AchievementToast client:load />

  <script>
    // Premium reveal observer
    const revealObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
          // Optionally unobserve after revealing
          // revealObserver.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));
    });

    // Handle dynamic content (like search results or filtered CV items)
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node instanceof HTMLElement && node.classList.contains('reveal')) {
            revealObserver.observe(node);
          }
          if (node instanceof HTMLElement) {
             node.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));
          }
        });
      });
    });

    observer.observe(document.body, { childList: true, subtree: true });
  </script>
  <script>
    // Disable scroll animations - instant appearance for fast site
    document.addEventListener('astro:page-load', () => {
      const elements = document.querySelectorAll('.animate-on-scroll');
      elements.forEach(el => {
        // Make all content visible immediately, no animations
        el.classList.add('in-view');
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      });
    });
  </script>
  <script>
    import { unlockAchievement, checkPolyglotAchievement } from '../lib/gamification';

    const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
    let cursor = 0;

    document.addEventListener('keydown', (e) => {
      if (e.key === konamiCode[cursor]) {
        cursor++;
        if (cursor === konamiCode.length) {
          unlockAchievement('easter_egg');
          cursor = 0;
        }
      } else {
        cursor = 0; 
      }
    });

    // Check Polyglot
    
    // Check Night Owl (00:00 - 05:00)
    const hour = new Date().getHours();
    if (hour >= 0 && hour < 5) {
        unlockAchievement('night_owl');
    }

    // Expose for static scripts (search.js)
    window.unlockAchievement = unlockAchievement;
    
    // Run delayed checks
    setTimeout(() => {
        checkPolyglotAchievement();
    }, 1000);
  </script>
</body>
</html>


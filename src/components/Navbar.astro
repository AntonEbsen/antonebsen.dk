---
import LanguageSwitcher from './common/LanguageSwitcher.astro';
import { getLangFromUrl, useTranslations, useNav } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const navItems = useNav(lang);
const pathname = new URL(Astro.request.url).pathname;
---

<nav class="navbar" aria-label="Primær navigation">
  <div class="nav-inner">
    <div class="nav-left">
      {navItems.map(item => (
        item.children && item.children.length > 0 ? (
          <div class="nav-item has-dropdown">
            <a href={item.url} class={`nav-link ${pathname.startsWith(item.url) ? "active" : ""}`}>
              {item.label} 
              <i class="fa-solid fa-chevron-down text-[10px] ml-1.5 opacity-60"></i>
            </a>
            <div class="dropdown">
               {item.children.map(child => (
                 <a 
                   href={child.url} 
                   target={child.external ? "_blank" : "_self"}
                   rel={child.external ? "noopener noreferrer" : ""}
                 >
                   {child.label}
                   {child.external && <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-1 opacity-50"></i>}
                 </a>
               ))}
            </div>
          </div>
        ) : (
          <a class={pathname === item.url || (pathname.startsWith(item.url + '/') && item.url !== '/' && item.url !== '/en') ? "active" : ""} href={item.url}>
            {item.label}
          </a>
        )
      ))}
    </div>

    <div class="nav-search" role="search">
      <label class="sr-only" for="siteSearch">Søg på siden</label>
      <input
        id="siteSearch"
        class="nav-search-input"
        type="search"
        placeholder="Søg..."
        autocomplete="off"
        aria-autocomplete="list"
        aria-controls="searchResults"
        aria-expanded="false"
      />
      <div id="searchResults" class="search-results" role="listbox" aria-label="Søgeresultater"></div>
    </div>
    
    <div class="nav-right flex items-center">
      <a href="/dashboard" id="now-status" class="no-underline hidden items-center gap-2 mr-3 bg-gray-900/50 px-2 py-1.5 text-dim hover:text-white transition-colors rounded-full border border-gold-500/20 shadow-[0_0_10px_rgba(255,215,0,0.1)] group" title="Live Status">
          <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
          </span>
          <span id="now-emoji-display" class="text-sm leading-none"></span>
      </a>
      <LanguageSwitcher />
    </div>

<script>
  fetch('/api/now')
    .then(res => res.json())
    .then(data => {
      if (data && data.status) {
        const el = document.getElementById('now-status');
        const emo = document.getElementById('now-emoji-display');
        if (el && emo) {
          emo.innerText = data.emoji || '⚡';
          el.title = `Nuværende status: ${data.status}`; // Set tooltip
          el.classList.remove('hidden');
          el.classList.add('flex');
        }
      }
    })
    .catch(err => console.error('Status fetch failed', err));
</script>
  </div>
</nav>

<script>
  // Mobile dropdown logic
  document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll(".navbar .has-dropdown > .nav-link");
    links.forEach(link => {
      link.addEventListener("click", (e) => {
        if (window.matchMedia("(max-width: 980px)").matches) {
          e.preventDefault();
          link.parentElement.classList.toggle("open");
        }
      });
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".navbar .has-dropdown")) {
        document.querySelectorAll(".navbar .has-dropdown.open")
          .forEach(x => x.classList.remove("open"));
      }
    });
  });
</script>

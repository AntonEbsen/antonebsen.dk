---
import Layout from '@layouts/BaseLayout.astro';
import Pill from '@components/ui/Pill.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import ProjectCard from '@components/portfolio/ProjectCard.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';
import DiscoveryGrid from '@components/common/DiscoveryGrid.astro';
import { supabase } from '@lib/supabase';
import { getEntry } from 'astro:content';

export const prerender = true;

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const entry = await getEntry('pages', `${lang}/portfolio`);

if (!entry) {
  throw new Error(`Could not find content for ${lang}/portfolio`);
}

const content: any = entry.data;

// Hardcoded Cases (now called Projects)
const hardcodedProjects = {
  da: [
        {
            id: "case-gfc",
            title: "Global Financial Cycle & spillovers fra US pengepolitik",
            pill: "Empirisk makro",
            desc: "(Bachelorprojekt) Undersøgelse af hvordan amerikansk pengepolitik påvirker globale finansielle forhold.",
            url: "/cases", // Keeping link for now or just info
            tags: ["Empirisk makro", "US Pengepolitik", "SVAR"]
        },
        {
            id: "case-ecb",
            title: "One Rule to Rule Them All? ECB Taylor Rules",
            pill: "Monetær økonomi",
            desc: "(Seminarprojekt) Analyse af asymmetriske effekter af ECB's pengepolitik via Taylor-regler og GMM.",
            tags: ["Monetær økonomi", "Taylor-regler", "GMM"]
        },
        {
            id: "case-rd",
            title: "Valutakursdynamik – Inflation & Relative Kurser",
            pill: "Anvendt Dataanalyse",
            desc: "Eksplorativ analyse af sammenhængen mellem dansk inflation og hovedvalutaer (EUR, USD, CNY).",
            tags: ["Dataanalyse", "Inflation", "DST API"]
        }
  ],
  en: [
        {
            id: "case-gfc",
            title: "Global Financial Cycle & Spillovers from US Monetary Policy",
            pill: "Empirical Macro",
            desc: "(Bachelor's Project) Investigation of how US monetary policy affects global financial conditions.",
            tags: ["Empirical Macro", "US Monetary Policy", "SVAR"]
        },
        {
            id: "case-ecb",
            title: "One Rule to Rule Them All? ECB Taylor Rules",
            pill: "Monetary Economics",
            desc: "(Seminar Paper) Analysis of asymmetric effects of ECB monetary policy via Taylor rules and GMM.",
            tags: ["Monetary Economics", "Taylor Rules", "GMM"]
        },
        {
            id: "case-erd",
            title: "Exchange Rate Dynamics – Inflation & Relative Rates",
            pill: "Applied Data Analysis",
            desc: "Exploratory analysis of the relationship between Danish inflation and major currencies.",
            tags: ["Data Analysis", "Inflation", "DST API"]
        }
  ],
  de: [
        {
            id: "case-gfc",
            title: "Globaler Finanzzyklus & Spillovers der US-Geldpolitik",
            pill: "Empirische Makroökonomik",
            desc: "(Bachelorarbeit) Untersuchung, wie die US-Geldpolitik globale Finanzbedingungen beeinflusst.",
            tags: ["Empirische Makro", "US-Geldpolitik", "SVAR"]
        },
        {
            id: "case-ecb",
            title: "EZB-Taylor-Regeln: One Rule to Rule Them All?",
            pill: "Monetäre Außenwirtschaft",
            desc: "(Seminararbeit) Analyse asymmetrischer Effekte der EZB-Geldpolitik über Taylor-Regeln.",
            tags: ["Geldpolitik", "Taylor-Regeln", "GMM"]
        },
        {
            id: "case-erd",
            title: "Wechselkursdynamik – Inflation & relative Kurse",
            pill: "Angewandte Datenanalyse",
            desc: "Explorative Analyse des Zusammenhangs zwischen dänischer Inflation und Hauptwährungen.",
            tags: ["Datenanalyse", "Inflation", "DST API"]
        }
  ]
};

const featuredProjects = hardcodedProjects[lang] || hardcodedProjects.da;

// Supabase Data Fetching
let supabaseProjects = [];
if (supabase) {
  const { data, error } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
  if (!error && data) supabaseProjects = data;
}

const cvLink = lang === 'en' ? '/en/cv' : lang === 'de' ? '/de/cv' : '/cv';
const projectsLabel = lang === 'da' ? 'Udvalgte Projekter' : lang === 'de' ? 'Ausgewählte Projekte' : 'Featured Projects';
const otherProjectsLabel = lang === 'da' ? 'Andre Projekter' : lang === 'de' ? 'Andere Projekte' : 'Other Projects';
---

<Layout 
  title={content.title}
  description={content.description}
  bodyClass={content.bodyClass}
>

  <style>
    .portfolio-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px;
      align-items: start;
    }

    .projects-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 32px;
    }

    @media (max-width: 980px) {
      .hero-grid, .projects-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <main class="portfolio-wrap">
      <!-- HERO -->
      <Section>
        <div class="hero-grid">
          <Card variant="glass" class="p-8">
            <p class="text-xs font-extrabold uppercase tracking-widest text-dim mb-3">{content.hero.eyebrow}</p>
            <h1 class="text-4xl leading-[1.15] mb-5 font-bold">{content.hero.title}</h1>
            <p class="text-[17px] leading-relaxed text-dim mb-6 opacity-90">
              {content.hero.text}
            </p>
    
            <div class="flex flex-wrap gap-3 mb-6">
              <Button href={cvLink}>{content.hero.cta.cv}</Button>
              <Button href="https://github.com/AntonEbsen" target="_blank" rel="noopener" variant="ghost"><i class="fa-brands fa-github mr-2"></i> {content.hero.cta.github}</Button>
              <Button href="https://www.linkedin.com/in/antonebsen/" target="_blank" rel="noopener" variant="ghost"><i class="fa-brands fa-linkedin mr-2"></i> {content.hero.cta.linkedin}</Button>
            </div>
    
            <div class="flex flex-wrap gap-2">
               {content.hero.pills.map((pill: string) => (
                 <Pill variant="accent">{pill}</Pill>
               ))}
            </div>
          </Card>
    
          <div class="hidden md:block">
            <Card variant="glass" class="p-6">
              <SectionHeading>{content.sidebar.title}</SectionHeading>
              <ul class="list-none p-0 m-0 space-y-2 text-sm text-dim opacity-90">
                {content.sidebar.items.map((item: string) => (
                    <li class="relative pl-4 before:content-['-'] before:absolute before:left-0 before:text-accent">{item}</li>
                ))}
              </ul>
            </Card>
          </div>
        </div>
      </Section>
  
      <!-- FEATURED SPOTLIGHT + TECH MATRIX -->
      <Section>
        <!-- The Spotlight (First Project) -->
        {featuredProjects.length > 0 && (
            <div class="mb-12">
                 <div class="flex items-center justify-between mb-6">
                    <SectionHeading>
                        <i class="fa-solid fa-star text-accent mr-2"></i>
                        {lang === 'da' ? 'I Fokus' : 'Spotlight'}
                    </SectionHeading>
                 </div>
                 
                <Card variant="default" class="relative overflow-hidden group border-accent/20">
                    <div class="absolute inset-0 bg-gradient-to-r from-accent/5 to-transparent opacity-50"></div>
                    <div class="relative p-8 md:p-10 flex flex-col md:flex-row gap-8 items-start">
                         <div class="flex-1">
                            <Pill variant="accent" class="mb-4">{featuredProjects[0].pill}</Pill>
                            <h2 class="text-3xl font-bold mb-4">{featuredProjects[0].title}</h2>
                            <p class="text-lg text-dim leading-relaxed mb-6 max-w-2xl">
                                {featuredProjects[0].desc}
                            </p>
                            
                            <div class="flex flex-wrap gap-2 mb-8">
                                {featuredProjects[0].tags.map((tag: string) => (
                                    <span class="text-xs font-mono text-accent/80 bg-accent/5 px-2 py-1 rounded border border-accent/10">
                                        {tag}
                                    </span>
                                ))}
                            </div>

                            <div class="flex gap-4">
                                {featuredProjects[0].url && (
                                    <Button href={featuredProjects[0].url}>{content.ui.viewProject} <i class="fa-solid fa-arrow-right ml-2"></i></Button>
                                )}
                                {/* Featured Lab Button if applicable, hardcoded for demo if needed, or check ID */}
                                {featuredProjects[0].id === 'case-gfc' && (
                                     <Button href="https://lab.antonebsen.dk" variant="ghost" class="text-accent border-accent/20 hover:bg-accent/10"><i class="fa-solid fa-flask mr-2"></i> Launch Lab</Button>
                                )}
                            </div>
                         </div>
                    </div>
                </Card>
            </div>
        )}

        <!-- The Tech Matrix (Sticky Filter) -->
        <div class="sticky top-4 z-30 mb-8 p-1">
            <Card variant="glass" class="p-2 backdrop-blur-xl border-white/10 shadow-2xl">
                <div class="flex items-center justify-between gap-4 overflow-x-auto no-scrollbar">
                    <div class="flex items-center gap-1.5 min-w-max px-2">
                         <i class="fa-solid fa-filter text-dim text-xs"></i>
                         <span class="text-xs font-bold uppercase tracking-wider text-dim">Matrix</span>
                    </div>
                    <div class="h-4 w-px bg-white/10"></div>
                    <div class="flex gap-2 min-w-max" id="project-filters">
                        <button class="project-filter-btn active text-xs font-bold px-3 py-1.5 rounded-md bg-accent text-black transition-all" data-filter="all">
                            All
                        </button>
                        {/* Unique tags generator */}
                        {Array.from(new Set([...featuredProjects, ...supabaseProjects].flatMap((p: any) => p.tags || []))).slice(0, 6).map((tag: any) => (
                            <button class="project-filter-btn text-xs font-bold px-3 py-1.5 rounded-md bg-white/5 text-dim hover:text-white hover:bg-white/10 transition-all border border-white/5" data-filter={tag}>
                                {tag}
                            </button>
                        ))}
                    </div>
                </div>
            </Card>
        </div>

        <!-- Project Grid (Minus first if featured? No, let's keep all in list but filterable, or maybe remove first? Let's keep all for comprehensive matrix) -->
        <div class="projects-grid" id="project-matrix">
          {featuredProjects.slice(1).map((p) => (
            <ProjectCard
              title={p.title}
              tagString={p.tags.join(' · ')}
              tags={p.tags}
              description={p.desc}
              tools={[]}
              output={content.ui.featured}
              links={p.url ? [{ label: content.ui.viewProject, url: p.url, icon: 'arrow-right' }] : []}
              lang={lang}
              labUrl={p.id === 'case-erd' ? 'https://lab.antonebsen.dk/lab/index.html?path=notebooks%2Fexchange_rate_dynamics.ipynb' : undefined}
            />
          ))}
          
          {/* Re-add First project to grid? Maybe not if spotlighted. But for filtering it should exist. Let's add it back but hidden by default? Or just render it. 
              Let's render it in grid too, but maybe with a "Featured above" marker? 
              Actually, for a "Matrix", it's better to having everything in the grid.
              But "Spotlight" implies it's special. 
              DECISION: Filter grid contains items 1..N. Item 0 is Spotlight. 
              If user filters, we might lose Item 0 from view if it's not in grid.
              Let's add Item 0 to grid but hidden via CSS unless filtered? 
              Simpler: Just render items 1..N in grid. Spotlight is static. 
          */}
          
          {supabaseProjects?.map((p: any) => (
            <ProjectCard
              title={p.title}
              tagString={p.tags ? p.tags.join(' · ') : ''}
              tags={p.tags}
              description={p.description}
              tools={[]}
              output={content.ui.project}
              links={p.url ? [{ label: content.ui.viewProject, url: p.url, icon: 'arrow-right' }] : []}
              lang={lang}
            />
          ))}
        </div>
      </Section>
  
      <!-- DISCOVERY (Cleaned) -->
      <Section id="discovery" class="mt-12">
        <DiscoveryGrid 
          title={lang === 'da' ? 'Ressourcer' : lang === 'de' ? 'Ressourcen' : 'Resources'}
          items={[
            { 
                label: lang === 'da' ? 'Model Library' : 'Model Library', 
                url: lang === 'da' ? '/models' : lang === 'de' ? '/en/models' : '/en/models', 
                icon: 'fa-diagram-project', 
                description: lang === 'da' ? 'Tekniske rammeværktøjer' : lang === 'de' ? 'Technische Frameworks' : "Technical frameworks"
            },
            { 
                label: lang === 'da' ? 'Speaking' : 'Speaking', 
                url: lang === 'da' ? '/speaking' : lang === 'de' ? '/en/speaking' : '/en/speaking', 
                icon: 'fa-chalkboard-user', 
                description: lang === 'da' ? 'Oplæg og formidling' : lang === 'de' ? 'Vorträge und Präsentationen' : "Talks and presentations"
            },
            { 
                label: lang === 'da' ? 'Python Lab' : 'Python Lab', 
                url: 'https://lab.antonebsen.dk', 
                icon: 'fa-code', 
                description: lang === 'da' ? 'Interaktivt Jupyter-miljø' : lang === 'de' ? 'Interaktive Jupyter-Umgebung' : "Interactive Jupyter environment"
            },
            { 
                label: lang === 'da' ? 'GitHub' : 'GitHub', 
                url: 'https://github.com/AntonEbsen', 
                icon: 'fa-brands fa-github', 
                description: lang === 'da' ? 'Se min kildekode' : lang === 'de' ? 'Meinen Quellcode ansehen' : "View my source code"
            },
            { 
                label: lang === 'da' ? 'Downloads' : lang === 'de' ? 'Downloads' : 'Resources', 
                url: lang === 'da' ? '/resources' : lang === 'de' ? '/de/resources' : '/en/resources', 
                icon: 'fa-download', 
                description: lang === 'da' ? 'Templates og værktøjer' : lang === 'de' ? 'Vorlagen und Tools' : "Templates and tools"
            },
            { 
                label: lang === 'da' ? 'Milepæle' : lang === 'de' ? 'Meilensteine' : 'Milestones', 
                url: lang === 'da' ? '/timeline' : lang === 'de' ? '/de/timeline' : '/en/timeline', 
                icon: 'fa-timeline', 
                description: lang === 'da' ? 'Min faglige rejse' : lang === 'de' ? 'Meine berufliche Reise' : "My professional journey"
            }
          ]}
        />
      </Section>
  
      <!-- Footer card -->
      <Section>
        <ContactCard />
      </Section>
  
  </main>
  <script>
    // Project Matrix Filtering
    const filters = document.querySelectorAll('.project-filter-btn');
    const projects = document.querySelectorAll('.project-card-wrapper');

    filters.forEach(btn => {
        btn.addEventListener('click', () => {
            // UI
            filters.forEach(b => {
                b.classList.remove('bg-accent', 'text-black');
                b.classList.add('bg-white/5', 'text-dim');
            });
            btn.classList.remove('bg-white/5', 'text-dim');
            btn.classList.add('bg-accent', 'text-black');

            const filter = btn.getAttribute('data-filter');

            projects.forEach(p => {
                if (!(p instanceof HTMLElement)) return;
                const tags = (p.getAttribute('data-tags') || '').split(',');
                
                if (filter === 'all' || tags.includes(filter)) {
                    p.style.display = '';
                    p.classList.add('animate-in', 'fade-in');
                } else {
                    p.style.display = 'none';
                    p.classList.remove('animate-in', 'fade-in');
                }
            });
        });
    });
  </script>
</Layout>




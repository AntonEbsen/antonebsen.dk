---
import Layout from '@layouts/BaseLayout.astro';
import Button from '@components/ui/Button.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

const t = {
  da: {
    title: "Anton Meier Ebsen Jørgensen – Blog",
    desc: "Blog med indlæg om faglige emner, træning og rejser.",
    heroTitle: "Indlæg og noter",
    heroText: "Tre spor: <strong>Fagligt</strong> (økonomi, data, modeller), <strong>Træning</strong> (struktur og progression) og <strong>Rejser</strong> (vandring, ruter og praktik).",
    latestBtn: "Seneste nyt",
    bucketBtn: "Bucket List",
    statusPre: "Viser",
    statusPost: "indlæg.",
    statusEmpty: "Ingen indlæg endnu.",
    featuredTitle: "Udvalgte indlæg & ressourcer",
    featuredText: "Her er nogle af de ting, jeg har brugt mest tid på at skrive eller bygge.",
    readingTime: "min læsning"
  },
  en: {
    title: "Anton Meier Ebsen Jørgensen – Blog",
    desc: "Blog with posts about professional topics, training, and travel.",
    heroTitle: "Posts and Notes",
    heroText: "Three tracks: <strong>Professional</strong> (economics, data, models), <strong>Training</strong> (structure and progression), and <strong>Travel</strong> (hiking, routes, and practice).",
    latestBtn: "Latest News",
    bucketBtn: "Bucket List",
    statusPre: "Showing",
    statusPost: "posts.",
    statusEmpty: "No posts yet.",
    featuredTitle: "Featured Posts & Resources",
    featuredText: "Here are some of the things I have spent most time writing or building.",
    readingTime: "min read"
  },
  de: {
    title: "Anton Meier Ebsen Jørgensen – Blog",
    desc: "Blog mit Beiträgen über berufliche Themen, Training und Reisen.",
    heroTitle: "Beiträge und Notizen",
    heroText: "Drei Schwerpunkte: <strong>Fachliches</strong> (Ökonomie, Daten, Modelle), <strong>Training</strong> (Struktur und Progression) und <strong>Reisen</strong> (Wandern, Routen und praktische Erfahrungen).",
    latestBtn: "Aktuelles",
    bucketBtn: "Bucket List",
    statusPre: "Zeige",
    statusPost: "Beiträge.",
    statusEmpty: "Noch keine Beiträge.",
    featuredTitle: "Hervorgehobene Beiträge & Ressourcen",
    featuredText: "Hier sind einige der Dinge, an denen ich am meisten gearbeitet oder die ich geschrieben habe.",
    latestTitle: "Neueste Beiträge",
    latestSub: "Direkt aus der Datenbank.",
    readMore: "Weiterlesen",
    noPosts: "Keine Beiträge gefunden. Überprüfen Sie Ihre Datenbank.",
    ctaTitle: "Vorschläge für Beiträge?",
    ctaText: "Wenn Sie ein Thema haben, über das ich schreiben sollte, lassen Sie es mich bitte wissen.",
    featured: [
      {
        title: "Mein Trainingsprogramm (6-Tage-Split)",
        tag: "Training",
        meta: "Komplettes Programm · PPL",
        desc: "Der volle Überblick über meine Übungen, Sätze, Tempo und Fokusbereiche. Auf Progression optimiert.",
        link: "/de/training-program",
        linkText: "Programm ansehen"
      },
      {
        title: "Lieblingsbücher & Notizen",
        tag: "Lernen",
        meta: "Klassiker · Fachliches",
        desc: "Eine kuratierte Liste der Bücher, die mein Denken am meisten geprägt haben.",
        link: "/de/books",
        linkText: "Bibliothek öffnen"
      },
      {
        title: "Übungs-Fokus: Incline Press",
        tag: "Training",
        meta: "Technik · Daten · Progression",
        desc: "Warum die obere Brust wichtig ist und wie sich meine Kraft im letzten Jahr entwickelt hat.",
        link: "/de/exercises/incline-press",
        linkText: "Deep Dive lesen"
      },
      {
        title: "Meine Lieblings-Podcasts",
        tag: "Inspiration",
        meta: "Makro · Daten · Humor",
        desc: "Eine Übersicht der besten Quellen für Wissen und Unterhaltung unterwegs.",
        link: "/de/podcasts",
        linkText: "Liste ansehen"
      }
    ]
  }
};

const content = (t as any)[lang] || t.da;

// Data Fetching (SSR)
// Data Fetching (SSR)
import BlogCard from '@components/blog/BlogCard.astro';
import { supabase } from '@lib/supabase';
let posts: any[] = [];
let error = null;

if (supabase) {
  const { data, error: dbError } = await supabase
    .from('posts')
    .select('*')
    .eq('published', true)
    .eq('lang', lang); // Use the lang prop for filtering
  posts = data || [];
  error = dbError;
}

if (error || !posts) posts = [];
---

<Layout 
  title={content.title}
  description={content.desc}
  bodyClass="blog-page"
>

  <style>
    .blog-wrap { 
      max-width: 1200px; 
      margin: 24px auto; 
      padding: 0 16px 32px; 
    }

    .hero-grid {
      display: grid; 
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px; 
      align-items: start; 
    }

    .posts-grid {
      display: grid; 
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px; 
      margin-top: 14px;
    }

    @media (max-width: 980px) {
      .hero-grid { 
        grid-template-columns: 1fr; 
      }
      .posts-grid { 
        grid-template-columns: 1fr; 
      }
    }
  </style>

  <main class="blog-wrap">

    <!-- HERO -->
    <Section>
      <div class="hero-grid">
        <Card variant="glass" class="p-8">
          <p class="text-xs font-extrabold uppercase tracking-widest text-dim mb-3">Blog</p>
          <h1 class="text-4xl leading-[1.15] mb-5 font-bold">{content.heroTitle}</h1>
          <p class="text-[17px] leading-relaxed text-dim mb-6 opacity-90" set:html={content.heroText} />
  
          <div class="flex flex-wrap gap-3 mb-6">
            <Button href="#latest">{content.latestBtn}</Button>
            <Button href={isDa ? "/bucketlist" : "/en/bucketlist"} variant="ghost" class="text-gold-400 hover:text-gold-300"><i class="fa-solid fa-trophy mr-2"></i>{content.bucketBtn}</Button>
          </div>
        </Card>
  
        <div class="hidden md:block">
          <Card variant="glass" class="p-6">
            <SectionHeading>Status</SectionHeading>
            <p class="text-dim opacity-80 m-0">
              {posts.length > 0 ? `${content.statusPre} ${posts.length} ${content.statusPost}` : content.statusEmpty}
            </p>
          </Card>
        </div>
      </div>
    </Section>

    <!-- ===================== -->
    <!-- FEATURED POSTS -->
    <!-- ===================== -->
    <Section id="featured">
      <SectionHeading class="mb-4 text-xl font-bold">{content.featuredTitle}</SectionHeading>
      <div class="posts-grid mb-12">
        {content.featured.map(feat => (
            <BlogCard 
              title={feat.title}
              tag={feat.tag}
              meta={feat.meta}
              description={feat.desc}
              links={[{ label: feat.linkText, url: feat.link, icon: 'arrow-right' }]}
            />
        ))}
      </div>
    </Section>

    <!-- ===================== -->
    <!-- ALL POSTS (DB) -->
    <!-- ===================== -->
    <Section id="latest">
      <div class="flex flex-wrap items-baseline justify-between gap-2 mb-4">
        <SectionHeading class="mb-0 text-xl font-bold">{content.latestTitle}</SectionHeading>
        <p class="m-0 text-dim text-sm opacity-80">{content.latestSub}</p>
      </div>

      <div class="posts-grid">
        {posts.map(p => (
            <BlogCard 
              title={p.title}
              tag={p.category || "Blog"}
              meta={new Date(p.created_at).toLocaleDateString(isDa ? 'da-DK' : 'en-US')}
              description={p.excerpt || ""}
              links={[{ label: content.readMore, url: isDa ? `/blog/${p.slug}` : `/en/blog/${p.slug}`, icon: 'arrow-right' }]}
            />
        ))}
        {posts.length === 0 && (
            <div class="col-span-3 text-center py-12 border border-white/5 rounded-lg bg-white/5">
                <i class="fa-solid fa-feather text-4xl text-dim mb-4 opacity-50"></i>
                <p class="text-dim">{content.noPosts}</p>
            </div>
        )}
      </div>
    </Section>

    <!-- CTA -->
    <Section>
      <ContactCard 
        variant="glass" 
        title={content.ctaTitle}
        text={content.ctaText}
        action="contact"
      />
    </Section>

  </main>
</Layout>




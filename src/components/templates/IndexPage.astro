---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import Pill from '@components/ui/Pill.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import FeatureCard from '@components/ui/FeatureCard.astro';
import TechStack from '@components/ui/TechStack.astro';
import { Image } from 'astro:assets';
import myImageSrc from '../../assets/img/billede-af-mig.jpg';


import { getEntry } from 'astro:content';

interface Props {
  lang: 'da' | 'en';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

const portLink = isDa ? '/portfolio' : '/en/portfolio';
const cvLink = isDa ? '/cv' : '/en/cv';
const guestbookLink = isDa ? '/guestbook' : '/en/guestbook';
const contactLink = isDa ? '/contact' : '/en/contact';

const entry = await getEntry('pages', `${lang}/home`);
if (!entry) throw new Error(`Missing content for ${lang}/home`);
const content: any = entry.data;

let skillsRows = [];
let error = null;

// try {
//   if (supabase) {
//     const { data, error: dbError } = await supabase.from('skills').select('*');
//     if (dbError) throw dbError;
//     skillsRows = data;
//   }
// } catch (e) {
//   console.error("Supabase fetch failed", e);
//   error = e;
// }

if (error || !skillsRows || skillsRows.length === 0) {
    const skillsEntry = await getEntry('skills', lang);
    if (skillsEntry && skillsEntry.data) {
        const fd = skillsEntry.data;
        const prog = (fd.programming || []).map(s => ({ ...s, category: 'programming' }));
        const prof = (fd.professional || []).map(s => ({ ...s, category: 'professional' }));
        skillsRows = [...prog, ...prof];
    } else {
        skillsRows = [];
    }
}

const skillsData = {
  programming: skillsRows?.filter(s => s.category === 'programming') || [],
  professional: skillsRows?.filter(s => s.category === 'professional') || []
};
---

<Layout 
  title={content.title} 
  description={content.desc}
>
  <main class="container mx-auto px-4 py-12">
    <Section class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-20 animate-on-scroll">
      <div class="space-y-6">
        <div class="inline-block px-3 py-1 rounded-full bg-accent-soft text-accent text-xs font-bold uppercase tracking-wider">
          {content.hero.tag}
        </div>
        <h1 class="text-5xl md:text-6xl font-extrabold leading-tight tracking-tight">
          Anton Meier <span class="text-accent underline decoration-4 underline-offset-8">Ebsen</span> Jørgensen
        </h1>
        <p class="text-xl text-dim leading-relaxed max-w-lg">
          {content.hero.text}
        </p>
        <div class="flex flex-wrap gap-4 pt-4">
          <Button href={portLink} size="lg">{content.hero.btnPort}</Button>
          <Button href={cvLink} variant="ghost" size="lg">{content.hero.btnCV}</Button>
          <Button href={guestbookLink} variant="ghost" size="lg" class="text-gold-400 border-gold-500/30 hover:bg-gold-500/10">{content.hero.btnGuest}</Button>
        </div>
      </div>
      
      <div class="relative group">
        <div class="absolute -inset-4 bg-gradient-to-r from-accent/20 to-purple-500/20 rounded-3xl blur-2xl group-hover:opacity-100 transition duration-1000 group-hover:duration-200"></div>
        <div class="relative aspect-square overflow-hidden rounded-2xl border border-glass-border shadow-2xl">
          <Image 
            src={myImageSrc} 
            alt="Anton Meier Ebsen Jørgensen" 
            class="object-cover w-full h-full grayscale hover:grayscale-0 transition-all duration-700"
            loading="eager"
            width={600}
            height={600}
          />
        </div>
      </div>
    </Section>

    <Section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-24 animate-on-scroll delay-100">
      <Card variant="glass" class="p-8 hover-glow group">
        <div class="w-12 h-12 rounded-xl bg-accent/10 flex items-center justify-center mb-6 group-hover:bg-accent/20 transition-colors">
          <i class="fa-solid fa-code text-accent text-xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-3">{content.cards.model.title}</h3>
        <p class="text-dim text-sm leading-relaxed">
          {content.cards.model.text}
        </p>
      </Card>
      
      <Card variant="glass" class="p-8 hover-glow group">
        <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center mb-6 group-hover:bg-blue-500/20 transition-colors">
          <i class="fa-solid fa-graduation-cap text-blue-400 text-xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-3">{content.cards.focus.title}</h3>
        <p class="text-dim text-sm leading-relaxed">
          {content.cards.focus.text}
        </p>
      </Card>
      
      <Card variant="glass" class="p-8 hover-glow group">
        <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center mb-6 group-hover:bg-purple-500/20 transition-colors">
          <i class="fa-solid fa-chalkboard-user text-purple-400 text-xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-3">{content.cards.teach.title}</h3>
        <p class="text-dim text-sm leading-relaxed">
          {content.cards.teach.text}
        </p>
      </Card>
    </Section>

    <Section class="mb-24 animate-on-scroll delay-200">
      <FeatureCard
        badge={content.feature.badge}
        title={content.feature.title}
        description={content.feature.desc}
        tagString={content.feature.tags}
        url={portLink}
      />
    </Section>
    
    <Section class="mb-24 animate-on-scroll delay-300">
      <div class="text-center max-w-4xl mx-auto mb-16">
        <SectionHeading class="text-3xl font-bold mb-8">{content.skills.title}</SectionHeading>
        <TechStack skills={skillsData.programming} />
        <div class="flex flex-wrap justify-center gap-2 mt-8 opacity-90">
          {skillsData.professional.map(skill => (
            <Pill variant="default" class="text-sm">{skill.name}</Pill>
          ))}
        </div>
      </div>
    </Section>

    <Section class="text-center py-20 bg-accent/5 rounded-3xl border border-accent/10 animate-on-scroll delay-200">
      <h2 class="text-3xl font-bold mb-6">{content.cta.title}</h2>
      <p class="text-xl text-dim mb-10 max-w-xl mx-auto">
        {content.cta.text}
      </p>
      <Button href={contactLink}>{content.cta.btn}</Button>
    </Section>
  </main>
</Layout>

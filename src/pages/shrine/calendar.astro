---
import { getLiturgicalSeason, getSaint } from '../../utils/liturgy';
import '@styles/styles.css';

// Server Side Initial Render
const initialDate = new Date();
const initialSeason = getLiturgicalSeason(initialDate);
const initialSaint = getSaint(initialDate);

// Map colors to CSS gradients
const colorMap: Record<string, string> = {
    green:  'from-green-900/40 via-black to-black',
    purple: 'from-purple-900/40 via-black to-black',
    white:  'from-yellow-100/20 via-black to-black', 
    red:    'from-red-900/40 via-black to-black',
    black:  'from-gray-900 via-black to-black'
};

const bgGradient = colorMap[initialSeason.color] || colorMap.green;
const accentColor = {
    green: 'text-green-500',
    purple: 'text-purple-400',
    white: 'text-gold-200',
    red: 'text-red-500',
    black: 'text-gray-500'
}[initialSeason.color];

const initialDateString = initialDate.toLocaleDateString('da-DK', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
});
---

<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalenderen | Ad Majorem Dei Gloriam</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Fonts -->
    <link rel="icon" type="image/svg+xml" href="/assets/favicon-cross.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body { font-family: 'Cinzel', serif; }
        .sans { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-[#050508] text-gray-300 h-screen w-screen overflow-hidden m-0 p-0 selection:bg-gold-500/30">

    <!-- Dynamic Background -->
    <div id="bg-layer" class={`fixed inset-0 z-0 pointer-events-none bg-gradient-to-b ${bgGradient} transition-colors duration-1000`}>
         <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/stardust.png');"></div>
         <!-- Ambient Glow -->
         <div id="bg-glow" class={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] rounded-full blur-[150px] opacity-20 transition-colors duration-1000 ${initialSeason.color === 'white' ? 'bg-gold-500' : `bg-${initialSeason.color}-500`}`}></div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-8 left-8 z-50">
        <a href="/shrine" class="text-gold-500/60 hover:text-gold-400 transition-colors text-xl flex items-center gap-2 sans">
            <i class="fa-solid fa-arrow-left"></i>
            <span class="text-xs uppercase tracking-widest hidden md:inline">Tilbage</span>
        </a>
    </nav>

    <!-- Main Content -->
    <main class="relative z-10 w-full h-full flex flex-col items-center justify-center p-6 text-center">
        
        <div class="mb-4 flex items-center gap-4">
             <button id="prev-btn" class="text-gray-600 hover:text-gold-500 transition-colors p-2 md:p-4">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <span class="text-xs sans uppercase tracking-[0.4em] text-gray-500 animate-fade-in-up">Dato</span>
             <button id="next-btn" class="text-gray-600 hover:text-gold-500 transition-colors p-2 md:p-4">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <h1 id="date-display" class="text-2xl md:text-3xl text-gray-300 capitalize mb-12 animate-fade-in-up delay-100 w-full max-w-2xl">
            {initialDateString}
        </h1>

        <!-- Season Card -->
        <div class="relative group animate-fade-in-up delay-200">
            <!-- Border Glow -->
            <div id="card-glow" class={`absolute -inset-1 rounded-lg blur opacity-20 group-hover:opacity-40 transition duration-1000 ${initialSeason.color === 'white' ? 'bg-gold-500' : `bg-${initialSeason.color}-600`}`}></div>
            
            <div class="relative bg-black/40 backdrop-blur-md border border-white/10 p-12 md:p-16 rounded-lg max-w-lg min-w-[300px] md:min-w-[400px]">
                <i id="season-icon" class={`fa-solid fa-church text-4xl mb-6 opacity-80 transition-colors duration-500 ${accentColor}`}></i>
                
                <h2 id="season-name" class={`text-4xl md:text-5xl font-bold mb-6 drop-shadow-lg transition-colors duration-500 ${accentColor}`}>
                    {initialSeason.name}
                </h2>
                
                <div class="h-px w-24 bg-gradient-to-r from-transparent via-gray-500 to-transparent mx-auto mb-6"></div>
                
                <p id="season-desc" class="text-lg text-gray-400 italic min-h-[56px]">
                    {initialSeason.description}
                </p>

                <!-- Saint of the Day -->
                <div id="saint-wrapper" class={`mt-8 pt-6 border-t border-white/10 transition-opacity duration-500 ${!initialSaint ? 'opacity-0 hidden' : 'opacity-100'}`}>
                      <span id="saint-title" class="text-[10px] sans uppercase tracking-widest text-gold-500/80 block mb-2">{initialSaint?.title || ''}</span>
                      <h3 id="saint-name" class="text-xl font-serif text-gray-200">{initialSaint?.name || ''}</h3>
                 </div>

                 <!-- Liturgical Color Label -->
                 <div class="absolute top-4 right-4">
                    <div class="flex items-center gap-2" title="Liturgisk Farve">
                        <span id="color-label" class="text-[10px] sans uppercase tracking-widest text-gray-600 hidden group-hover:block transition-all">{initialSeason.color}</span>
                        <div id="color-dot" class={`w-3 h-3 rounded-full transition-colors duration-500 ${initialSeason.color === 'white' ? 'bg-gray-100' : `bg-${initialSeason.color}-600`} shadow-[0_0_10px_currentColor]`}></div>
                    </div>
                 </div>
            </div>
        </div>
        
    </main>

    <style>
        .animate-fade-in-up {
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script>
        // CLIENT SIDE LOGIC
        // Saints Data (Hardcoded for client demo)
        const saintsData: any = {
            "1-1": { name: "Guds Moder Maria", title: "Højtid" },
            "1-25": { name: "Paulus' Omvendelse", title: "Apostel" },
            "1-26": { name: "Timotheus og Titus", title: "Biskopper" },
            "1-28": { name: "Thomas Aquinas", title: "Kirkelærer" },
            "2-2": { name: "Kyndelmisse", title: "Fest" },
            "3-19": { name: "Josef", title: "Jomfru Marias Brudgom" },
            "3-25": { name: "Herrens Bebudelse", title: "Højtid" },
            "4-23": { name: "Georg", title: "Martyr" },
            "4-25": { name: "Markus", title: "Evangelist" },
            "4-29": { name: "Katarina af Siena", title: "Kirkelærer" },
            "5-3": { name: "Filip og Jakob", title: "Apostle" },
            "5-31": { name: "Marias Besøgelse", title: "Fest" },
            "6-24": { name: "Johannes Døberens Fødsel", title: "Højtid" },
            "6-29": { name: "Peter og Paulus", title: "Apostle" },
            "7-22": { name: "Maria Magdalena", title: "Apostel" },
            "7-25": { name: "Jakob", title: "Apostel" },
            "7-31": { name: "Ignatius af Loyola", title: "Præst" },
            "8-10": { name: "Laurentius", title: "Diakon og Martyr" },
            "8-15": { name: "Jomfru Marias Himmelfart", title: "Højtid" },
            "8-24": { name: "Bartolomæus", title: "Apostel" },
            "8-28": { name: "Augustin", title: "Biskop og Kirkelærer" },
            "9-8": { name: "Jomfru Marias Fødsel", title: "Fest" },
            "9-14": { name: "Korsets Ophøjelse", title: "Fest" },
            "9-21": { name: "Matthæus", title: "Apostel og Evangelist" },
            "9-29": { name: "Mikael, Gabriel og Rafael", title: "Ærkeengle" },
            "10-4": { name: "Frans af Assisi", title: "Munk" },
            "10-7": { name: "Vor Frue af Rosenkransen", title: "Fest" },
            "10-18": { name: "Lukas", title: "Evangelist" },
            "11-1": { name: "Alle Helgen", title: "Højtid" },
            "11-2": { name: "Alle Sjæle", title: "Ihukommelse" },
            "11-30": { name: "Andreas", title: "Apostel" },
            "12-6": { name: "Nikolaus", title: "Biskop" },
            "12-8": { name: "Marias Ubesmittede Undfangelse", title: "Højtid" },
            "12-13": { name: "Lucia", title: "Jomfru og Martyr" },
            "12-25": { name: "Jesu Fødsel", title: "Højtid" },
            "12-26": { name: "Stefanus", title: "Protomartyr" },
            "12-27": { name: "Johannes", title: "Apostel og Evangelist" },
        };

        function getSaint(date: Date) {
            const key = `${date.getMonth() + 1}-${date.getDate()}`;
            return saintsData[key] || null;
        }

        // --- Logic Copy Start ---
        function getEasterDate(year: number): Date {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1; 
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month, day);
        }

        function isSameDay(d1: Date, d2: Date) {
            return d1.getFullYear() === d2.getFullYear() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getDate() === d2.getDate();
        }

        function getLiturgicalSeason(date: Date) {
            const year = date.getFullYear();
            const easter = getEasterDate(year);
            const christmas = new Date(year, 11, 25); 
            const adventStart = new Date(christmas);
            adventStart.setDate(christmas.getDate() - (christmas.getDay() + 21)); 
            const ashWednesday = new Date(easter);
            ashWednesday.setDate(easter.getDate() - 46);
            const pentecost = new Date(easter);
            pentecost.setDate(easter.getDate() + 49);
            const now = date.getTime();

            if (now >= adventStart.getTime() && now < christmas.getTime()) {
                return { name: "Advent", color: 'purple', description: "Ventetiden. Vi forbereder os på Kristi komme i ydmyghed og bod." };
            }
            const epiphany = new Date(year + 1, 0, 6);
            if (now >= christmas.getTime() || (date.getMonth() === 0 && date.getDate() <= 6)) {
                return { name: "Juletiden", color: 'white', description: "Glæden over Guds inkarnation. Kristus er født!" };
            }
            if (now >= ashWednesday.getTime() && now < easter.getTime()) {
                if(now >= easter.getTime() - (7 * 24 * 60 * 60 * 1000)) {
                    return { name: "Den Stille Uge", color: 'purple', description: "Vi vandrer med Jesus mod korset og graven." }
                }
                return { name: "Fasten", color: 'purple', description: "40 dage i ørkenen. Bøn, faste og almisse." };
            }
            if (now >= easter.getTime() && now <= pentecost.getTime()) {
                return { name: "Påsketiden", color: 'white', description: "Han er opstanden! Døden er overvundet. Alleluia!" };
            }
            // Fix: Pentecost is a single day logic in original. 
            // For simplicity, let's treat it as a season boundary for 'Ordinary Time'
            if (isSameDay(date, pentecost)) {
                 return { name: "Pinse", color: 'red', description: "Helligånden kommer. Kirkens fødselsdag." };
            }
            return { name: "Almindelig Tid", color: 'green', description: "Kirken vokser. Vi lever i troen i hverdagen." };
        }
        // --- Logic Copy End ---

        // Config
        const colorMap: any = {
            green:  'bg-gradient-to-b from-green-900/40 via-black to-black',
            purple: 'bg-gradient-to-b from-purple-900/40 via-black to-black',
            white:  'bg-gradient-to-b from-yellow-100/20 via-black to-black', 
            red:    'bg-gradient-to-b from-red-900/40 via-black to-black',
            black:  'bg-gradient-to-b from-gray-900 via-black to-black'
        };

        const textColors: any = {
             green: 'text-green-500',
            purple: 'text-purple-400',
            white: 'text-gold-200',
            red: 'text-red-500',
            black: 'text-gray-500'
        };

        const bgGlowColors: any = {
             green: 'bg-green-500',
            purple: 'bg-purple-500',
            white: 'bg-gold-500',
             red: 'bg-red-500',
            black: 'bg-gray-500'
        };

        // State
        let currentDate = new Date();
        
        // Elements
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const dateDisplay = document.getElementById('date-display');
        
        const seasonName = document.getElementById('season-name');
        const seasonDesc = document.getElementById('season-desc');
        const seasonIcon = document.getElementById('season-icon');
        
        const bgLayer = document.getElementById('bg-layer');
        const bgGlow = document.getElementById('bg-glow');
        const cardGlow = document.getElementById('card-glow');
        const colorLabel = document.getElementById('color-label');
        const colorDot = document.getElementById('color-dot');

        // Saint Elements
        const saintWrapper = document.getElementById('saint-wrapper');
        const saintTitle = document.getElementById('saint-title');
        const saintName = document.getElementById('saint-name');

        // Update UI
        function updateUI() {
            const season = getLiturgicalSeason(currentDate);
            const saint = getSaint(currentDate);

            // Text
            if(dateDisplay) dateDisplay.innerText = currentDate.toLocaleDateString('da-DK', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if(seasonName) seasonName.innerText = season.name;
            if(seasonDesc) seasonDesc.innerText = season.description;
            if(colorLabel) colorLabel.innerText = season.color;

            // Saint
            if (saintWrapper) {
                if (saint) {
                    if(saintTitle) saintTitle.innerText = saint.title || '';
                    if(saintName) saintName.innerText = saint.name;
                    saintWrapper.classList.remove('opacity-0', 'hidden');
                    saintWrapper.classList.add('opacity-100');
                } else {
                    saintWrapper.classList.add('opacity-0');
                    // wait for transition to hide? Or just hide.
                     setTimeout(() => saintWrapper.classList.add('hidden'), 500);
                }
            }

            // Colors
            const textColorClass = textColors[season.color];
            const glowClass = bgGlowColors[season.color];
            const gradientClass = colorMap[season.color];

            // Update Classes (Remove all potential color classes first is simpler or just overwrite via style if complex. 
            // For tailorwind classes, we need to remove old and add new.)
            
            // Reset & Apply Accent Colors
            [seasonName, seasonIcon].forEach(el => {
                if(!el) return;
                // Remove all possible colors
                Object.values(textColors).forEach((c: any) => el.classList.remove(c));
                el.classList.add(textColorClass);
            });

            // BG Gradient (Hack: modify class list strictly)
            if(bgLayer) {
                // Remove all gradients
                Object.values(colorMap).forEach((c: any) => {
                     // Need to remove individual classes? Or just replace entire className?
                     // Easier to replace specific tailwind gradient classes.
                     // Actually, Astro's `class` attribute is static. 
                     // Let's use string replacement on className.
                     bgLayer.className = `fixed inset-0 z-0 pointer-events-none transition-colors duration-1000 ${gradientClass}`;
                });
            }

            // Glows
            if(bgGlow) {
                 Object.values(bgGlowColors).forEach((c: any) => bgGlow.classList.remove(c));
                 bgGlow.classList.add(season.color === 'white' ? 'bg-gold-500' : `bg-${season.color}-500`);
            }
            if(cardGlow) {
                 // Remove known colors
                 cardGlow.classList.remove('bg-gold-500', 'bg-green-600', 'bg-purple-600', 'bg-red-600', 'bg-gray-600', 'bg-white'); // simplistic
                 cardGlow.classList.add(season.color === 'white' ? 'bg-gold-500' : `bg-${season.color}-600`);
            }
            if(colorDot) {
                 colorDot.className = `w-3 h-3 rounded-full transition-colors duration-500 shadow-[0_0_10px_currentColor] ${season.color === 'white' ? 'bg-gray-100' : `bg-${season.color}-600`}`;
            }
        }

        // Listeners
        prevBtn?.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 1);
            updateUI();
        });

        nextBtn?.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 1);
            updateUI();
        });

    </script>
</body>
</html>

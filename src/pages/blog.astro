---
import Layout from '@layouts/Layout.astro';
import Pill from '@components/ui/Pill.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';
import BlogCard from '@components/blog/BlogCard.astro';
import { createClient } from '@supabase/supabase-js';

export const prerender = false;

const supabase = createClient(import.meta.env.SUPABASE_URL, import.meta.env.SUPABASE_ANON_KEY);
let { data: posts, error } = await supabase
  .from('posts')
  .select('*')
  .eq('published', true)
  .order('created_at', { ascending: false });

if (error || !posts) posts = [];
---

<Layout 
  title="Anton Meier Ebsen Jørgensen – Blog" 
  description="Blog med indlæg om faglige emner, træning og rejser."
  bodyClass="blog-page"
>

  <style>
    .blog-wrap { 
      max-width: 1200px; 
      margin: 24px auto; 
      padding: 0 16px 32px; 
    }

    .hero-grid {
      display: grid; 
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 22px; 
      align-items: start; 
    }

    .posts-grid {
      display: grid; 
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px; 
      margin-top: 14px;
    }

    @media (max-width: 980px) {
      .hero-grid { 
        grid-template-columns: 1fr; 
      }
      .posts-grid { 
        grid-template-columns: 1fr; 
      }
    }
  </style>

  <main class="blog-wrap">

    <!-- HERO -->
    <Section>
      <div class="hero-grid">
        <Card variant="glass" class="p-8">
          <p class="text-xs font-extrabold uppercase tracking-widest text-dim mb-3">Blog</p>
          <h1 class="text-4xl leading-[1.15] mb-5 font-bold">Indlæg og noter</h1>
          <p class="text-[17px] leading-relaxed text-dim mb-6 opacity-90">
            Tre spor: <strong>Fagligt</strong> (økonomi, data, modeller), <strong>Træning</strong> (struktur og progression)
            og <strong>Rejser</strong> (vandring, ruter og praktiske erfaringer).
          </p>
  
          <div class="flex flex-wrap gap-3 mb-6">
            <Button href="#latest">Seneste</Button>
            <Button href="/bucketlist" variant="ghost" class="text-gold-400 hover:text-gold-300"><i class="fa-solid fa-trophy mr-2"></i>Bucket List</Button>
          </div>
        </Card>
  
        <div class="hidden md:block">
          <Card variant="glass" class="p-6">
            <SectionHeading>Seneste</SectionHeading>
            <p class="text-dim opacity-80 m-0">
              {posts.length > 0 ? `Viser ${posts.length} indlæg.` : 'Ingen indlæg endnu.'}
            </p>
          </Card>
        </div>
      </div>
    </Section>

    <!-- ===================== -->
    <!-- FASTE SIDER (Ressourcer) -->
    <!-- ===================== -->
    <Section id="featured">
      <SectionHeading class="mb-4 text-xl font-bold">Faste Indlæg & Ressourcer</SectionHeading>
      <div class="posts-grid mb-12">
        <BlogCard 
          title="Mit Træningsprogram (6-dages Split)"
          tag="Træning"
          meta="Komplet program · PPL"
          description="Det fulde overblik over mine øvelser, sæt, tempo og fokusområder. Optimeret til progression."
          links={[{ label: 'Se programmet', url: '/traeningsprogram', icon: 'arrow-right' }]}
        />
        <BlogCard 
          title="Favoritbøger & Noter"
          tag="Læring"
          meta="Klassikere · Fagligt"
          description="En kurateret liste over de bøger, der har formet min tankegang mest."
          links={[{ label: 'Åbn bibliotek', url: '/books', icon: 'arrow-right' }]}
        />
        <BlogCard 
          title="Mine Favoritpodcasts"
          tag="Inspiration"
          meta="Makro · Data · Humor"
          description="En oversigt over de bedste kilder til viden og underholdning på farten."
          links={[{ label: 'Se listen', url: '/podcasts', icon: 'arrow-right' }]}
        />
      </div>
    </Section>

    <!-- ===================== -->
    <!-- ALLE INDLÆG (DB) -->
    <!-- ===================== -->
    <Section id="latest">
      <div class="flex flex-wrap items-baseline justify-between gap-2 mb-4">
        <SectionHeading class="mb-0 text-xl font-bold">Seneste Indlæg</SectionHeading>
        <p class="m-0 text-dim text-sm opacity-80">Direkte fra databasen.</p>
      </div>

      <div class="posts-grid">
        {posts.map(p => (
            <BlogCard 
              title={p.title}
              tag={p.category || "Blog"}
              meta={new Date(p.created_at).toLocaleDateString('da-DK')}
              description={p.excerpt || ""}
              links={[{ text: 'Læs mere', url: `/blog/${p.slug}`, icon: 'arrow-right' }]}
            />
        ))}
        {posts.length === 0 && (
            <div class="col-span-3 text-center py-12 border border-white/5 rounded-lg bg-white/5">
                <i class="fa-solid fa-feather text-4xl text-dim mb-4 opacity-50"></i>
                <p class="text-dim">Ingen indlæg fundet. Tjek din database.</p>
            </div>
        )}
      </div>
    </Section>

    <!-- CTA -->
    <Section>
      <ContactCard 
        variant="glass" 
        title="Forslag til indlæg?" 
        text="Hvis du har et emne, du gerne vil have mig til at skrive om, så skriv endelig."
        action="contact"
      />
    </Section>

  </main>
</Layout>

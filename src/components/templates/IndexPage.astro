---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import Pill from '@components/ui/Pill.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import FeatureCard from '@components/ui/FeatureCard.astro';
import TechStack from '@components/ui/TechStack.astro';
import { Image } from 'astro:assets';
import myImageSrc from '../../assets/img/billede-af-mig.jpg';


import { getEntry } from 'astro:content';

interface Props {
  lang: 'da' | 'en';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

const portLink = isDa ? '/portfolio' : '/en/portfolio';
const cvLink = isDa ? '/cv' : '/en/cv';
const guestbookLink = isDa ? '/guestbook' : '/en/guestbook';
const contactLink = isDa ? '/contact' : '/en/contact';

const entry = await getEntry('pages', `${lang}/home`);
if (!entry) throw new Error(`Missing content for ${lang}/home`);
const content: any = entry.data;

let skillsRows = [];
let error = null;

// try {
//   if (supabase) {
//     const { data, error: dbError } = await supabase.from('skills').select('*');
//     if (dbError) throw dbError;
//     skillsRows = data;
//   }
// } catch (e) {
//   console.error("Supabase fetch failed", e);
//   error = e;
// }

if (error || !skillsRows || skillsRows.length === 0) {
    const skillsEntry = await getEntry('skills', lang);
    if (skillsEntry && skillsEntry.data) {
        const fd = skillsEntry.data;
        const prog = (fd.programming || []).map(s => ({ ...s, category: 'programming' }));
        const prof = (fd.professional || []).map(s => ({ ...s, category: 'professional' }));
        skillsRows = [...prog, ...prof];
    } else {
        skillsRows = [];
    }
}

const skillsData = {
  programming: skillsRows?.filter(s => s.category === 'programming') || [],
  professional: skillsRows?.filter(s => s.category === 'professional') || []
};
---

<Layout 
  title={content.title} 
  description={content.desc}
>
  <main class="container mx-auto px-4 py-12">
    <Section class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-20 animate-on-scroll">
      <div>
        <h1 class="text-5xl md:text-6xl font-extrabold leading-tight tracking-tight">
          Anton Meier <span class="text-accent underline decoration-4 underline-offset-8">Ebsen</span> Jørgensen
        </h1>
        <p class="text-xl text-dim leading-relaxed max-w-lg">
          {content.hero.text}
        </p>
        <div class="flex flex-col sm:flex-row gap-4 pt-4">
          <Button href={portLink} size="lg">{content.hero.btnPort}</Button>
          <Button href={cvLink} variant="ghost" size="lg">{content.hero.btnCV}</Button>
        </div>
        <a href={guestbookLink} class="inline-block mt-4 text-sm text-accent hover:text-accent-light transition-colors">
          {content.hero.btnGuest} →
        </a>
      </div>
      
      <a href={isDa ? '/about' : '/en/about'} class="relative group block">
        <div class="absolute -inset-4 bg-gradient-to-r from-accent/20 to-purple-500/20 rounded-3xl blur-2xl opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 animate-[pulseGlow_3s_ease-in-out_infinite]"></div>
        <div class="relative aspect-square overflow-hidden rounded-2xl border-2 border-accent/30 shadow-2xl group-hover:border-accent/60 transition-all duration-300">
          <Image 
            src={myImageSrc} 
            alt="Anton Meier Ebsen Jørgensen" 
            class="object-cover w-full h-full grayscale hover:grayscale-0 transition-all duration-700 group-hover:scale-105"
            loading="eager"
            width={600}
            height={600}
          />
          <div class="absolute top-4 right-4 px-3 py-1.5 bg-green-500/90 backdrop-blur-sm text-white text-xs font-bold rounded-full shadow-lg flex items-center gap-1.5">
            <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
            {isDa ? 'Tilgaengelig' : 'Available'}
          </div>
        </div>
      </a>
    </Section>

    <Section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-24 animate-on-scroll delay-100">
      <Card variant="glass" class="p-8 hover-glow group">
        <div class="w-12 h-12 rounded-xl bg-accent/10 flex items-center justify-center mb-6 group-hover:bg-accent/20 transition-colors">
          <i class="fa-solid fa-code text-accent text-xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-3">{content.cards.model.title}</h3>
        <p class="text-dim text-sm leading-relaxed">
          {content.cards.model.text}
        </p>
      </Card>
      
      <Card variant="glass" class="p-8 hover-glow group">
        <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center mb-6 group-hover:bg-blue-500/20 transition-colors">
          <i class="fa-solid fa-graduation-cap text-blue-400 text-xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-3">{content.cards.focus.title}</h3>
        <p class="text-dim text-sm leading-relaxed">
          {content.cards.focus.text}
        </p>
      </Card>
      
      <Card variant="glass" class="p-8 hover-glow group">
        <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center mb-6 group-hover:bg-purple-500/20 transition-colors">
          <i class="fa-solid fa-chalkboard-user text-purple-400 text-xl"></i>
        </div>
        <h3 class="text-xl font-bold mb-3">{content.cards.teach.title}</h3>
        <p class="text-dim text-sm leading-relaxed">
          {content.cards.teach.text}
        </p>
      </Card>
    </Section>

    <Section class="mb-24 animate-on-scroll delay-200">
      <FeatureCard
        badge={content.feature.badge}
        title={content.feature.title}
        description={content.feature.desc}
        tagString={content.feature.tags}
        url={portLink}
      />
    </Section>
    
    <Section class="mb-24 animate-on-scroll delay-300">
      <div class="text-center max-w-4xl mx-auto mb-16">
        <SectionHeading class="text-3xl font-bold mb-8">{content.skills.title}</SectionHeading>
        
        <!-- Live Skills Container -->
        <div id="skills-live-container">
          <!-- Static Fallback Content -->
          <TechStack skills={skillsData.programming} />
          <div class="flex flex-wrap justify-center gap-2 mt-8 opacity-90">
            {skillsData.professional.map(skill => (
              <Pill variant="default" class="text-sm">{skill.name}</Pill>
            ))}
          </div>
        </div>

      </div>
    </Section>

    <!-- Script to hydrate live skills if available -->
    <script>
      // Fetch fresh skills data from Supabase via partial
      document.addEventListener('astro:page-load', async () => {
        try {
          const container = document.getElementById('skills-live-container');
          if (!container) return;

          const res = await fetch('/partials/skills');
          if (res.ok) {
            const html = await res.text();
            // Only replace if meaningful content returned
            if (html.includes('skills-container-inner')) {
                container.innerHTML = html;
            }
          }
        } catch (e) {
          console.warn('Live skills fetch failed, using static fallback');
        }
      });
    </script>

    <Section class="mb-24">
      <div class="text-center max-w-4xl mx-auto mb-12">
        <SectionHeading class="text-3xl font-bold mb-4">{isDa ? 'Hvad andre siger' : 'What Others Say'}</SectionHeading>
        <p class="text-dim">{isDa ? 'Feedback fra kolleger og samarbejdspartnere' : 'Feedback from colleagues and partners'}</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card variant="glass" class="p-6 hover-glow">
          <div class="flex items-start gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-accent to-purple-500 flex items-center justify-center text-white font-bold">
              JD
            </div>
            <div>
              <div class="font-bold">Jane Doe</div>
              <div class="text-xs text-dim">{isDa ? 'Senior Udvikler, Tech Corp' : 'Senior Developer, Tech Corp'}</div>
            </div>
          </div>
          <p class="text-sm text-dim italic leading-relaxed">
            "{isDa ? 'Anton leverer altid kode af høj kvalitet og er utrolig god til at tackle komplekse problemer. En ægte teamplayer!' : 'Anton consistently delivers high-quality code and is incredible at tackling complex problems. A true team player!'}"
          </p>
          <div class="flex gap-1 mt-4 text-accent">
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
          </div>
        </Card>

        <Card variant="glass" class="p-6 hover-glow">
          <div class="flex items-start gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold">
              MS
            </div>
            <div>
              <div class="font-bold">Michael Smith</div>
              <div class="text-xs text-dim">{isDa ? 'Produktejer, StartupXYZ' : 'Product Owner, StartupXYZ'}</div>
            </div>
          </div>
          <p class="text-sm text-dim italic leading-relaxed">
            "{isDa ? 'Fantastisk at arbejde med! Anton forstår både den tekniske og forretningsmæssige side og leverer altid til tiden.' : 'Fantastic to work with! Anton understands both the technical and business side and always delivers on time.'}"
          </p>
          <div class="flex gap-1 mt-4 text-accent">
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
          </div>
        </Card>

        <Card variant="glass" class="p-6 hover-glow">
          <div class="flex items-start gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center text-white font-bold">
              SJ
            </div>
            <div>
              <div class="font-bold">Sarah Johnson</div>
              <div class="text-xs text-dim">{isDa ? 'CTO, InnovateLab' : 'CTO, InnovateLab'}</div>
            </div>
          </div>
          <p class="text-sm text-dim italic leading-relaxed">
            "{isDa ? 'En af de bedste udviklere jeg har arbejdet med. Stærke tekniske skills og fremragende kommunikationsevner.' : 'One of the best developers I\'ve worked with. Strong technical skills and excellent communication.'}"
          </p>
          <div class="flex gap-1 mt-4 text-accent">
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
          </div>
        </Card>
      </div>
    </Section>

    <Section class="text-center py-20 bg-accent/5 rounded-3xl border border-accent/10 animate-on-scroll delay-200">
      <h2 class="text-3xl font-bold mb-6">{content.cta.title}</h2>
      <p class="text-xl text-dim mb-10 max-w-xl mx-auto">
        {content.cta.text}
      </p>
      <Button href={contactLink}>{content.cta.btn}</Button>
    </Section>
  </main>
</Layout>

---
import CaminoLayout from '../../layouts/CaminoLayout.astro';
import { caminoContent } from '../../data/camino';

interface Props {
  lang: 'da' | 'en';
}

const { lang } = Astro.props;
const t = caminoContent[lang];

const waypoints = t.waypoints;
const elevationData = t.elevationData;
const weatherCities = t.weatherCities;
---

<CaminoLayout title={`${lang === 'da' ? 'Rute & Kort' : 'Route & Map'} | ${t.title}`} description={t.desc} lang={lang}>
  <article class="camino-subpage route-page">
    <header class="subpage-hero">
      <div class="container">
        <a href={lang === 'da' ? '/camino' : '/en/camino'} class="back-link">
          <i class="fa-solid fa-arrow-left"></i> {lang === 'da' ? 'Tilbage til Hub' : 'Back to Hub'}
        </a>
        <div class="hero-content">
          <span class="eyebrow">{t.eyebrow}</span>
          <h1>{lang === 'da' ? 'Ruten & Etaper' : 'The Route & Stages'}</h1>
          <p class="subtitle">{t.subtitle}</p>
        </div>
      </div>
    </header>

    <div class="container main-content">
      <div class="content-grid">
        <aside class="sidebar">
          <nav class="sticky-nav">
            <h3>{t.navTitle}</h3>
            <ul>
              <li><a href="#map"><i class="fa-solid fa-map"></i> {t.mapTitle}</a></li>
              <li><a href="#weather"><i class="fa-solid fa-cloud-sun"></i> {lang === 'da' ? 'Live Vejr' : 'Live Weather'}</a></li>
              <li><a href="#elevation"><i class="fa-solid fa-chart-area"></i> {t.elevTitle}</a></li>
              <li><a href="#timeline"><i class="fa-solid fa-route"></i> {lang === 'da' ? 'Rejsen' : 'The Journey'}</a></li>
              <li><a href="#stages"><i class="fa-solid fa-list-check"></i> {t.stagesTitle}</a></li>
              <li><a href="#sacred"><i class="fa-solid fa-church"></i> {t.churchesTitle}</a></li>
              <li><a href="#prayer"><i class="fa-solid fa-hands-praying"></i> {t.prayerTitle}</a></li>
            </ul>
          </nav>
        </aside>

        <main class="sections">
          <!-- Interactive Map -->
          <section id="map" class="camino-section card-glass">
            <div class="section-header">
              <div class="icon-box"><i class="fa-solid fa-map"></i></div>
              <div class="title-meta">
                <h2>{t.mapTitle}</h2>
                <p>{t.mapDesc}</p>
              </div>
            </div>
            <div id="camino-map" class="map-container"></div>
          </section>

          <!-- Live Weather -->
          <section id="weather" class="camino-section card-glass">
            <div class="section-header">
              <div class="icon-box"><i class="fa-solid fa-cloud-sun"></i></div>
              <div class="title-meta">
                <h2>{lang === 'da' ? 'Live Vejr på Ruten' : 'Live Weather on the Route'}</h2>
                <p>{lang === 'da' ? 'Hold øje med forholdene i de vigtigste byer lige nu.' : 'Check the current conditions in key cities along the way.'}</p>
              </div>
            </div>
            <div class="weather-grid" id="weather-app">
              {weatherCities.map((city: any) => (
                <div class="weather-card" data-lat={city.lat} data-lon={city.lon}>
                  <h3>{city.name}</h3>
                  <div class="weather-loading">Laster...</div>
                </div>
              ))}
            </div>
          </section>

          <!-- Interactive Elevation Profile -->
          <section id="elevation" class="camino-section card-glass">
            <div class="section-header">
              <div class="icon-box"><i class="fa-solid fa-chart-area"></i></div>
              <div class="title-meta">
                <h2>{t.elevTitle}</h2>
                <p>{t.elevSubtitle}</p>
              </div>
            </div>
            <div class="elevation-chart-wrapper">
              <svg viewBox="0 0 800 200" class="elevation-svg" id="elevation-chart">
                <!-- Grid Lines -->
                <line x1="0" y1="180" x2="800" y2="180" stroke="rgba(255,255,255,0.1)" stroke-width="1" />
                <line x1="0" y1="130" x2="800" y2="130" stroke="rgba(255,255,255,0.05)" stroke-width="1" />
                <line x1="0" y1="80" x2="800" y2="80" stroke="rgba(255,255,255,0.05)" stroke-width="1" />
                <line x1="0" y1="30" x2="800" y2="30" stroke="rgba(255,255,255,0.05)" stroke-width="1" />
                
                <!-- The Path (Will be generated by JS) -->
                <path id="elev-path" fill="url(#elev-grad)" stroke="var(--accent)" stroke-width="2" />
                
                <defs>
                  <linearGradient id="elev-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:var(--accent); stop-opacity:0.3" />
                    <stop offset="100%" style="stop-color:var(--accent); stop-opacity:0" />
                  </linearGradient>
                </defs>
              </svg>
              <div id="elev-tooltip" class="elev-tooltip"></div>
            </div>
          </section>

          <!-- Journey Timeline -->
          <section id="timeline" class="camino-section card-glass">
            <div class="section-header">
              <div class="icon-box"><i class="fa-solid fa-route"></i></div>
              <div class="title-meta">
                <h2>{lang === 'da' ? 'Rejsens Milepæle' : 'Journey Milestones'}</h2>
                <p>{lang === 'da' ? 'Rul gennem de vigtigste stops på din vej.' : 'Scroll through the most important stops on your way.'}</p>
              </div>
            </div>
            <div class="vertical-timeline">
              <div class="timeline-line"></div>
              {waypoints.map((wp: any) => (
                <div class="timeline-item reveal">
                  <div class="timeline-marker">
                    <span class={`dot ${wp.type}`}></span>
                  </div>
                  <div class="timeline-content">
                    <div class="wp-meta">KM {wp.km}</div>
                    <h3>{wp.name}</h3>
                    <p>{wp.desc}</p>
                  </div>
                </div>
              ))}
            </div>
          </section>

          <!-- Stages Section -->
          <section id="stages" class="camino-section card-glass">
            <div class="section-header">
              <div class="icon-box"><i class="fa-solid fa-list-check"></i></div>
              <div class="title-meta">
                <h2>{t.stagesTitle}</h2>
                <p>{t.stagesSubtitle}</p>
              </div>
            </div>
            <div class="stages-grid">
              {t.fullStages.map((stage: any) => (
                <div class="stage-card" data-difficulty={stage.difficulty}>
                  <div class="stage-day">Dag {stage.day}</div>
                  <div class="stage-path">
                    <span class="from">{stage.from}</span>
                    <i class="fa-solid fa-arrow-right"></i>
                    <span class="to">{stage.to}</span>
                  </div>
                  <div class="stage-meta">
                    <span class="km">{stage.km} km</span>
                    <span class={`difficulty ${stage.difficulty}`}>{t.stagesLegend[stage.difficulty]}</span>
                  </div>
                  {stage.note && <p class="stage-note">{stage.note}</p>}
                </div>
              ))}
            </div>
          </section>

          <!-- Sacred Places -->
          <section id="sacred" class="camino-section card-glass">
            <div class="section-header">
              <div class="icon-box"><i class="fa-solid fa-church"></i></div>
              <div class="title-meta">
                <h2>{t.churchesTitle}</h2>
              </div>
            </div>
            <div class="church-list">
              {t.churches.map((church: any) => (
                <div class="church-card">
                  <div class="church-icon"><i class={`fa-solid ${church.icon}`}></i></div>
                  <div class="church-info">
                    <h3>{church.name}</h3>
                    <span class="location">{church.loc}</span>
                    <p>{church.desc}</p>
                  </div>
                </div>
              ))}
            </div>
          </section>

          <!-- Prayer Section -->
          <section id="prayer" class="camino-section card-glass prayer-theme">
            <div class="section-header">
              <div class="icon-box"><i class="fa-solid fa-hands-praying"></i></div>
              <div class="title-meta">
                <h2>{t.prayerTitle}</h2>
                <p>{t.prayerSubtitle}</p>
              </div>
            </div>
            <div class="prayer-content">
              <p class="prayer-text">{t.prayer}</p>
              <span class="prayer-attrib">{t.prayerAttrib}</span>
            </div>
          </section>
        </main>
      </div>
    </div>
  </article>

  <style>
    .camino-subpage { color: var(--text); padding-bottom: 5rem; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
    .subpage-hero { 
      background: linear-gradient(to bottom, rgba(8,8,8,0.4), rgba(8,8,8,0.9)), url('/assets/img/hero/camino-route-bg.jpg'); 
      background-size: cover; background-position: center; padding: 8rem 0 4rem; border-bottom: 1px solid var(--accent-soft); margin-bottom: 4rem;
    }
    .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--accent); text-decoration: none; margin-bottom: 2rem; font-weight: 600; }
    .hero-content h1 { font-size: clamp(2.5rem, 5vw, 4rem); color: #fff; margin: 0.5rem 0; letter-spacing: -0.02em; }
    .content-grid { display: grid; grid-template-columns: 280px 1fr; gap: 4rem; }
    @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } .sidebar { display: none; } }
    
    .camino-section { margin-bottom: 4rem; padding: 3rem; border-radius: 32px; }

    /* Weather Grid */
    .weather-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
    .weather-card { background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); text-align: center; }
    .weather-card h3 { font-size: 1rem; color: var(--text-dim); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05rem; }
    .weather-temp { font-size: 2.5rem; font-weight: 800; color: var(--accent); margin: 0.5rem 0; }
    .weather-desc { font-size: 0.9rem; color: var(--text); }

    /* Elevation Chart */
    .elevation-chart-wrapper { position: relative; width: 100%; aspect-ratio: 4 / 1; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 1rem; border: 1px solid rgba(255,255,255,0.05); }
    .elevation-svg { width: 100%; height: 100%; overflow: visible; }
    .elev-tooltip { position: absolute; pointer-events: none; background: var(--accent); color: #000; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; font-size: 0.85rem; display: none; transform: translate(-50%, -100%); margin-top: -10px; z-index: 10; }

    /* Timeline */
    .vertical-timeline { position: relative; padding-left: 60px; }
    .timeline-item { position: relative; margin-bottom: 3rem; }
    .timeline-marker { position: absolute; left: -60px; width: 60px; height: 100%; display: flex; justify-content: center; top: 5px; }
    .timeline-marker .dot { width: 20px; height: 20px; border-radius: 50%; background: #222; border: 3px solid var(--accent); z-index: 5; box-shadow: 0 0 10px var(--accent-soft); }
    .timeline-marker .dot.start, .timeline-marker .dot.end { background: var(--accent); scale: 1.3; }
    .timeline-content h3 { font-size: 1.25rem; margin: 0.25rem 0; }
    .wp-meta { font-size: 0.8rem; font-weight: 800; color: var(--accent); text-transform: uppercase; }

    /* Map */
    .map-container { height: 500px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }

    /* Sidebar and Common */
    .sticky-nav { position: sticky; top: 100px; padding: 2rem; border-radius: 24px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); }
    .sticky-nav a { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 0; color: var(--text-dim); text-decoration: none; transition: all 0.3s; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .sticky-nav a:hover { color: var(--accent); padding-left: 0.5rem; }

    /* Stages Grid */
    .stages-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
    .stage-card { background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); border-left: 4px solid #444; }
    .stage-day { font-size: 0.8rem; font-weight: 700; color: var(--accent); text-transform: uppercase; }
    .stage-card[data-difficulty="hard"] { border-left-color: #f87171; }
    .stage-card[data-difficulty="moderate"] { border-left-color: #fbbf24; }
    .stage-card[data-difficulty="easy"] { border-left-color: #4ade80; }
    .difficulty.hard { color: #f87171; }
    .difficulty.moderate { color: #fbbf24; }
    .difficulty.easy { color: #4ade80; }
  </style>

  <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script define:vars={{ waypoints, elevationData }}>
    document.addEventListener('DOMContentLoaded', () => {
      // 1. Map Logic
      const mapContainer = document.getElementById('camino-map');
      if (mapContainer) {
        const map = L.map('camino-map').setView([42.5, -4.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const routeLine = waypoints.map(w => [w.lat, w.lng]);
        L.polyline(routeLine, { color: '#D4AF37', weight: 4, opacity: 0.7 }).addTo(map);

        waypoints.forEach(w => {
           const dot = L.circleMarker([w.lat, w.lng], {
            radius: w.type === 'city' ? 8 : 5,
            fillColor: w.type === 'start' || w.type === 'end' ? '#D4AF37' : '#fff',
            color: '#000',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.9
          }).addTo(map);
          dot.bindPopup(`<b>${w.name}</b><br>${w.desc}<br><em>KM ${w.km}</em>`);
        });
      }

      // 2. Weather Logic
      const weatherCards = document.querySelectorAll('.weather-card');
      weatherCards.forEach(card => {
        const { lat, lon } = card.dataset;
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
          .then(res => res.json())
          .then(data => {
            const weather = data.current_weather;
            card.innerHTML = `
              <h3>${card.querySelector('h3').innerText}</h3>
              <div class="weather-temp">${Math.round(weather.temperature)}°C</div>
              <div class="weather-desc">Vind: ${weather.windspeed} km/h</div>
            `;
          })
          .catch(() => { card.innerHTML += '<p>Data utilgængelig</p>'; });
      });

      // 3. Elevation Profile SVG Logic
      const path = document.getElementById('elev-path');
      const tooltip = document.getElementById('elev-tooltip');
      const chart = document.getElementById('elevation-chart');

      if (path && elevationData.length > 0) {
        const width = 800;
        const height = 150; // Use 150 for data, leaving 30 for baseline
        const maxElev = 1600;
        const totalKm = 800;

        let d = `M 0 180 `; // Start at bottom-left
        elevationData.forEach(p => {
          const x = (p.km / totalKm) * width;
          const y = 180 - (p.elev / maxElev) * height;
          d += `L ${x} ${y} `;
        });
        d += `L 800 180 Z`; // Close path to bottom-right
        path.setAttribute('d', d);

        // Hover effect for tooltip
        chart.addEventListener('mousemove', (e) => {
          const rect = chart.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const km = (mouseX / rect.width) * totalKm;
          
          // Find closest point
          let closest = elevationData[0];
          let minDist = 999;
          elevationData.forEach(p => {
            if (Math.abs(p.km - km) < minDist) {
              minDist = Math.abs(p.km - km);
              closest = p;
            }
          });

          tooltip.style.display = 'block';
          tooltip.style.left = mouseX + 'px';
          tooltip.innerHTML = `${closest.elev}m <br>KM ${closest.km}`;
        });

        chart.addEventListener('mouseleave', () => {
          tooltip.style.display = 'none';
        });
      }
    });
  </script>
</CaminoLayout>

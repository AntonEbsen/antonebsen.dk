---
import Layout from '../layouts/BaseLayout.astro';
import Section from '../components/ui/Section.astro';
import Card from '../components/ui/Card.astro';
import SectionHeading from '../components/ui/SectionHeading.astro';
import { supabase } from '../lib/supabase';

// Helper to fetch count
async function getTableCount(table: string) {
  if (!supabase) return 0;
  const { count, error } = await supabase.from(table).select('*', { count: 'exact', head: true });
  if (error) return 0;
  return count;
}

const bookCount = await getTableCount('books');
const podcastCount = await getTableCount('podcasts');
const certCount = await getTableCount('certifications');
const caseCount = 3; // Static for now

// Fetch initial guestbook data
let guestbookEntries = [];
if (supabase) {
    const { data } = await supabase
        .from('guestbook')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(5);
    guestbookEntries = data || [];
}
---

<Layout title="Quantum Analytics | Dashboard">
  <Section class="py-20">
    <SectionHeading title="Quantum Analytics" subtitle="System Status & Telemetry" />

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
      <Card variant="glass" class="p-6 flex flex-col items-center justify-center text-center group hover:border-accent/50 transition-colors">
        <i class="fa-solid fa-book text-3xl text-accent mb-4 group-hover:scale-110 transition-transform"></i>
        <h3 class="text-3xl font-bold text-white mb-1">{bookCount}</h3>
        <p class="text-sm text-dim uppercase tracking-wider">Books Logged</p>
      </Card>

      <Card variant="glass" class="p-6 flex flex-col items-center justify-center text-center group hover:border-accent/50 transition-colors">
        <i class="fa-solid fa-microphone text-3xl text-accent mb-4 group-hover:scale-110 transition-transform"></i>
        <h3 class="text-3xl font-bold text-white mb-1">{podcastCount}</h3>
        <p class="text-sm text-dim uppercase tracking-wider">Episodes Heard</p>
      </Card>

      <Card variant="glass" class="p-6 flex flex-col items-center justify-center text-center group hover:border-accent/50 transition-colors">
        <i class="fa-solid fa-certificate text-3xl text-accent mb-4 group-hover:scale-110 transition-transform"></i>
        <h3 class="text-3xl font-bold text-white mb-1">{certCount}</h3>
        <p class="text-sm text-dim uppercase tracking-wider">Certifications</p>
      </Card>

      <Card variant="glass" class="p-6 flex flex-col items-center justify-center text-center group hover:border-accent/50 transition-colors">
        <i class="fa-solid fa-briefcase text-3xl text-accent mb-4 group-hover:scale-110 transition-transform"></i>
        <h3 class="text-3xl font-bold text-white mb-1">{caseCount}</h3>
        <p class="text-sm text-dim uppercase tracking-wider">Active Cases</p>
      </Card>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <Card variant="gradient" class="p-8">
        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <i class="fa-solid fa-server text-accent"></i> System Health
        </h3>
        <div class="space-y-4">
          <div class="flex justify-between items-center border-b border-white/5 pb-2">
            <span class="text-dim">Status</span>
            <span class="text-green-400 font-mono font-bold">OPERATIONAL</span>
          </div>
          <div class="flex justify-between items-center border-b border-white/5 pb-2">
            <span class="text-dim">Database</span>
            <span class="text-green-400 font-mono font-bold">CONNECTED</span>
          </div>
          <div class="flex justify-between items-center border-b border-white/5 pb-2">
            <span class="text-dim">Vercel Region</span>
            <span class="text-accent font-mono">fra1 (Frankfurt)</span>
          </div>
          <div class="flex justify-between items-center border-b border-white/5 pb-2">
            <span class="text-dim">Last Deploy</span>
            <span class="text-white font-mono">{new Date().toLocaleDateString()}</span>
          </div>
        </div>
      </Card>

      <Card variant="gradient" class="p-8">
        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <i class="fa-solid fa-link text-accent"></i> Quick Links
        </h3>
        <div class="grid grid-cols-2 gap-4">
           <a href="/api" class="block p-4 rounded-lg bg-white/5 hover:bg-white/10 text-center transition-colors">
             <i class="fa-solid fa-database mb-2 text-2xl text-accent/80"></i>
             <div class="text-sm font-bold text-white">API Endpoints</div>
           </a>
           <a href="https://github.com/AntonEbsen/antonebsen.dk" target="_blank" class="block p-4 rounded-lg bg-white/5 hover:bg-white/10 text-center transition-colors">
             <i class="fa-brands fa-github mb-2 text-2xl text-accent/80"></i>
             <div class="text-sm font-bold text-white">Repository</div>
           </a>
           <a href="/stats/training" class="block p-4 rounded-lg bg-white/5 hover:bg-white/10 text-center transition-colors">
             <i class="fa-solid fa-dumbbell mb-2 text-2xl text-accent/80"></i>
             <div class="text-sm font-bold text-white">Training Data</div>
           </a>
           <a href="/ai-project" class="block p-4 rounded-lg bg-white/5 hover:bg-white/10 text-center transition-colors">
             <i class="fa-solid fa-brain mb-2 text-2xl text-accent/80"></i>
             <div class="text-sm font-bold text-white">AI Neural Net</div>
           </a>
        </div>
      </Card>
    <Card variant="gradient" class="p-8 lg:col-span-2">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="fa-solid fa-comments text-accent"></i> Live Guestbook Feed
                <span class="text-[10px] bg-red-500/20 text-red-500 border border-red-500/30 px-2 py-0.5 rounded-full uppercase tracking-wider animate-pulse ml-2" id="live-indicator">Realtime</span>
            </h3>
            <span class="text-xs text-dim" id="connection-status">Connecting...</span>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="text-dim border-b border-white/10">
                        <th class="pb-3 pl-2">Time</th>
                        <th class="pb-3">Name</th>
                        <th class="pb-3">Message</th>
                        <th class="pb-3 text-right pr-2">Status</th>
                    </tr>
                </thead>
                <tbody id="guestbook-table-body" class="divide-y divide-white/5">
                   {guestbookEntries.length > 0 ? guestbookEntries.map(entry => (
                       <tr class="text-dim border-b border-white/5 last:border-none hover:bg-white/5 transition-colors">
                            <td class="py-3 pl-2 font-mono text-xs">{new Date(entry.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                            <td class="py-3 font-medium text-white">{entry.name}</td>
                            <td class="py-3 text-dim truncate max-w-[200px]">{entry.message}</td>
                            <td class="py-3 text-right pr-2">
                               <span class={`text-[10px] px-2 py-0.5 rounded border ${entry.is_approved ? 'bg-green-500/10 border-green-500 text-green-500' : 'bg-yellow-500/10 border-yellow-500 text-yellow-500'}`}>
                                 {entry.is_approved ? 'LIVE' : 'PENDING'}
                               </span>
                            </td>
                       </tr>
                   )) : (
                       <tr class="text-dim italic" id="loading-row"><td colspan="4" class="py-4 text-center">Waiting for realtime data...</td></tr>
                   )}
                </tbody>
            </table>
        </div>
    </Card>
    </div>
  </Section>

  <script define:vars={{ 
    SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL, 
    SUPABASE_KEY: import.meta.env.PUBLIC_SUPABASE_ANON_KEY 
  }}>
    // Client-side Realtime
    if (SUPABASE_URL && SUPABASE_KEY) {
        import('https://esm.sh/@supabase/supabase-js@2').then(({ createClient }) => {
            const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            const tableBody = document.getElementById('guestbook-table-body');
            const statusEl = document.getElementById('connection-status');
            const indicator = document.getElementById('live-indicator');

            statusEl.innerText = "Connected";
            
            supabase
                .channel('guestbook-feed')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'guestbook' }, (payload) => {
                    const newRow = payload.new;
                    const date = new Date(newRow.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const tr = document.createElement('tr');
                    tr.className = "animate-fade-in bg-accent/5"; // Highlight new row
                    tr.innerHTML = `
                        <td class="py-3 pl-2 text-dim font-mono text-xs">${date}</td>
                        <td class="py-3 font-medium text-white">${newRow.name}</td>
                        <td class="py-3 text-dim truncate max-w-[200px]">${newRow.message}</td>
                        <td class="py-3 text-right pr-2">
                           <span class="text-[10px] px-2 py-0.5 rounded border ${newRow.is_approved ? 'bg-green-500/10 border-green-500 text-green-500' : 'bg-yellow-500/10 border-yellow-500 text-yellow-500'}">
                             ${newRow.is_approved ? 'LIVE' : 'PENDING'}
                           </span>
                        </td>
                    `;
                    
                    // Remove loading row if exists
                    const loading = document.getElementById('loading-row');
                    if(loading) loading.remove();
                    
                    tableBody.prepend(tr);
                    
                    // Flash indicator
                    indicator.classList.remove('text-red-500', 'border-red-500/30', 'bg-red-500/20');
                    indicator.classList.add('text-green-500', 'border-green-500/30', 'bg-green-500/20');
                    setTimeout(() => {
                         indicator.classList.add('text-red-500', 'border-red-500/30', 'bg-red-500/20');
                         indicator.classList.remove('text-green-500', 'border-green-500/30', 'bg-green-500/20');
                    }, 500);

                })
                .subscribe();
        });
    } else {
        console.warn("Supabase Keys missing for Realtime");
    }
  </script>
</Layout>

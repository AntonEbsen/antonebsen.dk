---
import { getLangFromUrl } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);

const t = {
  da: {
    title: "Anton's AI",
    online: "Online",
    intro: "Hej! Jeg er Antons AI-assistent. Sp√∏rg mig om hans erfaring, eller bed mig om at <strong>vise en graf</strong> over hans kompetencer!",
    placeholder: "Pr√∏v f.eks: 'Vis mig en graf over dine skills'...",
    disclaimer: "Drevet af AI ¬∑ Kan lave fejl",
    error: "Beklager, jeg st√∏dte p√• en fejl.",
    configError: "Konfigurationsfejl: Mangler API-n√∏gle.",
    serverError: "Beklager, jeg kan ikke f√• forbindelse til serveren.",
    prompts: ["üìä Vis mig en graf over Antons skills", "üíº Opsummer Antons erfaring", "üöÄ Hvorfor skal jeg ans√¶tte Anton?"]
  },
  en: {
    title: "Anton's AI",
    online: "Online",
    intro: "Hi! I'm Anton's AI assistant. Ask me about his experience, or ask me to <strong>graph his skills</strong>!",
    placeholder: "Try: 'Show me a graph of your skills'...",
    disclaimer: "Powered by AI ¬∑ May produce inaccuracies",
    error: "Sorry, I encountered an error.",
    configError: "Configuration Error: Missing API Key.",
    serverError: "Sorry, I'm having trouble reaching the server.",
    prompts: ["üìä Graph Anton's skills", "üíº Summarize Anton's experience", "üöÄ Why should I hire Anton?"]
  }
}[lang];
---

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script is:inline>
    // Initialize PDF.js worker if not already done
    if (window.pdfjsLib && !window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
</script>

<div id="chat-widget" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 z-50 flex flex-col items-end pointer-events-none" data-lang={lang}>
  
  <!-- Chat Window -->
  <div id="chat-window" class="w-[calc(100vw-2rem)] md:w-[350px] h-[500px] max-h-[75vh] mb-4 bg-glass border border-glass-border rounded-xl shadow-2xl flex flex-col transform translate-y-10 opacity-0 pointer-events-auto transition-all duration-300 origin-bottom-right hidden">
    
    <!-- Header -->
    <div class="p-4 border-b border-glass-border flex justify-between items-center bg-accent/5 rounded-t-xl">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-accent text-bg flex items-center justify-center">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div>
          <h3 class="font-bold text-sm">{t.title}</h3>
          <p class="text-[10px] text-accent flex items-center gap-1">
            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> {t.online}
          </p>
        </div>
      </div>
      <div class="flex gap-2">
        <a href="/chat" class="text-dim hover:text-accent transition-colors p-1" title={lang==='da' ? "√Öbn stor chat" : "Open full chat"}>
          <i class="fa-solid fa-expand"></i>
        </a>
        <a href="/ai-project" class="text-dim hover:text-accent transition-colors p-1" title={lang==='da' ? "Om denne AI" : "About this AI"}>
          <i class="fa-solid fa-circle-info"></i>
        </a>
        <button id="close-chat" class="text-dim hover:text-white transition-colors p-1">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 scrollbar-hide text-sm">
      <div class="flex gap-2">
        <div class="w-6 h-6 rounded-full bg-accent/20 flex-shrink-0 flex items-center justify-center text-[10px] text-accent mt-1">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div class="bg-glass-border/50 p-3 rounded-lg rounded-tl-none max-w-[85%] border border-accent">
          <p>{t.intro}</p>
        </div>
      </div>
      
      <!-- Quick Prompts -->
      <div class="grid grid-cols-1 gap-2 pl-12">
         {t.prompts.map(p => (
           <button class="text-left text-xs bg-white/5 border border-white/10 hover:bg-white/10 hover:border-accent/50 transition-colors rounded-lg p-2 text-dim hover:text-white quick-prompt-btn">
             {p}
           </button>
         ))}
      </div>
      
      <!-- Messages will appear here -->
    </div>

    <!-- Input -->
    <div class="p-3 border-t border-glass-border bg-glass/50 rounded-b-xl">
      <form id="chat-form" class="flex gap-2">
        <input 
          type="text" 
          id="chat-input"
          placeholder={t.placeholder}
          class="flex-1 bg-bg/50 border border-glass-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent/50 transition-colors placeholder:text-dim/50"
          autocomplete="off"
        />
        <input type="file" id="chat-file" hidden accept=".pdf,.txt,.md,.csv" />
        <button type="button" id="file-btn" class="bg-glass/20 text-dim hover:text-white hover:bg-glass/40 w-9 h-9 rounded-lg flex items-center justify-center transition-all group" title="Upload Document">
            <i class="fa-solid fa-paperclip text-xs group-hover:scale-110 transition-transform"></i>
        </button>
        <button type="button" id="voice-btn" class="bg-glass/20 text-dim hover:text-white hover:bg-glass/40 w-9 h-9 rounded-lg flex items-center justify-center transition-all group relative" title="Speak to Anton (Voice Mode)">
           <i class="fa-solid fa-microphone text-xs group-hover:scale-110 transition-transform"></i>
           <span class="absolute inset-0 rounded-lg border border-red-500 opacity-0 transition-opacity" id="voice-indicator"></span>
        </button>
        <button type="submit" class="bg-accent text-bg w-9 h-9 rounded-lg flex items-center justify-center hover:bg-white transition-colors">
          <i class="fa-solid fa-paper-plane text-xs"></i>
        </button>
      </form>
      <div id="file-display" class="hidden mt-2 px-2 py-1 bg-accent/10 border border-accent/20 rounded flex items-center justify-between text-[10px] text-accent">
          <span class="truncate flex-1 font-mono"><i class="fa-solid fa-file-pdf mr-1"></i><span id="filename"></span></span>
          <button type="button" id="remove-file" class="ml-2 hover:text-white"><i class="fa-solid fa-times"></i></button>
      </div>
      <div class="text-[10px] text-center text-dim/30 mt-2">
        {t.disclaimer}
      </div>
    </div>
  </div>

  <!-- Toggle Button -->
  <button id="chat-toggle" class="pointer-events-auto w-14 h-14 bg-accent text-bg rounded-full shadow-lg shadow-accent/20 flex items-center justify-center hover:bg-white hover:scale-110 transition-all duration-300 group">
    <i class="fa-solid fa-message text-xl group-hover:scale-110 transition-transform"></i>
  </button>

</div>

<script>
  try {
      // Elements
      const widget = document.getElementById('chat-widget');
      const chatWindow = document.getElementById('chat-window'); // Renamed from window to chatWindow
      const toggle = document.getElementById('chat-toggle');
      const close = document.getElementById('close-chat');
      const form = document.getElementById('chat-form');
      const input = document.getElementById('chat-input');
      const messages = document.getElementById('chat-messages');
      const voiceBtn = document.getElementById('voice-btn');
      const voiceIndicator = document.getElementById('voice-indicator');

      // Concierge Logic
      const currentLang = widget?.getAttribute('data-lang') || 'da';
      const currentPath = window.location.pathname; // Global window
      
      const conciergeMessages = {
          '/cv': {
              da: "Har du sp√∏rgsm√•l til min erfaring eller specifikke roller?",
              en: "Do you have questions about my experience or specific roles?"
          },
          '/portfolio': {
              da: "Jeg kan forklare teknologistakken bag disse projekter. Sp√∏rg l√∏s!",
              en: "I can explain the tech stack behind these projects. Ask away!"
          },
          '/blog': {
              da: "L√¶ser du mine tanker? Jeg kan opsummere ethvert blogindl√¶g for dig.",
              en: "Reading my thoughts? I can summarize any post for you."
          },
          '/ai-project': {
              da: "Nysgerrig p√• hvordan jeg arbejder? Sp√∏rg mig om min RAG-arkitektur!",
              en: "Curious about how I work? Ask me about my RAG architecture!"
          }
      };

      try {
          const matchedPath = Object.keys(conciergeMessages).find(path => currentPath.startsWith(path));
          
          if (matchedPath) {
             const msg = conciergeMessages[matchedPath][currentLang];
             const introText = document.querySelector('#chat-messages p');
             if (introText) {
                 introText.textContent = msg;
                 introText.parentElement.classList.add('border-accent', 'border');
             }
          }
      } catch(err) {
          console.error("Concierge Error:", err);
      }

      // UI Logic
      let isOpen = false;

      function toggleChat() {
        if (!chatWindow || !toggle) return;
        
        isOpen = !isOpen;
        if (isOpen) {
          chatWindow.classList.remove('hidden');
          setTimeout(() => {
            chatWindow.classList.remove('translate-y-10', 'opacity-0');
            toggle.classList.add('scale-0', 'opacity-0');
            toggle.style.display = 'none'; 
          }, 10);
          input?.focus();
        } else {
          chatWindow.classList.add('translate-y-10', 'opacity-0');
          toggle.style.display = 'flex';
          setTimeout(() => {
             toggle.classList.remove('scale-0', 'opacity-0');
          }, 10);
          setTimeout(() => {
            chatWindow.classList.add('hidden');
          }, 300);
        }
      }

      if (toggle) toggle.addEventListener('click', toggleChat);
      if (close) close.addEventListener('click', toggleChat);

      // File Upload Logic
      const fileInput = document.getElementById('chat-file');
      const fileBtn = document.getElementById('file-btn');
      const fileDisplay = document.getElementById('file-display');
      const fileNameSpan = document.getElementById('filename');
      const removeFileBtn = document.getElementById('remove-file');
      let currentFileContent = null;

      fileBtn?.addEventListener('click', () => fileInput?.click());

      fileInput?.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          if(fileDisplay && fileNameSpan) {
              fileDisplay.classList.remove('hidden');
              fileNameSpan.textContent = "Processing..." + file.name;
          }

          try {
              let text = "";
              if (file.type === 'application/pdf') {
                  if(!window.pdfjsLib) throw new Error("PDF.js not loaded");
                  const arrayBuffer = await file.arrayBuffer();
                  const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                  for (let i = 1; i <= pdf.numPages; i++) {
                      const page = await pdf.getPage(i);
                      const content = await page.getTextContent();
                      text += content.items.map(item => item.str).join(' ') + "\n";
                  }
              } else {
                  text = await file.text();
              }

              currentFileContent = `\n\n<<<FILE_CONTENT Start: ${file.name}>>>\n${text}\n<<<FILE_CONTENT End>>>\n`;
              if(fileNameSpan) fileNameSpan.textContent = file.name + " (Ready)";
              
          } catch (err) {
              console.error("File read error:", err);
              if(fileNameSpan) fileNameSpan.textContent = "Error reading file";
              currentFileContent = null;
          }
      });

      removeFileBtn?.addEventListener('click', () => {
          currentFileContent = null;
          if (fileInput) fileInput.value = '';
          fileDisplay?.classList.add('hidden');
      });

      // Voice Interaction Logic
      let recognition;
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.lang = currentLang === 'da' ? 'da-DK' : 'en-US';
          recognition.interimResults = false;

          recognition.onstart = () => {
              if(voiceIndicator) {
                  voiceIndicator.classList.remove('opacity-0');
                  voiceIndicator.classList.add('animate-pulse', 'border-red-500');
              }
              voiceBtn?.classList.add('text-red-400');
          };

          recognition.onend = () => {
              if(voiceIndicator) {
                  voiceIndicator.classList.add('opacity-0');
                  voiceIndicator.classList.remove('animate-pulse', 'border-red-500');
              }
              voiceBtn?.classList.remove('text-red-400');
          };

          recognition.onerror = (event) => {
              console.error("üé§ FP Voice error:", event.error);
              if(voiceIndicator) voiceIndicator.classList.add('opacity-0');
              voiceBtn?.classList.remove('text-red-400');
              if (event.error === 'not-allowed') {
                  alert("Microphone access denied.");
              }
          };

          recognition.onresult = (event) => {
              const transcript = event.results[0][0].transcript;
              if (input) {
                  input.value = transcript;
                  input.focus();
              }
          };

          voiceBtn?.addEventListener('click', () => {
              try {
                  recognition.start();
              } catch (e) {
                  console.log("Recognition already started or error:", e);
                  recognition.stop();
              }
          });
      } else {
          if(voiceBtn) voiceBtn.style.display = 'none';
      }

      // Quick Prompts Logic
      document.querySelectorAll('.quick-prompt-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const text = e.currentTarget.textContent?.trim();
            if(text && input && form) {
                input.value = text;
                form.dispatchEvent(new Event('submit'));
                e.currentTarget.parentElement?.remove();
            }
        });
      });

      // Submit Logic
      if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = input?.value.trim() || "";
            if (!query && !currentFileContent) return;

            addMessage(query || (currentFileContent ? `[Attached: ${fileInput?.files?.[0]?.name}]` : "Empty message"), 'user');
            
            const fullPayload = query + (currentFileContent || "");
            
            if (input) input.value = '';
            
            if(currentFileContent) {
                removeFileBtn?.click();
            }

            showTyping();

            try {
              const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: fullPayload, lang: currentLang })
              });
              
              removeTyping();

              if (!res.ok) {
                 const text = await res.text();
                 let errorMsg = `Server Error (${res.status})`;
                 if (text) {
                     try {
                         const data = JSON.parse(text);
                         errorMsg = data.message || errorMsg;
                     } catch (e) {
                         // Valid text but not JSON (e.g. HTML error page)
                         errorMsg += `: ${text.substring(0, 100)}...`;
                     }
                 } else {
                     errorMsg += ": Empty Response";
                 }
                 
                 addMessage("‚ö†Ô∏è " + errorMsg, 'ai');
                 return;
              }

              const messageContent = addMessage("", 'ai');
              const reader = res.body?.getReader();
              const decoder = new TextDecoder();
              let accumulatedText = "";

              if (reader) {
                  while (true) {
                      const { done, value } = await reader.read();
                      if (done) break;
                      
                      const chunk = decoder.decode(value, { stream: true });
                      accumulatedText += chunk;
                      
                      if (messageContent) {
                          messageContent.innerHTML = formatText(accumulatedText);
                      }
                      const msgs = document.getElementById('chat-messages');
                      if(msgs) msgs.scrollTop = msgs.scrollHeight;
                  }
              }

              if (messageContent) {
                   const wrapper = messageContent.closest('.ai-content-wrapper');
                   processSpecialTags(accumulatedText, wrapper); 
              }

            } catch (err) {
              removeTyping();
              console.error(err);
              addMessage(`‚ö†Ô∏è Connection error: ${err.message || 'Unknown'}`, 'ai');
            }
          });
      }

      // Helpers
      function formatText(text) {
          // Simple link formatting
          return text.replace(/<<<CHART[\s\S]*?CHART>>>/g, '')
                     .replace(/<<<NAVIGATE:.*?>>>/gi, '')
                     .replace(/<<<SUGGESTIONS:.*?>>>/g, '')
                     .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                     .replace(/\n/g, '<br/>');
      }

      function processSpecialTags(text, containerDiv) {
         if (!containerDiv) return;

         // Chart
         const chartMatch = text.match(/<<<CHART([\s\S]*?)CHART>>>/);
         if (chartMatch) {
             const jsonStr = chartMatch[1];
             try {
                 const chartData = JSON.parse(jsonStr);
                 const canvasId = 'chart-' + Date.now();
                 const canvasContainer = document.createElement('div');
                 canvasContainer.className = "mt-4 p-4 bg-[rgba(255,255,255,0.05)] rounded-xl border border-[rgba(255,255,255,0.1)]";
                 canvasContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                 
                 const textDiv = containerDiv.querySelector('.message-bubble') || containerDiv;
                 textDiv.appendChild(canvasContainer);
                 const msgs = document.getElementById('chat-messages');
                 if(msgs) msgs.scrollTop = msgs.scrollHeight;

                 import('chart.js/auto').then(({ default: Chart }) => {
                     const ctx = document.getElementById(canvasId);
                     if (ctx) {
                         new Chart(ctx, {
                             type: chartData.type,
                             data: chartData.data,
                             options: {
                                 ...chartData.options,
                                 color: 'rgba(255, 255, 255, 0.8)',
                                 borderColor: 'rgba(255, 255, 255, 0.2)',
                                 scale: {
                                    ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                                 },
                                 plugins: {
                                    legend: { labels: { color: 'rgba(255, 255, 255, 0.9)' } }
                                 }
                             }
                         });
                     }
                 });

             } catch (e) {
                 console.error("Chart Render Error", e);
             }
         }
         // Navigation
         const navMatch = text.match(/<<<NAVIGATE:\s*(.*?)\s*>>>/i);
         if (navMatch) {
             const rawPath = navMatch[1].trim();
             const path = rawPath.replace(/\.$/, '');
             const navDiv = document.createElement('div');
             navDiv.className = "flex items-center gap-2 text-sm text-accent mt-3 font-bold animate-pulse";
             navDiv.innerHTML = `<i class="fa-solid fa-arrow-right-long"></i> Navigating to ${path}...`;
             const bubble = containerDiv.querySelector('.message-bubble');
             if (bubble) bubble.appendChild(navDiv); 
             else containerDiv.appendChild(navDiv);
             const msgs = document.getElementById('chat-messages');
             if(msgs) msgs.scrollTop = msgs.scrollHeight;

             setTimeout(() => {
                 window.location.href = path;
             }, 500);
         }

         // Suggestions
         const suggestMatch = text.match(/<<<SUGGESTIONS:(.*?)>>>/);
         if (suggestMatch) {
              const jsonStr = suggestMatch[1];
              try {
                  const suggestions = JSON.parse(jsonStr);
                  const chipsContainer = document.createElement('div');
                  chipsContainer.className = "flex flex-wrap gap-2 mt-4 w-full";
                  
                  suggestions.forEach(s => {
                      const btn = document.createElement('button');
                      btn.className = "text-sm bg-accent/10 hover:bg-accent hover:text-bg text-accent border border-accent/20 rounded-xl px-4 py-2 transition-all duration-300 shadow-sm";
                      btn.innerText = s;
                      btn.addEventListener('click', () => {
                          if (input && form) {
                              input.value = s;
                              form.dispatchEvent(new Event('submit'));
                              chipsContainer.remove();
                          }
                      });
                      chipsContainer.appendChild(btn);
                  });
                  
                  containerDiv.appendChild(chipsContainer);
                  const msgs = document.getElementById('chat-messages');
                  if(msgs) msgs.scrollTop = msgs.scrollHeight;

              } catch (e) {
                  console.error("Suggestion Parse Error", e);
              }
         }
      }

      // Event Delegation for dynamic buttons
      const msgsContainer = document.getElementById('chat-messages');
      if (msgsContainer) {
          msgsContainer.addEventListener('click', (e) => {
              const btn = e.target.closest('.speak-btn');
              if (btn) {
                  const text = btn.getAttribute('data-text');
                  if (text) speakMessage(text, btn);
              }
          });
      }

      function addMessage(text, role) {
        const msgs = document.getElementById('chat-messages');
        if (!msgs) return;
        const div = document.createElement('div');
        div.className = `flex gap-4 ${role === 'user' ? 'flex-row-reverse' : ''}`;

        let contentElement;

        if (role === 'ai') {
          div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-accent/20 text-accent flex items-center justify-center flex-shrink-0 mt-1 border border-accent/20">
              <i class="fa-solid fa-robot text-lg"></i>
            </div>
            <div class="flex flex-col max-w-[85%] ai-content-wrapper">
                <div class="bg-white/5 border border-white/10 p-5 rounded-sm border-l-2 border-l-accent leading-relaxed text-dim-100 message-bubble shadow-lg">
                  <p class="font-mono text-xs text-accent mb-2 uppercase tracking-wide">AI Analysis</p>
                  <div class="prose prose-invert max-w-none text-sm md:text-base font-light">
                    ${formatText(text)}
                  </div>
                </div>
            </div>
          `;
          contentElement = div.querySelector('.prose');
          if (text) contentElement.innerHTML = formatText(text);

          // Add Speak Button with Data Attribute
          const actionsDiv = document.createElement('div');
          actionsDiv.className = "flex justify-end mt-2 gap-2";
          
          // Store text in data attribute for safety
          const safeText = encodeURIComponent(text);
          
          actionsDiv.innerHTML = `
             <button class="speak-btn text-dim-400 hover:text-accent transition-all duration-300 w-8 h-8 flex items-center justify-center rounded-full hover:bg-accent/10" aria-label="L√¶s h√∏jt" data-text="${safeText}">
                <i class="fa-solid fa-volume-high text-xs"></i>
             </button>
          `;
          div.querySelector('.ai-content-wrapper').appendChild(actionsDiv);

        } else {
          div.innerHTML = `
            <div class="bg-accent text-bg p-4 md:p-5 rounded-sm rounded-tr-none max-w-[85%] text-left shadow-lg font-medium text-sm md:text-base border border-accent">
              <p>${text}</p>
            </div>
          `;
        }

        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;

        return contentElement;
      }

      let typingInterval;

      function showTyping() {
        const msgs = document.getElementById('chat-messages');
        if (!msgs) return;
        
        const div = document.createElement('div');
        div.id = 'fp-typing';
        div.className = 'flex gap-4';
        
        // Initial State
        div.innerHTML = `
           <div class="w-10 h-10 rounded-full bg-accent text-bg flex items-center justify-center flex-shrink-0 mt-1 animate-pulse">
              <i class="fa-solid fa-microchip text-lg"></i>
            </div>
            <div class="bg-[rgba(255,255,255,0.05)] border border-accent/20 p-4 rounded-2xl rounded-tl-none flex items-center">
              <span id="typing-text" class="text-xs font-mono text-accent tracking-wider">‚ö° Initializing Quantum Core...</span>
            </div>
        `;
        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;

        const states = [
            "‚ö° Initializing Quantum Core...",
            "üå™Ô∏è Reading Context & Metadata...",
            "üìö Searching Knowledge Base...",
            "üß† Analyzing Economic Models...",
            "‚ú® Generating Response..."
        ];
        
        let stateIdx = 0;
        const textSpan = div.querySelector('#typing-text');
        
        if (textSpan) {
            typingInterval = setInterval(() => {
                stateIdx = (stateIdx + 1) % states.length;
                textSpan.textContent = states[stateIdx];
            }, 800);
        }
      }

      function removeTyping() {
        if (typingInterval) clearInterval(typingInterval);
        const el = document.getElementById('fp-typing');
        if (el) el.remove();
      }

      let activeUtterance = null;

      function speakMessage(encodedText, btn) {
          if (!window.speechSynthesis) {
              addMessage("‚ö†Ô∏è TTS not supported by this browser.", 'system');
              return;
          }

          let text = "";
          try {
              text = decodeURIComponent(encodedText);
          } catch(e) {
              text = encodedText; // Fallback
          }

          // Debug: Show we are trying
          // console.log("üîä TTS Start"); 

          window.speechSynthesis.cancel();

          // Reset UI
          document.querySelectorAll('.speak-btn i').forEach(icon => {
              icon.classList.remove('text-accent', 'animate-pulse');
              icon.classList.add('text-dim-400');
          });
          const icon = btn.querySelector('i');
          icon.classList.remove('text-dim-400');
          icon.classList.add('text-accent', 'animate-pulse');

          const cleanText = text.replace(/[*#`]/g, '');
          const utterance = new SpeechSynthesisUtterance(cleanText);
          activeUtterance = utterance;

          const voices = window.speechSynthesis.getVoices();
          // Visual Debug
          if (voices.length === 0) {
               // Verify looking for voices
               window.speechSynthesis.onvoiceschanged = () => speakMessage(text, btn);
               return; 
          }

          const lang = document.documentElement.lang || 'da';
          utterance.lang = lang === 'en' ? 'en-US' : 'da-DK';
          
          // STRICT SIMPLICITY: Only set voice if we are 100% sure. 
          // Otherwise trust the browser's default for that language.
          const voice = voices.find(v => v.lang === (lang === 'en' ? 'en-US' : 'da-DK'));
          if (voice) {
              utterance.voice = voice;
          }

          utterance.onend = () => {
              icon.classList.remove('text-accent', 'animate-pulse');
              icon.classList.add('text-dim-400');
              activeUtterance = null;
          };
          
          utterance.onerror = (e) => {
              addMessage("‚ö†Ô∏è TTS Error: " + e.error, 'system');
              icon.classList.remove('text-accent', 'animate-pulse');
              icon.classList.add('text-dim-400');
              activeUtterance = null;
          };

          window.speechSynthesis.speak(utterance);
      }

  } catch (err) {
      console.error("Chat Widget Script Error:", err);
  }
</script>

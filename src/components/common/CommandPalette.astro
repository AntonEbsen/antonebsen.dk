---
import { getLangFromUrl } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = {
  da: {
    placeholder: "Søg eller spørg AI (Cmd+K)...",
    noResults: "Ingen resultater for",
    quickActions: "Hurtige handlinger",
    results: "Resultater",
    aiMode: "Spørg Quantum AI",
    aiSearching: "AI tænker...",
    keyboardHint: "Pil for at navigere, Enter for at vælge, Esc for at lukke"
  },
  en: {
    placeholder: "Search or ask AI (Cmd+K)...",
    noResults: "No results for",
    quickActions: "Quick Actions",
    results: "Results",
    aiMode: "Ask Quantum AI",
    aiSearching: "AI reflects...",
    keyboardHint: "Arrows to navigate, Enter to select, Esc to close"
  }
}[lang];

const quickActions = [
  { label: lang === 'da' ? "Se mit CV" : "View my CV", url: "/cv", icon: "fa-solid fa-file-pdf" },
  { label: lang === 'da' ? "Projekter" : "Projects", url: "/portfolio", icon: "fa-solid fa-briefcase" },
  { label: lang === 'da' ? "Kontakt mig" : "Contact me", url: "/contact", icon: "fa-solid fa-envelope" },
  { label: lang === 'da' ? "Gæstebog" : "Guestbook", url: "/guestbook", icon: "fa-solid fa-pen-nib" }
];
---

<div id="command-palette" class="fixed inset-0 z-[1001] flex items-start justify-center pt-[15vh] px-4 pointer-events-none opacity-0 invisible transition-all duration-200" role="dialog" aria-modal="true" aria-labelledby="palette-input">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-[#000]/60 backdrop-blur-md palette-backdrop cursor-pointer pointer-events-auto"></div>

  <!-- Palette Container -->
  <div class="relative w-full max-w-[650px] bg-[#0a0a0c]/90 border border-glass-border rounded-2xl shadow-[0_20px_70px_rgba(0,0,0,0.7)] overflow-hidden transform scale-95 transition-all duration-200 pointer-events-auto flex flex-col max-h-[70vh]">
    <!-- Header/Search Input -->
    <div class="relative flex items-center p-4 border-b border-glass-border">
      <i class="fa-solid fa-magnifying-glass text-accent mr-3 opacity-60"></i>
      <input 
        id="palette-input"
        type="text" 
        class="w-full bg-transparent border-none outline-none text-lg text-white font-medium placeholder:text-white/30"
        placeholder={t.placeholder}
        autocomplete="off"
      />
      <div class="flex items-center gap-2">
        <button id="palette-ai-toggle" class="px-3 py-1.5 rounded-lg bg-accent/10 border border-accent/20 text-[10px] font-bold uppercase tracking-widest text-accent hover:bg-accent/20 transition-all flex items-center gap-2" title={t.aiMode}>
          <i class="fa-solid fa-robot"></i>
          <span class="hidden md:inline">Quantum AI</span>
        </button>
        <span class="text-[10px] bg-white/5 border border-white/10 px-2 py-1 rounded text-white/50 font-mono hidden md:inline">ESC</span>
      </div>
    </div>

    <!-- Scrolling Content -->
    <div id="palette-results" class="flex-1 overflow-y-auto p-2 scrollbar-hide min-h-[100px]">
       <!-- State: Quick Actions (Default) -->
       <div id="palette-default-state">
          <h3 class="px-4 py-2 text-[10px] font-bold uppercase tracking-widest text-white/30 mb-1">{t.quickActions}</h3>
          <div class="grid grid-cols-2 gap-1 mb-4">
            {quickActions.map(action => (
              <a href={action.url} class="palette-item flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 group transition-all">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-accent group-hover:bg-accent group-hover:text-bg transition-all">
                  <i class={action.icon}></i>
                </div>
                <span class="text-sm font-medium text-dim group-hover:text-white transition-colors">{action.label}</span>
              </a>
            ))}
          </div>
       </div>

       <!-- State: Results (Injected via JS) -->
       <div id="palette-results-list" class="hidden flex flex-col gap-0.5"></div>

       <!-- State: AI (Injected via JS) -->
       <div id="palette-ai-result" class="hidden p-4 space-y-4">
          <div class="flex items-center gap-3 text-accent animate-pulse text-sm font-mono">
             <i class="fa-solid fa-microchip"></i>
             <span>{t.aiSearching}</span>
          </div>
       </div>
    </div>

    <!-- Footer -->
    <div class="p-4 bg-white/[0.02] border-t border-glass-border flex justify-between items-center">
       <p class="text-[10px] text-white/30 font-medium">
         <i class="fa-solid fa-keyboard mr-1"></i> {t.keyboardHint}
       </p>
       <div class="flex items-center gap-3">
         <span class="flex items-center gap-1.5 text-[10px] text-white/40">
           <kbd class="px-1.5 py-0.5 rounded bg-white/5 border border-white/10 font-mono">↑↓</kbd> Naviger
         </span>
         <span class="flex items-center gap-1.5 text-[10px] text-white/40">
            <kbd class="px-1.5 py-0.5 rounded bg-white/5 border border-white/10 font-mono">↵</kbd> Vælg
          </span>
       </div>
    </div>
  </div>
</div>

<style>
  #command-palette.is-open {
    opacity: 1;
    visibility: visible;
  }
  #command-palette.is-open > div:last-child {
    transform: scale(1);
  }

  .palette-item.is-active {
    background-color: rgba(255, 255, 255, 0.08);
  }
  .palette-item.is-active .w-8 {
    background-color: var(--accent);
    color: #000;
  }
  .palette-item.is-active span {
    color: #fff;
  }
</style>

<script lang="ts">
  import { track } from '@vercel/analytics';
  // @ts-nocheck
  (() => {
    const palette = document.getElementById('command-palette');
    const container = palette?.querySelector('.relative.w-full');
    const backdrop = palette?.querySelector('.palette-backdrop');
    const input = document.getElementById('palette-input');
    const resultsList = document.getElementById('palette-results-list');
    const defaultState = document.getElementById('palette-default-state');
    const aiResult = document.getElementById('palette-ai-result');
    const aiToggle = document.getElementById('palette-ai-toggle');

    if (!palette || !input) return;

    let isOpen = false;
    let isAiMode = false;
    let searchIndex = [];
    let activeIndex = -1;

    let lastFocused: HTMLElement | null = null;
    let focusableElements: NodeListOf<HTMLElement>;

    // Toggle Palette
    function openPalette() {
      isOpen = true;
      track('Palette_Open');
      lastFocused = document.activeElement as HTMLElement;
      palette.classList.add('is-open');
      document.body.style.overflow = 'hidden';
      palette.setAttribute('aria-hidden', 'false');
      
      setTimeout(() => {
         input.focus();
         updateFocusable();
      }, 10);

      if (searchIndex.length === 0) loadIndex();
    }

    function closePalette() {
      isOpen = false;
      palette.classList.remove('is-open');
      document.body.style.overflow = '';
      palette.setAttribute('aria-hidden', 'true');
      input.value = '';
      resetState();
      
      if (lastFocused) {
        lastFocused.focus();
        lastFocused = null;
      }
    }

    function resetState() {
      defaultState?.classList.remove('hidden');
      resultsList?.classList.add('hidden');
      aiResult?.classList.add('hidden');
      if (resultsList) resultsList.innerHTML = '';
      activeIndex = -1;
      isAiMode = false;
      aiToggle?.classList.remove('bg-accent', 'text-bg');
      aiToggle?.classList.add('bg-accent/10', 'text-accent');
    }

    // Load Index
    async function loadIndex() {
      try {
        const res = await fetch('/search-index.json');
        searchIndex = await res.json();
      } catch (e) {
        console.error("Failed to load search index", e);
      }
    }

    // Search Logic
    function handleSearch() {
      const q = input.value.trim().toLowerCase();
      
      if (q.length < 2) {
        resetState();
        return;
      }

      if (isAiMode) return; // Handled by Enter

      const filtered = searchIndex
        .filter(item => {
          const content = `${item.title} ${item.content} ${item.tags?.join(' ')}`.toLowerCase();
          return content.includes(q);
        })
        .slice(0, 10);

      renderResults(filtered);
    }

    function renderResults(results: any[]) {
      if (!resultsList || !defaultState) return;

      defaultState.classList.add('hidden');
      resultsList.classList.remove('hidden');
      aiResult?.classList.add('hidden');

      if (results.length === 0) {
        resultsList.innerHTML = `<div class="p-8 text-center text-dim text-sm opacity-50">Ingen resultater...</div>`;
        return;
      }

      resultsList.innerHTML = results.map((r, i) => `
        <a href="${r.url}" class="palette-item flex items-center justify-between p-3 rounded-xl transition-all ${i === 0 ? 'is-active' : ''}" data-index="${i}">
          <div class="flex items-center gap-3">
             <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-accent/60">
                <i class="${getIcon(r.tags)}"></i>
             </div>
             <div>
                <div class="text-sm font-medium">${r.title}</div>
                <div class="text-[11px] text-white/30 truncate max-w-[300px]">${r.content}</div>
             </div>
          </div>
          <div class="flex gap-1">
             ${r.tags?.slice(0,2).map(t => `<span class="text-[9px] px-1.5 py-0.5 rounded bg-white/5 border border-white/10 text-white/40 uppercase tracking-tighter">${t}</span>`).join('')}
          </div>
        </a>
      `).join('');

      activeIndex = 0;
    }

    function getIcon(tags: string[]) {
      if (tags?.includes('blog')) return 'fa-solid fa-newspaper';
      if (tags?.includes('portfolio')) return 'fa-solid fa-code';
      if (tags?.includes('skill')) return 'fa-solid fa-brain';
      return 'fa-solid fa-link';
    }

    function updateFocusable() {
       focusableElements = palette.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    }

    function updateFocusable() {
       focusableElements = palette.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    }

    // Keyboard Navigation
    function handleKeydown(e: KeyboardEvent) {
      if (!isOpen) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          openPalette();
        }
        return;
      }

      if (e.key === 'Escape') closePalette();

      const items = palette.querySelectorAll('.palette-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1) % items.length;
        updateActiveItem(items);
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        updateActiveItem(items);
      }

      if (e.key === 'Enter') {
        e.preventDefault();
        if (isAiMode) {
          askAi();
        } else {
          const activeItem = items[activeIndex];
          if (activeItem) activeItem.click();
        }
      }
    }

    function updateActiveItem(items) {
      items.forEach((item: any, i: number) => {
        if (i === activeIndex) {
          item.classList.add('is-active');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('is-active');
        }
      });
    }

    // AI Mode
    function toggleAi() {
      isAiMode = !isAiMode;
      if (isAiMode) {
        aiToggle?.classList.add('bg-accent', 'text-bg');
        aiToggle?.classList.remove('bg-accent/10', 'text-accent');
        input.placeholder = "Spørg Quantum AI om Anton...";
      } else {
        aiToggle?.classList.remove('bg-accent', 'text-bg');
        aiToggle?.classList.add('bg-accent/10', 'text-accent');
        input.placeholder = "Søg eller spørg AI (Cmd+K)...";
      }
    }

    async function askAi() {
      const q = input.value.trim();
      if (!q || !aiResult || !resultsList || !defaultState) return;

      defaultState.classList.add('hidden');
      resultsList.classList.add('hidden');
      aiResult.classList.remove('hidden');

      aiResult.innerHTML = `
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-3 text-accent animate-pulse text-sm font-mono">
             <i class="fa-solid fa-microchip"></i>
             <span>Quantum AI overvejer spørgsmålet...</span>
          </div>
          <div id="palette-ai-text" class="p-4 bg-accent/5 border-l-2 border-accent text-dim-100 text-sm leading-relaxed rounded-r-lg min-h-[60px]"></div>
        </div>
      `;

      const textContainer = document.getElementById('palette-ai-text');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: q, lang: document.documentElement.lang })
        });

        if (!res.ok) throw new Error("AI Fetch failed");

        const reader = res.body?.getReader();
        const decoder = new TextDecoder();
        let accumulatedText = "";

        if (reader) {
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value, { stream: true });
            accumulatedText += chunk;
            
            if (textContainer) {
              // Basic formatting
              textContainer.innerHTML = accumulatedText
                .replace(/\n/g, '<br>')
                .replace(/<<<.*?>>>/g, ''); // Remove special tags
            }
          }
        }

        if (textContainer) {
           const footer = document.createElement('div');
           footer.className = "text-[10px] text-white/20 italic mt-2";
           footer.innerText = "Svaret er genereret af AI baseret på Antons CV og projekter.";
           textContainer.appendChild(footer);
        }

      } catch (e) {
        if (textContainer) textContainer.innerHTML = `<div class="text-red-400">Beklager, AI-tjenesten er midlertidigt utilgængelig.</div>`;
      }
    }

    // Listeners
    window.addEventListener('keydown', handleKeydown);
    backdrop?.addEventListener('click', closePalette);
    input.addEventListener('input', handleSearch);
    aiToggle?.addEventListener('click', toggleAi);

  })();
</script>


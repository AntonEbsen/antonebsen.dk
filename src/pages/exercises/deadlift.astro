---
import Layout from '@layouts/Layout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import Button from '@components/ui/Button.astro';

const techInfo = {
  title: "Deadlift",
  muscles: ["Bagl친r (Hamstrings)", "Baller (Gluteus Maximus)", "Erector Spinae (L칝nd)", "Traps", "Grebstyrke"],
  benefits: [
    "Kongen af alle 칮velser for at bygge r친 styrke og masse i bagk칝den.",
    "Forbedrer din core-stabilitet og holdning markant.",
    "B칝rer direkte over til dagligdags bev칝gelser og sportslig form친en."
  ],
  setup: [
    "St친 med f칮dderne i hoftebredde, s친 stangen er midt over din fod.",
    "B칮j dig ned og grib stangen lige uden for dine ben.",
    "Skub dine skinner frem til stangen og l칮ft brystet, s친 ryggen er flad."
  ],
  execution: [
    "Tag en dyb ind친nding og skab sp칝nding i din core (valsalva man칮vre).",
    "Pres gennem gulvet og rejs dig op ved at skubbe hoften frem.",
    "Hold stangen t칝t mod kroppen hele vejen op.",
    "S칝nk kontrollleret tilbage ved at f칮re hoften bagud."
  ]
};
---

<Layout title="Deadlift: Teknik & Stats">
  <main class="container mx-auto px-4 py-12">
    <Section class="max-w-5xl mx-auto">
      <div class="mb-12 text-center reveal reveal-fade">
        <SectionHeading>칒velses-Fokus</SectionHeading>
        <h1 class="text-4xl md:text-6xl font-black mb-6 uppercase italic tracking-tighter">Deadlift</h1>
        <div class="flex flex-wrap justify-center gap-3">
          {techInfo.muscles.map(m => (
            <span class="px-3 py-1 rounded-full border border-accent/20 bg-accent/5 text-[10px] font-bold uppercase tracking-widest text-accent">{m}</span>
          ))}
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
          <Card variant="glass" class="p-6 reveal reveal-slide-right">
            <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-6 border-b border-white/5 pb-2">Personlige Rekorder</h3>
            <div class="space-y-6">
              <div><p class="text-[10px] text-white/30 uppercase font-bold mb-1">Max Weight</p><div id="stat-pb-weight" class="text-3xl font-black text-white italic">-- kg</div></div>
              <div><p class="text-[10px] text-white/30 uppercase font-bold mb-1">Estimeret 1RM</p><div id="stat-e1rm" class="text-3xl font-black text-accent italic">-- kg</div></div>
              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/5">
                <div><p class="text-[10px] text-white/30 uppercase font-bold">Total Tons</p><p id="stat-total-tons" class="font-bold text-sm">--</p></div>
                <div><p class="text-[10px] text-white/30 uppercase font-bold">Gns. RPE</p><p id="stat-avg-rpe" class="font-bold text-sm">--</p></div>
              </div>
            </div>
          </Card>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-75">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-6 border-b border-white/5 pb-2">Styrke-niveau</h3>
            <div class="text-center py-4">
                <div id="strength-badge" class="inline-block px-4 py-2 rounded-full border border-white/10 bg-white/5 text-sm font-black uppercase tracking-widest mb-4 italic">Calculating...</div>
                <p id="strength-next" class="text-[10px] text-white/30 uppercase font-bold">N칝ste m친l: -- kg</p>
            </div>
            <div class="space-y-2 mt-4">
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Novice</span><span class="text-white/40">1.2x BW</span></div>
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Intermediate</span><span class="text-white/40">1.8x BW</span></div>
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Advanced</span><span class="text-white/40">2.4x BW</span></div>
                <div class="flex justify-between text-[10px] uppercase font-bold tracking-tighter"><span class="text-white/20">Elite</span><span class="text-white/40">3.0x BW</span></div>
            </div>
          </Card>
          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-100">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-robot text-accent"></i> AI Progression Guide
            </h3>
            <div id="ai-suggestion" class="p-4 bg-accent/5 border border-accent/10 rounded-xl mb-4">
                <p class="text-[13px] text-dim italic">Analyserer dine seneste l칮ft...</p>
            </div>
            <p class="text-[10px] text-white/20 leading-relaxed uppercase font-bold">Progressiv overload sikrer kontinuerlig fremgang.</p>
          </Card>
          
          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-150">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-4">Hvorfor d칮dl칮ft?</h3>
            <ul class="space-y-4">
              {techInfo.benefits.map(b => (
                <li class="flex gap-3 text-[13px] leading-relaxed text-dim"><i class="fa-solid fa-circle-check text-accent mt-1 shrink-0"></i><span>{b}</span></li>
              ))}
            </ul>
          </Card>
        </div>

        <div class="lg:col-span-2 space-y-8">
          <Card variant="glass" class="p-6 reveal reveal-slide-up">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-8">Styrke-udvikling (e1RM)</h3>
            <div class="min-h-[350px] w-full"><canvas id="progressionChart"></canvas></div>
          </Card>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card variant="glass" class="p-6 reveal reveal-slide-up">
               <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-4">Set-up</h3>
               <ul class="space-y-3">
                 {techInfo.setup.map((s, i) => (<li class="text-[13px] text-dim flex gap-3 leading-relaxed"><span class="font-mono text-accent/50">{i+1}.</span><span>{s}</span></li>))}
               </ul>
            </Card>
            <Card variant="glass" class="p-6 reveal reveal-slide-up delay-100">
               <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-4">Udf칮relse</h3>
               <ul class="space-y-3">
                 {techInfo.execution.map((e, i) => (<li class="text-[13px] text-dim flex gap-3 leading-relaxed"><span class="font-mono text-accent/50">{i+1}.</span><span>{e}</span></li>))}
               </ul>
            </Card>
          </div>
        </div>
      </div>
    </Section>
  </main>

  <script>
    import Chart from 'chart.js/auto';
    async function initStats() {
      try {
        const res = await fetch('/api/training');
        const allLogs = await res.json();
        const logs = allLogs.filter((l: any) => l.exercise_name?.toLowerCase().includes('deadlift')).sort((a: any, b: any) => new Date(a.date).getTime() - new Date(b.date).getTime());
        if (logs.length === 0) return;

        const maxWeight = Math.max(...logs.map((l:any)=>l.weight_kg));
        document.getElementById('stat-pb-weight')!.innerText = `${maxWeight} kg`;
        
        const e1rms = logs.map((l: any) => {
           const reps = l.reps || 5;
           return Math.round(l.weight_kg / (1.0278 - 0.0278 * reps));
        });
        const currentE1RM = Math.max(...e1rms);
        document.getElementById('stat-e1rm')!.innerText = `${currentE1RM} kg`;

        // Strength Standards (Relative to 85kg BW for Deadlift)
        const bw = 85;
        const standards = [
            { label: 'Novice', ratio: 1.2 },
            { label: 'Intermediate', ratio: 1.8 },
            { label: 'Advanced', ratio: 2.4 },
            { label: 'Elite', ratio: 3.0 }
        ];

        let tier = standards[0];
        let nextTier = standards[1];
        
        for (let i = 0; i < standards.length; i++) {
            if (currentE1RM >= standards[i].ratio * bw) {
                tier = standards[i];
                nextTier = standards[i+1] || null;
            }
        }

        const badge = document.getElementById('strength-badge')!;
        badge.innerText = tier.label;
        if (tier.label === 'Elite') badge.classList.add('text-accent', 'border-accent/40', 'bg-accent/10');
        else if (tier.label === 'Advanced') badge.classList.add('text-blue-400', 'border-blue-400/40', 'bg-blue-400/10');
        else if (tier.label === 'Intermediate') badge.classList.add('text-green-400', 'border-green-400/40', 'bg-green-400/10');

        if (nextTier) {
            document.getElementById('strength-next')!.innerText = `N칝ste m친l: ${Math.ceil(nextTier.ratio * bw)} kg (${nextTier.label})`;
        } else {
            document.getElementById('strength-next')!.innerText = `Du er i toppen! 游댠`;
        }

        // AI Progression Analysis
        const latestLog = logs[logs.length - 1];
        const aiContainer = document.getElementById('ai-suggestion')!;
        
        if (latestLog) {
            const rpe = latestLog.rpe || 8;
            const weight = latestLog.weight_kg;
            let suggestion = "";
            let reason = "";

            if (rpe <= 8) {
                suggestion = `${weight + 2.5} kg`;
                reason = `Sidst l칮ftede du ${weight} kg med RPE ${rpe}. Det ser ud til, at der er overskud, s친 jeg foresl친r en lille 칮gning p친 2.5 kg.`;
            } else if (rpe === 9) {
                suggestion = `${weight} kg`;
                reason = `Du ramte en RPE 9 sidst. Hold v칝gten her i n칝ste pas, og fokus칠r p친 at g칮re reps'ne endnu mere pr칝cise eller snappe en ekstra rep.`;
            } else {
                suggestion = `${weight} kg`;
                reason = `RPE ${rpe} er meget h칮j (t칝t p친 failure). Hold v칝gten eller overvej et lille deload, hvis formen lider under det.`;
            }

            aiContainer.innerHTML = `
                <div class="text-[10px] text-accent uppercase font-black mb-1">N칝ste Pas Forslag:</div>
                <div class="text-2xl font-black text-white italic mb-2">${suggestion}</div>
                <p class="text-[11px] text-dim leading-relaxed font-medium">${reason}</p>
            `;
        }
        
        const totalVol = logs.reduce((sum: number, l: any) => sum + (l.tonnage_kg || 0), 0);
        document.getElementById('stat-total-tons')!.innerText = `${(totalVol / 1000).toFixed(1)} t`;
        
        const rpes = logs.map((l: any) => l.rpe).filter(Boolean);
        document.getElementById('stat-avg-rpe')!.innerText = rpes.length > 0 ? (rpes.reduce((a:number, b:number) => a+b, 0) / rpes.length).toFixed(1) : '--';

        const ctx = document.getElementById('progressionChart') as HTMLCanvasElement;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: logs.map((l: any) => new Date(l.date).toLocaleDateString('da-DK', { day: 'numeric', month: 'short' })),
                datasets: [{ 
                  label: 'Estimeret 1RM (kg)', 
                  data: e1rms, 
                  borderColor: '#FFD700', 
                  backgroundColor: 'rgba(212, 175, 55, 0.1)', 
                  borderWidth: 3, 
                  pointRadius: 4, 
                  pointBackgroundColor: '#FFD700', 
                  fill: true, 
                  tension: 0.3 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'rgba(255, 255, 255, 0.3)', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: 'rgba(255, 255, 255, 0.5)', font: { size: 10 } }, grid: { color: 'rgba(255, 255, 255, 0.05)' } } } }
        });
      } catch (e) { console.error(e); }
    }
    initStats();
  </script>
</Layout>

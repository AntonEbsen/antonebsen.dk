(() => {
  const input = document.getElementById("siteSearch");
  const box = document.getElementById("searchResults");
  if (!input || !box) return;

  let index = [];
  let open = false;
  let active = -1;

  function getSearchIndexPath() {
    // Always use the dynamic absolute path generated by Astro
    return "/search-index.json";
  }

  async function loadIndex() {
    const url = getSearchIndexPath();
    try {
      const res = await fetch(url, { cache: "no-cache" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      index = await res.json();
    } catch (e) {
      console.warn("Search index failed to load:", e);
      // Fallback or retry logic if needed, but the path above should be correct.
      index = [];
    }
  }

  function normalize(s) {
    return (s || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/\p{Diacritic}/gu, "");
  }

  function scoreItem(item, tokens) {
    const hay = normalize(`${item.title} ${item.content} ${(item.tags || []).join(" ")}`);
    let score = 0;

    for (const t of tokens) {
      if (!t) continue;
      const pos = hay.indexOf(t);
      if (pos === -1) return -1;
      const titleHay = normalize(item.title);
      if (titleHay.includes(t)) score += 6;
      score += Math.max(0, 5 - Math.min(5, pos / 40));
    }
    return score;
  }

  function openBox() {
    if (open) return;
    open = true;
    box.classList.add("is-open");
    input.setAttribute("aria-expanded", "true");
  }

  function closeBox() {
    open = false;
    active = -1;
    box.classList.remove("is-open");
    input.setAttribute("aria-expanded", "false");
    box.innerHTML = "";
  }

  function setActive(idx) {
    const items = Array.from(box.querySelectorAll("a.result"));
    items.forEach((a, i) => a.setAttribute("aria-selected", i === idx ? "true" : "false"));
    active = idx;
  }

  function fixUrl(url) {
    if (url.startsWith("/")) return url;

    const path = location.pathname.replace(/\\/g, "/");
    const isPages = path.includes("/pages/");

    // URL from JSON is like "pages/cv.html" or "index.html"

    if (isPages) {
      // We are in pages/
      if (url === "index.html") {
        return "../index.html";
      }
      if (url.startsWith("pages/")) {
        return url.substring(6); // remove "pages/" -> "cv.html" (sibling)
      }
    } else {
      // We are in root (or assuming root)
      // JSON URLs "pages/cv.html" and "index.html" are already correct for root
      return url;
    }

    return url;
  }

  function renderResults(results, q) {
    if (!q || q.length < 2) {
      closeBox();
      return;
    }

    if (!results.length) {
      box.innerHTML = `<div class="no-results">Ingen resultater for “${escapeHtml(q)}”.</div>`;
      openBox();
      return;
    }

    box.innerHTML = results
      .slice(0, 8)
      .map((r, i) => {
        const snippet = (r.content || "").slice(0, 110);
        const finalUrl = fixUrl(r.url);

        return `
          <a class="result" role="option" aria-selected="${i === 0 ? "true" : "false"}" href="${finalUrl}">
            <div class="result-title">${escapeHtml(r.title)}</div>
            <p class="result-snippet">${escapeHtml(snippet)}${(r.content || "").length > 110 ? "…" : ""}</p>
          </a>
        `;
      })
      .join("");

    openBox();
    setActive(0);

    // Check Data Miner Achievement
    let searchCount = parseInt(sessionStorage.getItem('search_count') || '0');
    searchCount++;
    sessionStorage.setItem('search_count', searchCount.toString());

    if (searchCount >= 3 && window.unlockAchievement) {
      window.unlockAchievement('data_miner');
    }
  }

  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[m]));
  }

  function search(q) {
    const tokens = normalize(q).split(/\s+/).filter(Boolean);
    if (tokens.length === 0) return [];

    const currentLang = document.documentElement.lang || "da";

    const scored = index
      .filter(item => item.lang === currentLang)
      .map(item => ({ item, s: scoreItem(item, tokens) }))
      .filter(x => x.s >= 0)
      .sort((a, b) => b.s - a.s)
      .map(x => x.item);

    return scored;
  }

  // Events
  input.addEventListener("input", () => {
    const q = input.value.trim();
    const results = search(q);
    renderResults(results, q);
  });

  input.addEventListener("focus", () => {
    const q = input.value.trim();
    if (q.length >= 2) renderResults(search(q), q);
  });

  input.addEventListener("keydown", (e) => {
    const items = Array.from(box.querySelectorAll("a.result"));
    if (!open || items.length === 0) return;

    if (e.key === "Escape") {
      closeBox();
      return;
    }

    if (e.key === "ArrowDown") {
      e.preventDefault();
      const next = Math.min(items.length - 1, active + 1);
      setActive(next);
      items[next].scrollIntoView({ block: "nearest" });
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      const prev = Math.max(0, active - 1);
      setActive(prev);
      items[prev].scrollIntoView({ block: "nearest" });
    }

    if (e.key === "Enter") {
      e.preventDefault();
      if (items[active]) location.href = items[active].href;
    }
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".nav-search")) closeBox();
  });

  // Load index once
  loadIndex();
})();

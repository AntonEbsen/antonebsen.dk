---
import Layout from '@layouts/Layout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import Button from '@components/ui/Button.astro';

// Technical Content
const techInfo = {
  title: "Incline Dumbbell/Barbell Press",
  muscles: ["√òvre Bryst (Clavicular Head)", "Forside Skulder", "Triceps"],
  benefits: [
    "√òget aktivering af den √∏vre del af brystmuskulaturen.",
    "Forbedret skulderstabilitet og overhead styrke.",
    "Giver en mere balanceret og fyldig bryst-√¶stetik."
  ],
  setup: [
    "Indstil b√¶nken til en vinkel p√• 15-30 grader. For stejl vinkel flytter fokus for meget til skuldrene.",
    "Tr√¶k skulderbladene sammen og ned i b√¶nken for at skabe en stabil base.",
    "Placer f√∏dderne solidt i gulvet for 'leg drive'."
  ],
  execution: [
    "S√¶nk v√¶gten kontrolleret til det √∏verste af brystet (lige under kravebenet).",
    "Hold albuerne i en vinkel p√• ca. 45-60 grader fra kroppen ‚Äì undg√• 'flaring'.",
    "Pres v√¶gten op i en svag bue, s√• den ender over ansigtet/√∏verste bryst."
  ]
};
---

<Layout 
  title="Incline Press: Teknik & Personlig Statistik" 
  description="Dybdeg√•ende guide og personlig data-analyse af Incline Press."
>
  <main class="container mx-auto px-4 py-12">
    <Section class="max-w-5xl mx-auto">
      <!-- Header -->
      <div class="mb-12 text-center reveal reveal-fade">
        <SectionHeading>√òvelses-Fokus</SectionHeading>
        <h1 class="text-4xl md:text-6xl font-black mb-6 uppercase italic tracking-tighter">Incline Press</h1>
        <div class="flex flex-wrap justify-center gap-3">
          {techInfo.muscles.map(m => (
            <span class="px-3 py-1 rounded-full border border-accent/20 bg-accent/5 text-[10px] font-bold uppercase tracking-widest text-accent">
              {m}
            </span>
          ))}
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Sidebar: Stats Overview -->
        <div class="lg:col-span-1 space-y-6">
          <Card variant="glass" class="p-6 reveal reveal-slide-right">
            <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-6 border-b border-white/5 pb-2">Personlige Rekorder</h3>
            <div class="space-y-6">
              <div>
                <p class="text-[10px] text-white/30 uppercase font-bold mb-1">All-time Max Weight</p>
                <div id="stat-pb-weight" class="text-3xl font-black text-white italic">-- kg</div>
              </div>
              <div>
                <p class="text-[10px] text-white/30 uppercase font-bold mb-1">Estimeret 1RM</p>
                <div id="stat-e1rm" class="text-3xl font-black text-accent italic">-- kg</div>
              </div>
              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/5">
                <div>
                  <p class="text-[10px] text-white/30 uppercase font-bold">Total Volumen</p>
                  <p id="stat-total-vol" class="font-bold text-sm">-- kg</p>
                </div>
                <div>
                  <p class="text-[10px] text-white/30 uppercase font-bold">Gns. RPE</p>
                  <p id="stat-avg-rpe" class="font-bold text-sm">--</p>
                </div>
              </div>
            </div>
          </Card>

      <!-- TECHNICAL CUES / MOVEMENT FOCUS -->
      <div class="mb-10 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-accent/5 border border-accent/20 rounded-xl reveal reveal-slide-down">
            <div class="flex items-center gap-3 mb-2 text-accent">
                <i class="fa-solid fa-up-down text-xs"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">Shoulders</span>
            </div>
            <p class="text-xs font-bold text-white italic">"Retract & depress shoulder blades"</p>
        </div>
        <div class="p-4 bg-accent/5 border border-accent/20 rounded-xl reveal reveal-slide-down delay-100">
            <div class="flex items-center gap-3 mb-2 text-accent">
                <i class="fa-solid fa-angle-left text-xs"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">Elbows</span>
            </div>
            <p class="text-xs font-bold text-white italic">"Tuck elbows ~45 degrees"</p>
        </div>
        <div class="p-4 bg-accent/5 border border-accent/20 rounded-xl reveal reveal-slide-down delay-200">
            <div class="flex items-center gap-3 mb-2 text-accent">
                <i class="fa-solid fa-expand text-xs"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">Stretch</span>
            </div>
            <p class="text-xs font-bold text-white italic">"Feel the stretch in the upper pec"</p>
        </div>
      </div>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-100">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-battery-half text-accent"></i> Recovery Status
            </h3>
            <div class="flex items-center gap-4 mb-4">
                <div class="text-3xl font-black italic text-white" id="stat-recovery-percent">--%</div>
                <div class="flex-1 h-2 bg-white/5 rounded-full overflow-hidden">
                    <div id="stat-recovery-bar" class="h-full bg-accent transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
            <p id="stat-recovery-msg" class="text-[11px] text-dim leading-relaxed">Beregner din restitution...</p>
          </Card>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-150">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-robot text-accent"></i> AI Progression Guide
            </h3>
            <div id="ai-suggestion" class="p-4 bg-accent/5 border border-accent/10 rounded-xl mb-4">
                <p class="text-[13px] text-dim italic">Analyserer dine seneste l√∏ft...</p>
            </div>
            <p class="text-[10px] text-white/20 leading-relaxed uppercase font-bold">Progressiv overload sikrer kontinuerlig fremgang.</p>
          </Card>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-[350ms]">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-6 border-b border-white/5 pb-2">
                <i class="fa-solid fa-ghost text-accent mr-2"></i> The Iron Ghost
            </h3>
            <div id="ghost-container" class="space-y-4">
                <div class="flex items-center justify-between text-[10px] text-white/20 uppercase font-black">
                    <span>Din Ghost (4 uger siden)</span>
                    <span id="ghost-date">Indl√¶ser...</span>
                </div>
                <div class="p-4 bg-white/5 rounded-xl border border-dashed border-white/10">
                    <div id="ghost-stats" class="text-2xl font-black italic text-white/40 mb-1">-- kg x --</div>
                    <div class="text-[10px] text-white/20 uppercase font-bold">Session Tonnage: <span id="ghost-tonnage">--</span></div>
                </div>
                <div class="pt-2">
                    <div class="text-[10px] text-accent uppercase font-black mb-2">Dit m√•l i dag:</div>
                    <p id="ghost-directive" class="text-xs font-bold text-white leading-relaxed">Du skal sl√• din Ghost med mindst 2.5 kg eller √©n ekstra rep for at holde din progression!</p>
                </div>
            </div>
          </Card>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-200">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-clock text-accent"></i> Smart Rest-Timer
            </h3>
            <div class="text-center py-4 bg-white/5 rounded-2xl mb-4">
                <div id="timer-display" class="text-4xl font-black italic text-white mb-2">02:00</div>
                <div class="flex justify-center gap-2">
                    <button id="timer-start" class="px-4 py-1 bg-accent text-black text-[10px] font-black uppercase rounded-full hover:scale-105 transition-all">Start</button>
                    <button id="timer-reset" class="px-4 py-1 bg-white/10 text-white text-[10px] font-black uppercase rounded-full hover:bg-white/20 transition-all">Reset</button>
                </div>
            </div>
            <div class="flex justify-between items-center text-[10px] uppercase font-bold text-white/30">
                <span>Anbefalet pause</span>
                <span class="text-accent">2-3 minutter</span>
            </div>
          </Card>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-250">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-gauge-high text-accent"></i> Tempo Guide
            </h3>
            <div class="flex items-center justify-between gap-2">
                <div class="flex-1 p-2 bg-white/5 rounded-lg text-center">
                    <div class="text-lg font-black text-white italic">3</div>
                    <div class="text-[8px] text-white/30 uppercase">Ned</div>
                </div>
                <div class="flex-1 p-2 bg-white/5 rounded-lg text-center">
                    <div class="text-lg font-black text-white italic">1</div>
                    <div class="text-[8px] text-white/30 uppercase">Bund</div>
                </div>
                <div class="flex-1 p-2 bg-white/5 rounded-lg text-center">
                    <div class="text-lg font-black text-accent italic">1</div>
                    <div class="text-[8px] text-white/30 uppercase">Op</div>
                </div>
                <div class="flex-1 p-2 bg-white/5 rounded-lg text-center">
                    <div class="text-lg font-black text-white italic">1</div>
                    <div class="text-[8px] text-white/30 uppercase">Top</div>
                </div>
            </div>
            <p class="text-[10px] text-dim mt-4 leading-relaxed italic">Lille pause i toppen for at maksimere kontraktions-tiden.</p>
          </Card>

          <Card variant="glass" class="p-6 reveal reveal-slide-right delay-150">
            <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-4">Hvorfor Incline?</h3>
            <ul class="space-y-4">
              {techInfo.benefits.map(b => (
                <li class="flex gap-3 text-[13px] leading-relaxed text-dim">
                  <i class="fa-solid fa-circle-check text-accent mt-1 shrink-0"></i>
                  <span>{b}</span>
                </li>
              ))}
            </ul>
          </Card>
        </div>

        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Charts Section -->
          <Card variant="glass" class="p-6 reveal reveal-slide-up">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-xs font-bold uppercase tracking-widest text-white/40">Progression & Kurver</h3>
                <div class="flex gap-2">
                    <span class="flex items-center gap-1.5 text-[10px] text-white/30">
                        <span class="w-2 h-2 rounded-full bg-accent"></span> Est. 1RM
                    </span>
                </div>
            </div>
            <div class="min-h-[350px] w-full">
              <canvas id="progressionChart"></canvas>
            </div>
          </Card>

          <!-- Technical Instructions -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card variant="glass" class="p-6 reveal reveal-slide-up">
               <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-4">Set-up</h3>
               <ul class="space-y-3">
                 {techInfo.setup.map((s, i) => (
                   <li class="text-[13px] text-dim flex gap-3 leading-relaxed">
                     <span class="font-mono text-accent/50">{i+1}.</span>
                     <span>{s}</span>
                   </li>
                 ))}
               </ul>
            </Card>
            <Card variant="glass" class="p-6 reveal reveal-slide-up delay-100">
               <h3 class="text-xs font-bold uppercase tracking-widest text-accent mb-4">Udf√∏relse</h3>
               <ul class="space-y-3">
                 {techInfo.execution.map((e, i) => (
                   <li class="text-[13px] text-dim flex gap-3 leading-relaxed">
                     <span class="font-mono text-accent/50">{i+1}.</span>
                     <span>{e}</span>
                   </li>
                 ))}
               </ul>
            </Card>
          </div>

          <!-- Raw Data Table (Aggregated) -->
          <Card variant="glass" class="p-6 reveal reveal-slide-up delay-200">
             <h3 class="text-xs font-bold uppercase tracking-widest text-white/40 mb-6">Seneste Sessions</h3>
             <div class="overflow-x-auto">
               <table class="w-full text-left text-[12px] border-collapse">
                 <thead>
                    <tr class="border-b border-white/5 text-white/30 uppercase font-black tracking-wider">
                      <th class="py-3 px-2">Dato</th>
                      <th class="py-3 px-2">V√¶gt</th>
                      <th class="py-3 px-2">S√¶t x Reps</th>
                      <th class="py-3 px-2">Volumen</th>
                      <th class="py-3 px-2">RPE</th>
                    </tr>
                 </thead>
                 <tbody id="raw-data-table" class="divide-y divide-white/[0.02]">
                    <!-- Injected by JS -->
                 </tbody>
               </table>
             </div>
          </Card>
        </div>
      </div>

      <!-- Navigation Footer -->
      <div class="mt-16 flex flex-wrap justify-center gap-6 reveal reveal-fade">
         <Button href="/traeningsstatistik" variant="ghost">Global Statistik</Button>
         <Button href="/traeningsprogram" variant="ghost">Tr√¶ningsprogram</Button>
      </div>
    </Section>
  </main>

  <script>
    import Chart from 'chart.js/auto';

    async function initExerciseStats() {
      try {
        const res = await fetch('/api/training');
        const allLogs = await res.json();
        
        // Filter specifically for Incline Press entries
        const logs = allLogs.filter((l: any) => 
          l.exercise_name?.toLowerCase().includes('incline') && 
          l.exercise_name?.toLowerCase().includes('press')
        ).sort((a: any, b: any) => new Date(a.date).getTime() - new Date(b.date).getTime());

        if (logs.length === 0) return;

        // 1. Calculate Statistics
        const weights = logs.map((l: any) => l.weight_kg);
        const pbWeight = Math.max(...weights);
        document.getElementById('stat-pb-weight')!.innerText = `${pbWeight} kg`;

        const totalVol = logs.reduce((sum: number, l: any) => sum + (l.tonnage_kg || 0), 0);
        document.getElementById('stat-total-vol')!.innerText = `${(totalVol / 1000).toFixed(1)} tons`;

        const rpes = logs.map((l: any) => l.rpe).filter(Boolean);
        const avgRpe = rpes.length > 0 ? (rpes.reduce((a:number, b:number) => a+b, 0) / rpes.length).toFixed(1) : '--';
        document.getElementById('stat-avg-rpe')!.innerText = avgRpe;

        // Estimate 1RM (Brzycki: weight / (1.0278 - 0.0278 * reps))
        const e1rms = logs.map((l: any) => {
           const reps = l.reps || 8; // default if missing
           return Math.round(l.weight_kg / (1.0278 - 0.0278 * reps));
        });
        const currentE1RM = Math.max(...e1rms);
        document.getElementById('stat-e1rm')!.innerText = `${currentE1RM} kg`;

        // Strength Standards (Relative to 85kg BW for Incline Press)
        const bw = 85;
        const standards = [
            { label: 'Novice', ratio: 0.7 },
            { label: 'Intermediate', ratio: 1.0 },
            { label: 'Advanced', ratio: 1.3 },
            { label: 'Elite', ratio: 1.5 }
        ];

        let tier = standards[0];
        let nextTier = standards[1];
        
        for (let i = 0; i < standards.length; i++) {
            if (currentE1RM >= standards[i].ratio * bw) {
                tier = standards[i];
                nextTier = standards[i+1] || null;
            }
        }

        const badge = document.getElementById('strength-badge')!;
        badge.innerText = tier.label;
        if (tier.label === 'Elite') badge.classList.add('text-accent', 'border-accent/40', 'bg-accent/10');
        else if (tier.label === 'Advanced') badge.classList.add('text-blue-400', 'border-blue-400/40', 'bg-blue-400/10');
        else if (tier.label === 'Intermediate') badge.classList.add('text-green-400', 'border-green-400/40', 'bg-green-400/10');

        if (nextTier) {
            document.getElementById('strength-next')!.innerText = `N√¶ste m√•l: ${Math.ceil(nextTier.ratio * bw)} kg (${nextTier.label})`;
        } else {
            document.getElementById('strength-next')!.innerText = `Du er i toppen! üî•`;
        }

        // AI Progression Analysis
        const latestLog = logs[logs.length - 1];
        const aiContainer = document.getElementById('ai-suggestion')!;
        
        if (latestLog) {
            const rpe = latestLog.rpe || 8;
            const weight = latestLog.weight_kg;
            let suggestion = "";
            let reason = "";

            if (rpe <= 8) {
                suggestion = `${weight + 2.5} kg`;
                reason = `Sidst l√∏ftede du ${weight} kg med RPE ${rpe}. Det ser ud til, at der er overskud, s√• jeg foresl√•r en lille √∏gning p√• 2.5 kg.`;
            } else if (rpe === 9) {
                suggestion = `${weight} kg`;
                reason = `Du ramte en RPE 9 sidst. Hold v√¶gten her i n√¶ste pas, og fokus√©r p√• at g√∏re reps'ne endnu mere pr√¶cise eller snappe en ekstra rep.`;
            } else {
                suggestion = `${weight} kg`;
                reason = `RPE ${rpe} er meget h√∏j (t√¶t p√• failure). Hold v√¶gten eller overvej et lille deload, hvis formen lider under det.`;
            }

            aiContainer.innerHTML = `
                <div class="text-[10px] text-accent uppercase font-black mb-1">N√¶ste Pas Forslag:</div>
                <div class="text-2xl font-black text-white italic mb-2">${suggestion}</div>
                <p class="text-[11px] text-dim leading-relaxed font-medium">${reason}</p>
            `;

            // Recovery Status Calculation
            const lastDate = new Date(latestLog.date);
            const hoursSince = (new Date().getTime() - lastDate.getTime()) / (1000 * 60 * 60);
            const latestRpe = latestLog.rpe || 8;
            let targetRecovery = 24;
            if (latestRpe >= 9) targetRecovery = 72;
            else if (latestRpe >= 8) targetRecovery = 48;

            const recoveryPercent = Math.min(100, Math.round((hoursSince / targetRecovery) * 100));
            document.getElementById('stat-recovery-percent')!.innerText = `${recoveryPercent}%`;
            document.getElementById('stat-recovery-bar')!.style.width = `${recoveryPercent}%`;

            const msgEl = document.getElementById('stat-recovery-msg')!;
            if (recoveryPercent >= 100) {
                msgEl.innerText = "Du er 100% restitueret og klar til et tungt pas! üöÄ";
                document.getElementById('stat-recovery-bar')!.classList.replace('bg-accent', 'bg-green-400');
            } else {
                const hoursLeft = Math.ceil(targetRecovery - hoursSince);
                msgEl.innerText = `Du har brug for ca. ${hoursLeft} timer mere for fuld restitution efter dit sidste pas (RPE ${latestRpe}).`;
            }

            // Iron Ghost Logic
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() - 28);
            const ghostSession = logs.find((l: any) => new Date(l.date) <= targetDate);
            
            if (ghostSession) {
                document.getElementById('ghost-date')!.innerText = new Date(ghostSession.date).toLocaleDateString('da-DK', { day: 'numeric', month: 'short' });
                document.getElementById('ghost-stats')!.innerText = `${ghostSession.weight_kg} kg x ${ghostSession.reps}`;
                document.getElementById('ghost-tonnage')!.innerText = `${ghostSession.tonnage_kg} kg`;
                
                const diff = (latestLog.weight_kg * latestLog.reps) - (ghostSession.weight_kg * ghostSession.reps);
                if (diff > 0) {
                    document.getElementById('ghost-directive')!.innerText = `Du f√∏rer med ${diff} kg i volumen over din Ghost fra sidste m√•ned! Forts√¶t presset. üî•`;
                } else {
                    document.getElementById('ghost-directive')!.innerText = `Din Ghost l√∏ftede det samme som dig. Giv den gas i dag for at bryde overtaget! ü¶æ`;
                }
            } else {
                document.getElementById('ghost-container')!.innerHTML = `<p class="text-center py-4 text-dim text-xs italic">Ingen data for din Ghost endnu. F√∏lg programmet i 4 uger for at aktivere sammenligning!</p>`;
            }
        }

        // Rest Timer Logic
        let timerSeconds = 120;
        let timerInterval: any = null;
        const display = document.getElementById('timer-display')!;
        const startBtn = document.getElementById('timer-start')!;
        const resetBtn = document.getElementById('timer-reset')!;

        const updateDisplay = () => {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            display.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        startBtn.addEventListener('click', () => {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                startBtn.innerText = 'Start';
                startBtn.classList.replace('bg-red-500', 'bg-accent');
            } else {
                startBtn.innerText = 'Stop';
                startBtn.classList.replace('bg-accent', 'bg-red-500');
                timerInterval = setInterval(() => {
                    if (timerSeconds > 0) {
                        timerSeconds--;
                        updateDisplay();
                    } else {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        startBtn.innerText = 'F√¶rdig!';
                        display.classList.add('animate-bounce', 'text-accent');
                    }
                }, 1000);
            }
        });

        resetBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            timerInterval = null;
            timerSeconds = 120;
            updateDisplay();
            startBtn.innerText = 'Start';
            startBtn.classList.replace('bg-red-500', 'bg-accent');
            display.classList.remove('animate-bounce', 'text-accent');
        });

        // 2. Render Chart
        const ctx = document.getElementById('progressionChart') as HTMLCanvasElement;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: logs.map((l: any) => new Date(l.date).toLocaleDateString('da-DK', { day: 'numeric', month: 'short' })),
                datasets: [
                    {
                        label: 'Estimeret 1RM (kg)',
                        data: e1rms,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#FFD700',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Faktisk V√¶gt (kg)',
                        data: weights,
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { ticks: { color: 'rgba(255, 255, 255, 0.3)', font: { size: 10 } }, grid: { display: false } },
                    y: { ticks: { color: 'rgba(255, 255, 255, 0.5)', font: { size: 10 } }, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                }
            }
        });

        // 3. Render Table
        const tableBody = document.getElementById('raw-data-table');
        if (tableBody) {
          tableBody.innerHTML = logs.slice().reverse().slice(0, 10).map((l: any) => `
            <tr class="hover:bg-white/[0.02]">
              <td class="py-4 px-2 text-white/40">${new Date(l.date).toLocaleDateString('da-DK')}</td>
              <td class="py-4 px-2 font-bold">${l.weight_kg} kg</td>
              <td class="py-4 px-2 text-dim">${l.sets} x ${l.reps}</td>
              <td class="py-4 px-2 text-dim">${l.tonnage_kg} kg</td>
              <td class="py-4 px-2"><span class="text-accent/60">@</span> ${l.rpe || '--'}</td>
            </tr>
          `).join('');
        }

      } catch (e) {
        console.error("Failed to load incline press stats", e);
      }
    }

    initExerciseStats();
  </script>
</Layout>

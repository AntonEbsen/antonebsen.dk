---
import LanguageSwitcher from './common/LanguageSwitcher.astro';
import { getLangFromUrl, useTranslations, useNav } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const navItems = useNav(lang);
const pathname = new URL(Astro.request.url).pathname;
---

<nav class="navbar" aria-label="Primær navigation">
  <div class="nav-inner">
    <div class="nav-left">
      {navItems.map(item => (
          <a class={pathname === item.url || pathname.startsWith(item.url + '/') && item.url !== '/' && item.url !== '/en' ? "active" : ""} href={item.url}>{item.label}</a>
      ))}
    </div>

    <div class="nav-search" role="search">
      <label class="sr-only" for="siteSearch">Søg på siden</label>
      <input
        id="siteSearch"
        class="nav-search-input"
        type="search"
        placeholder="Søg..."
        autocomplete="off"
        aria-autocomplete="list"
        aria-controls="searchResults"
        aria-expanded="false"
      />
      <div id="searchResults" class="search-results" role="listbox" aria-label="Søgeresultater"></div>
    </div>
    
    <div class="nav-right">
      <LanguageSwitcher />
    </div>
  </div>
</nav>

<script>
  // Mobile dropdown logic
  document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll(".navbar .has-dropdown > .nav-link");
    links.forEach(link => {
      link.addEventListener("click", (e) => {
        if (window.matchMedia("(max-width: 980px)").matches) {
          e.preventDefault();
          link.parentElement.classList.toggle("open");
        }
      });
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".navbar .has-dropdown")) {
        document.querySelectorAll(".navbar .has-dropdown.open")
          .forEach(x => x.classList.remove("open"));
      }
    });
  });
</script>

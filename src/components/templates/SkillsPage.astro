---
import Layout from '@layouts/BaseLayout.astro';
import Section from '@components/ui/Section.astro';
import Card from '@components/ui/Card.astro';
import Button from '@components/ui/Button.astro';
import Pill from '@components/ui/Pill.astro';
import SectionHeading from '@components/ui/SectionHeading.astro';
import ContactCard from '@components/common/ContactCard.astro';
import SkillGroup from '@components/skills/SkillGroup.astro';
import MethodologyCard from '@components/skills/MethodologyCard.astro';
import SnippetModal from '@components/skills/SnippetModal.astro';
import SkillNetwork from '@components/skills/SkillNetwork.astro'; // Phase 4
import RadarChart from '@components/skills/RadarChart.astro';
import { getEntry } from 'astro:content';

interface Props {
  lang: 'da' | 'en' | 'de';
}

const { lang } = Astro.props;
const isDa = lang === 'da';

// 1. Fetch Page Content (Translations)
const t = {
  da: {
    title: "Anton Meier Ebsen Jørgensen – Kompetencer",
    desc: "Kompetencer: værktøjer, metoder og arbejdsområder inden for makroøkonomi, økonometri, data og undervisning.",
    heroTitle: "Værktøjer, metoder og det jeg leverer",
    heroText: "Kompetencer i et format der er let at bruge: <strong>hvad</strong> jeg kan, <strong>hvordan</strong> jeg arbejder, og <strong>hvilket output</strong> man kan forvente.",
    btns: { core: "Værktøjskasse", methods: "Metoder", contact: "Kontakt" },
    toolsTitle: "Min Værktøjskasse",
    stackTitle: "Teknologisk Stack",
    methodsTitle: "Faglige Metoder",
    learningTitle: "Hvad jeg lærer lige nu",
    ctaTitle: "Har du et konkret behov?",
    ctaText: "Skriv format + mål. Så foreslår jeg en struktur.",
    chart: { macro: "Makro", metrics: "Økonometri", data: "Data", teach: "Formidling" }
  },
  en: {
    title: "Anton Meier Ebsen Jørgensen – Competencies",
    desc: "Competencies: tools, methods, and focus areas in macroeconomics, econometrics, data, and teaching.",
    heroTitle: "Tools, Methods, and Deliverables",
    heroText: "Competencies in a format that's easy to use: <strong>what</strong> I can do, <strong>how</strong> I work, and <strong>what output</strong> you can expect.",
     btns: { core: "Toolkit", methods: "Methods", contact: "Contact" },
    toolsTitle: "My Toolkit",
    stackTitle: "Tech Stack",
    methodsTitle: "Professional Methods",
    learningTitle: "Currently Learning",
    ctaTitle: "Have a specific need?",
    ctaText: "Let me know the format and goal. I'll suggest a structure.",
    chart: { macro: "Macro", metrics: "Metrics", data: "Data", teach: "Teaching" }
  },
  de: {
    title: "Anton Meier Ebsen Jørgensen – Kompetenzen",
    desc: "Kompetenzen: Werkzeuge, Methoden und Fokusbereiche.",
    heroTitle: "Werkzeuge, Methoden und Ergebnisse",
    heroText: "Kompetenzen in einem einfach zu nutzenden Format.",
     btns: { core: "Werkzeugkasten", methods: "Methoden", contact: "Kontakt" },
    toolsTitle: "Mein Werkzeugkasten",
    stackTitle: "Technologie-Stack",
    methodsTitle: "Fachliche Methoden",
    learningTitle: "Aktuell am lernen",
    ctaTitle: "Haben Sie einen konkreten Bedarf?",
    ctaText: "Teilen Sie mir Format und Ziel mit.",
    chart: { macro: "Makro", metrics: "Metrik", data: "Daten", teach: "Lehre" }
  }
};

const content = lang === 'da' ? t.da : (lang === 'en' ? t.en : t.de);

// 2. Fetch Skills Data (Local JSON)
const skillsEntry = await getEntry('skills', lang); 
const skillsData = skillsEntry?.data || { professional: [], programming: [], learning: [] };

// 3. Fetch CV Data for "Verified Skills" & "Project Synergy"
const cvEntry = await getEntry('cv', lang);
const cv = cvEntry?.data;

// Helper: Verifying Courses
const getVerifyingCourses = (skillName: string) => {
    if (!cv?.courses) return [];
    return cv.courses
        .filter(c => c.verifiedSkills && c.verifiedSkills.includes(skillName))
        .map(c => ({
            title: c.title,
            href: isDa ? '/courses' : `/${lang}/courses`, 
            grade: c.grade
        }));
};

// Helper: Applying Projects (Project Synergy)
const getApplyingProjects = (skillName: string) => {
    if (!cv?.projects) return [];
    return cv.projects
        .filter(p => p.technologies && p.technologies.includes(skillName))
        .map(p => ({
            title: p.title,
            href: isDa ? '/education#projects' : `/${lang}/education#projects` 
        }));
};

// Helper: Applying Experience (Professional Proof)
const getApplyingExperience = (skillName: string) => {
    if (!cv?.experience) return [];
    return cv.experience
        .filter(e => e.technologies && e.technologies.includes(skillName))
        .map(e => ({
            title: e.organization, // Show Organization name as the proof
            role: e.title,
            href: isDa ? '/experience' : `/${lang}/experience` 
        }));
};

// 4. Transform Data
// Add "verifiedIn", "appliedIn" (Projects) & "appliedWork" (Experience)
const enrichedProgramming = skillsData.programming.map(skill => ({
    ...skill,
    verifiedIn: getVerifyingCourses(skill.name),
    appliedIn: getApplyingProjects(skill.name),
    appliedWork: getApplyingExperience(skill.name)
}));

const expertTools = enrichedProgramming.filter(s => s.level === 'expert');
const stackTools = enrichedProgramming.filter(s => s.level === 'stack');
const professionalSkills = skillsData.professional;
const learningSkills = skillsData.learning || [];

// 5. Radar Chart Data (Start with fixed high-competence profile)
const chartData = [
    { label: content.chart.macro, value: 90, key: 'macro' },
    { label: content.chart.metrics, value: 85, key: 'metrics' },
    { label: content.chart.teach, value: 80, key: 'teach' }, // 'teach' mapping might need adjustment if no skills have it
    { label: content.chart.data, value: 95, key: 'data' },
];

---

<Layout 
  title={content.title}
  description={content.desc}
  bodyClass="skills-page"
>
  <style>
     /* ... existing styles ... */
    .skills-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 22px;
      align-items: center;
    }

    .grid-methods {
       display: grid;
       grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
       gap: 14px; 
    }
    
    /* Filtering Animation */
    .skill-card {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 1;
        transform: scale(1);
    }
    .skill-card.filtered-out {
        opacity: 0.1;
        filter: grayscale(100%);
        transform: scale(0.95);
    }
    .skill-card.highlight {
        box-shadow: 0 0 15px rgba(234, 179, 8, 0.15);
        border-color: rgba(234, 179, 8, 0.4);
    }

    @media (max-width: 980px) {
      .hero-grid { grid-template-columns: 1fr; }
    }
  </style>

  <main class="skills-wrap">
     {/* ... Hero Section remains same ... */}

    <!-- HERO -->
    <Section>
      <div class="hero-grid">
        <Card variant="glass" class="p-8 h-full flex flex-col justify-center">
            {/* ... Content ... */}
          <p class="text-xs font-extrabold uppercase tracking-wider text-dim mb-3">{isDa ? 'Kompetencer' : 'Competencies'}</p>
          <h1 class="text-4xl leading-tight mb-4 font-bold">{content.heroTitle}</h1>
          <p class="text-lg leading-relaxed text-dim mb-6" set:html={content.heroText}></p>
  
          <div class="flex flex-wrap gap-3">
            <Button href="#toolkit"><i class="fa-solid fa-toolbox mr-2"></i> {content.btns.core}</Button>
            <Button href="#methods" variant="ghost"><i class="fa-solid fa-layer-group mr-2"></i> {content.btns.methods}</Button>
            <Button href="#contact" variant="ghost"><i class="fa-solid fa-paper-plane mr-2"></i> {content.btns.contact}</Button>
          </div>
        </Card>
  
        <!-- Radar Chart & Learning -->
        <div class="flex flex-col gap-4">
             {/* The Balance Chart */}
             <Card variant="glass" class="p-6 flex flex-col items-center justify-center relative overflow-hidden min-h-[350px]">
                <div class="absolute top-4 left-4 flex justify-between w-full pr-8 items-center">
                    <h3 class="font-bold text-sm text-dim uppercase tracking-wider">The Balance</h3>
                    <button id="reset-filter" class="text-[10px] text-accent uppercase font-bold hover:text-white transition-colors opacity-0 pointer-events-none">Reset Filter âœ•</button>
                </div>
                <RadarChart data={chartData} size={280} />
             </Card>

             {/* Phase 4: The Network */}
             <SkillNetwork skills={expertTools} />

             {/* The Horizon (Learning) */}
             {learningSkills.length > 0 && (
                <Card variant="glass" class="p-4 flex flex-col sm:flex-row items-center gap-4">
                    <div class="shrink-0 flex items-center gap-2 text-dim text-sm font-bold uppercase tracking-wider">
                        <i class="fa-solid fa-telescope text-accent"></i>
                        {content.learningTitle}
                    </div>
                    <div class="h-4 w-[1px] bg-white/10 hidden sm:block"></div>
                    <div class="flex flex-wrap gap-2 justify-center sm:justify-start">
                        {learningSkills.map(skill => (
                            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
                                {skill.icon && <i class={`${skill.icon} text-accent text-xs`}></i>}
                                <span class="text-xs font-bold">{skill.name}</span>
                            </div>
                        ))}
                    </div>
                </Card>
             )}
        </div>
      </div>
    </Section>

    <!-- TOOLKIT (Daily Drivers) -->
    <Section id="toolkit">
       <div id="skills-container">
           <SkillGroup 
              title={content.toolsTitle}
              skills={expertTools}
              variant="default"
           />
       </div>
    </Section>

    <!-- STACK (Secondary Tools) -->
    <Section id="stack">
        <div id="stack-container">
            <SkillGroup 
               title={content.stackTitle}
               skills={stackTools}
               variant="stack"
            />
        </div>
     </Section>

    <!-- METHODS (Professional) -->
    <Section id="methods">
      <Card variant="default" class="p-6">
        <SectionHeading>{content.methodsTitle}</SectionHeading>
        <div class="grid-methods">
            {professionalSkills.map(s => (
                <MethodologyCard 
                    icon={s.icon}
                    title={s.name}
                    subtitle={s.title} 
                />
            ))}
        </div>
      </Card>
    </Section>

    <!-- CTA -->
    <Section id="contact">
      <ContactCard 
        variant="glass" 
        title={content.ctaTitle}
        text={content.ctaText}
        action="contact"
      />
    </Section>

  </main>

  <SnippetModal />

<script>
    // Filter Logic
    window.addEventListener('radar-filter', (e) => {
        const category = e.detail;
        const resetBtn = document.getElementById('reset-filter');
        
        if (!category) return;
        
        // Show reset button
        if(resetBtn) {
            resetBtn.style.opacity = '1';
            resetBtn.style.pointerEvents = 'auto';
        }

        // Filter Cards
        const cards = document.querySelectorAll('.skill-card');
        cards.forEach((card: any) => {
             const cardCat = card.dataset.category;
             if (cardCat === category || category === 'all') {
                 card.classList.remove('filtered-out');
                 card.classList.add('highlight');
             } else {
                 card.classList.add('filtered-out');
                 card.classList.remove('highlight');
             }
        });
    });

    // Reset Logic
    document.getElementById('reset-filter')?.addEventListener('click', () => {
         const cards = document.querySelectorAll('.skill-card');
         cards.forEach((card: any) => {
             card.classList.remove('filtered-out', 'highlight');
         });
         const resetBtn = document.getElementById('reset-filter');
         if(resetBtn) {
            resetBtn.style.opacity = '0';
            resetBtn.style.pointerEvents = 'none';
        }
    });
</script>
</Layout>



